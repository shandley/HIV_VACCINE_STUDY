---
title: "2025_04_09_HIV_vaccine_re_resubmission"
author: "KM"
date: "2025-04-09"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Project Description:**
Analysis of the bacterial microbiome of patients enrolled in Dan Barouch's HIV vaccine study. Two cohorts are analyzed, one from the US and one from Africa. Analysis is of 16S rRNA sequences obtained from patient stool samples.

**Collaborators:**
Dan Barouch: dbarouch@bidmc.harvard.edu
Megan Baldridge: mbaldridge@wustl.edu
Scott Handley: shandley@wustl.edu
Yuhao Li: yuhaoli@wustl.edu

**Other relevant documents:**
The following Phyloseq objects are available. Each is distinguished based on the 16S reference database used for taxonomic classification. RDP and Silva were processed through the species assignment workflow available through dada2 (https://benjjneb.github.io/dada2/assign.html:

  * ps0.HIV_vaccine.gg.RDS (GreenGenes)
  * ps0.HIV_vaccine.rdp.RDS (RDP)
  * ps0.HIV_vaccine.silva.RDS (Silva)
  
   * mapping file: hiv_vaccine_microbiome_response_calls.txt

**Technical References:**
  * http://f1000research.com/articles/5-1492/v1

  * http://benjjneb.github.io/dada2/tutorial.htm

**Workflow details:** The R commands below represent a full analysis of the following:

*** UPDATE THIS PRIOR TO PUBLICATION TO REFLECT FINAL WORKFLOW ***
1) Sample quality control
2) ASV properties
3) Community Composition
4) Alpha diversity
5) Beta diversity
6) Differential abundance testing

# initiate environment
```{r initiate-environment}
# Global knitr option
knitr::opts_chunk$set(fig.width=8,
                      fig.height=6,
                      fig.path="./figures/",
                      dev='png',
                      warning=FALSE,
                      message=FALSE)

# Install packages as needed
# install.packages(
#   "microViz",repos = c(davidbarnett = "https://david-barnett.r-universe.dev", getOption("repos"))
# )
#BiocManager::install("Maaslin2")
#BiocManager::install("MicrobiotaProcess")
# if (!requireNamespace("microbiomeMarker", quietly = TRUE))
#     BiocManager::install("microbiomeMarker")

# Base and data manipulation packages
  library("data.table"); packageVersion("data.table")
  library("tidyverse"); packageVersion("tidyverse")  # This loads ggplot2, dplyr, tidyr, readr, etc.
  library("forcats"); packageVersion("forcats")      # If additional functionality needed beyond tidyverse
  library("readr"); packageVersion("readr")          # If additional functionality needed beyond tidyverse
  library("stringr"); packageVersion("stringr")  

  # Tree-related packages
  library("tidytree"); packageVersion("tidytree")    # Load before ggtree
  library("ggtree"); packageVersion("ggtree")
  library("ggtreeExtra"); packageVersion("ggtreeExtra")

  # Microbiome analysis core packages
  library("phyloseq"); packageVersion("phyloseq")
  library("microbiome"); packageVersion("microbiome")
  library("vegan"); packageVersion("vegan")
  library("Maaslin2"); packageVersion("Maaslin2")
  library("MicrobiotaProcess"); packageVersion("MicrobiotaProcess")
  library("microViz"); packageVersion("microViz")
  library("microbiomeMarker"); packageVersion("microbiomeMarker")
  library("rstatix"); packageVersion("rstatix")

  # Visualization extension packages
  library("ggplot2"); packageVersion("ggplot2")      # Explicit version check
  library("dplyr"); packageVersion("dplyr")          # Explicit version check
  library("RColorBrewer"); packageVersion("RColorBrewer")
  library("ComplexHeatmap"); packageVersion("ComplexHeatmap")
  library("extrafont"); packageVersion("extrafont")

  # ggplot2 extensions
  library("ggpubr"); packageVersion("ggpubr")
  library("ggrepel"); packageVersion("ggrepel")
  library("ggh4x"); packageVersion("ggh4x")
  library("ggalluvial"); packageVersion("ggalluvial")
  library("ggVennDiagram"); packageVersion("ggVennDiagram")
  library("ggupset"); packageVersion("ggupset")
  library("ggpp"); packageVersion("ggpp")
  library("gghalves"); packageVersion("gghalves")
  library("ggstar"); packageVersion("ggstar")
  library("ggsci"); packageVersion("ggsci")

  # Multi-plot arrangement packages
  library("patchwork"); packageVersion("patchwork")
  library("cowplot"); packageVersion("cowplot")      # Load last to avoid conflicts


# Set global theming ggplot settings
theme_set(theme_bw(base_size = 12))
# font_import(pattern = "Arial", prompt = FALSE)

# Set a random seed so that exact results can be reproduced
set.seed(1000)

```

# Read in data
```{r initiate-data}
# Load Phyloseq Object generated in *_preprocessing.Rmd documents
ps0 <- readRDS("./data/ps0.HIV_vaccine.rdp.RDS")
ps0

# Load mapping file
map <- import_qiime_sample_data("./data/hiv_vaccine_microbiome_response_calls.txt")

# Merge updated mapping files
ps0 <- merge_phyloseq(ps0, map)
ps0

# Get the column names to convert to factors
  factor_cols <- c("sub_region", "esa_cla_call", "esa_coc_call", "esa_clc_call",
                   "esa_clb_call", "esa_mos1_call", "adcp_cla_call", "adcp_clb_call",
                   "adcp_coc_call", "adcp_clc_call", "adcp_mos1_call", "pot_em1_call",
                   "pot_em2_call", "pot_e1p_call", "pot_e2p_call", "pot_e3p_call",
                   "pot_gp_call", "pot_gm1_call", "pot_gm2_call", "pot_pp_call",
                   "pot_pm1_call", "pot_pm2_call", "region", "sub_region",
                   "visit_description_provided", "group")

  # Convert all specified columns to factors
  sample_data(ps0) <- sample_data(ps0) %>%
    data.frame() %>%
    mutate(across(all_of(factor_cols), as.factor)) %>%
    sample_data()


#Rename vaccination group
ps0 <- ps0 %>% ps_mutate(
               vaccination_regimens_categories = if_else(group == "GROUP 1" | group == "GROUP 4", "2X HD", ifelse(group == "GROUP 2" | group == "GROUP 3" | group == "GROUP 5" | group == "GROUP 6", "2X LD", ifelse(group == "GROUP 7", "1X HD", "Placebo")))) 

# View sample variables & generate basic stats
sample_variables(ps0)
sd(sample_sums(ps0))
get_taxa_unique(ps0, "Phylum")
ntaxa(ps0)

# Remove sample with ND
ps0 <- subset_samples(ps0, region !="ND")
levels(sample_data(ps0)$region)

## subset samples according to Time
# V2 STOOL COLLECTION fecal samples
physeqMerged_Day_V2 <-subset_samples(ps0, visit_description == "V2 STOOL COLLECTION")
physeqMerged_Day_V2
 
# V9 STOOL COLLECTION fecal samples
physeqMerged_Day_V9 <-subset_samples(ps0, visit_description == "V9 STOOL COLLECTION")
physeqMerged_Day_V9

# Mactched fecal samples in V2 and V9
physeqMerged_M<-subset_samples(ps0, patient_complete == "1")
physeqMerged_M<-subset_samples(physeqMerged_M, group != "GROUP 8")
physeqMerged_M

```

## Removing sequences
```{r prevalence-assessment}

# Begin by removing sequences that were classified as either mitochondria or chlorplast
ps0 # Check the number of taxa prior to removal
ps1 <- ps0 %>%
  subset_taxa(
    Family  != "mitochondria" &
    Class   != "Chloroplast" &
    Phylum != "Cyanobacteria/Chloroplast"
  )
ps1 # Confirm that the taxa were removed

# Update phyla taxa
  # Create a named vector for the replacements
  phylum_replacements <- c(
    "Actinobacteria" = "Actinomycetota",
    "Bacteroidetes" = "Bacteroidota",
    "Euryarchaeota" = "Methanobacteriota",
    "Elusimicrobia" = "Elusimicrobiota",
    "Firmicutes" = "Bacillota",
    "Fibrobacteres" = "Fibrobacterota",
    "Fusobacteria" = "Fusobacteriota",
    "Lentisphaerae" = "Lentisphaerota",
    "Proteobacteria" = "Pseudomonadota",
    "Spirochaetes" = "Spirochaetota",
    "Synergistetes" = "Synergistota",
    "Tenericutes" = "Mycoplasmatota",
    "Verrucomicrobia" = "Verrucomicrobiota"
  )
 
    # Get the current tax table
  tax_table_df <- as.data.frame(phyloseq::tax_table(ps1))

  # Replace the Phylum names
  tax_table_df$Phylum <- plyr::mapvalues(
    tax_table_df$Phylum,
    from = names(phylum_replacements),
    to = phylum_replacements,
    warn_missing = FALSE
  )

  # Update the tax table in the phyloseq object
  tax_table(ps1) <- as.matrix(tax_table_df)

  # Verify the changes
  get_taxa_unique(ps1, "Phylum")
  

physeqMerged_Day_V9 # Check the number of taxa prior to removal
ps1_V9 <- physeqMerged_Day_V9 %>%
  subset_taxa(
    Family  != "mitochondria" &
    Class   != "Chloroplast" &
    Phylum != "Cyanobacteria/Chloroplast"
  )
ps1_V9  # Confirm that the taxa were removed

# Update phyla taxa 
  # Get the current tax table
  tax_table_df <- as.data.frame(phyloseq::tax_table(ps1_V9))

  # Replace the Phylum names
  tax_table_df$Phylum <- plyr::mapvalues(
    tax_table_df$Phylum,
    from = names(phylum_replacements),
    to = phylum_replacements,
    warn_missing = FALSE
  )

  # Update the tax table in the phyloseq object
  tax_table(ps1_V9) <- as.matrix(tax_table_df)

  # Verify the changes
  get_taxa_unique(ps1_V9, "Phylum")

# Create input for DESeq tables 
ps1_V9_RWUG_all <- subset_samples(ps1_V9, region == "AFRICA")
ps1_V9_RWUS_all <- subset_samples(ps1_V9, sub_region != "UG")
ps1_V9_USUG_all <- subset_samples(ps1_V9, sub_region != "RW") 

# Early time point
physeqMerged_Day_V2 # Check the number of taxa prior to removal
ps1_V2 <- physeqMerged_Day_V2 %>%
  subset_taxa(
    Family  != "mitochondria" &
    Class   != "Chloroplast" &
    Phylum != "Cyanobacteria/Chloroplast"
  )
ps1_V2  # Confirm that the taxa were removed

# Update phyla taxa 
  # Get the current tax table
  tax_table_df <- as.data.frame(phyloseq::tax_table(ps1_V2))

  # Replace the Phylum names
  tax_table_df$Phylum <- plyr::mapvalues(
    tax_table_df$Phylum,
    from = names(phylum_replacements),
    to = phylum_replacements,
    warn_missing = FALSE
  )

  # Update the tax table in the phyloseq object
  tax_table(ps1_V2) <- as.matrix(tax_table_df)

  # Verify the changes
  get_taxa_unique(ps1_V2, "Phylum")

# Create input for DESeq tables 
ps1_V2_RWUG_all <- subset_samples(ps1_V2, region == "AFRICA")
ps1_V2_RWUS_all <- subset_samples(ps1_V2, sub_region != "UG")
ps1_V2_USUG_all <- subset_samples(ps1_V2, sub_region != "RW") 

# Mactched fecal samples in V2 and V9
physeqMerged_M # Check the number of taxa prior to removal
ps1_M <- physeqMerged_M %>%
  subset_taxa(
    Family  != "mitochondria" &
    Class   != "Chloroplast" &
    Phylum != "Cyanobacteria/Chloroplast"
  )
ps1_M  # Confirm that the taxa were removed

# Update phyla taxa 
  # Get the current tax table
  tax_table_df <- as.data.frame(phyloseq::tax_table(ps1_M))

  # Replace the Phylum names
  tax_table_df$Phylum <- plyr::mapvalues(
    tax_table_df$Phylum,
    from = names(phylum_replacements),
    to = phylum_replacements,
    warn_missing = FALSE
  )

  # Update the tax table in the phyloseq object
  tax_table(ps1_M) <- as.matrix(tax_table_df)

  # Verify the changes
  get_taxa_unique(ps1_M, "Phylum")

# Create input for DESeq tables 
ps1_M_RWUG_all <- subset_samples(ps1_M, region == "AFRICA")
ps1_M_RWUS_all <- subset_samples(ps1_M, sub_region != "UG")
ps1_M_USUG_all <- subset_samples(ps1_M, sub_region != "RW") 

# 3% prevalence 
# Calculate how many samples are 3% of your total ps1_V9_RWUG_all
  sample_count <- nsamples(ps1_V9)
  min_samples <- ceiling(0.03 * sample_count)

  # Filter to keep only taxa present in at least 3% of samples
  ps1_V9_prev<- filter_taxa(ps1_V9,
                                     function(x) sum(x > 0) >= min_samples,
                                     prune=TRUE)

  # Check how many taxa were kept
  cat("Original number of taxa:", ntaxa(ps1_V9), "\n")
  cat("Filtered number of taxa:", ntaxa(ps1_V9_prev), "\n")
# Original number of taxa: 3671 
# Filtered number of taxa: 1028

  # Calculate how many samples are 3% of your total ps1_V9_RWUG_all
  sample_count <- nsamples(ps1_V2)
  min_samples <- ceiling(0.03 * sample_count)

  # Filter to keep only taxa present in at least 3% of samples
  ps1_V2_prev<- filter_taxa(ps1_V2,
                                     function(x) sum(x > 0) >= min_samples,
                                     prune=TRUE)

  # Check how many taxa were kept
  cat("Original number of taxa:", ntaxa(ps1_V2), "\n")
  cat("Filtered number of taxa:", ntaxa(ps1_V2_prev), "\n")
# Original number of taxa: 3671 
# Filtered number of taxa: 931


# 3% prevalence 
# Calculate how many samples are 3% of your total ps1_V9_RWUG_all
  sample_count <- nsamples(ps1_V9_RWUG_all)
  min_samples <- ceiling(0.03 * sample_count)

  # Filter to keep only taxa present in at least 3% of samples
  ps1_V9_RWUG<- filter_taxa(ps1_V9_RWUG_all,
                                     function(x) sum(x > 0) >= min_samples,
                                     prune=TRUE)

  # Check how many taxa were kept
  cat("Original number of taxa:", ntaxa(ps1_V9_RWUG_all), "\n")
  cat("Filtered number of taxa:", ntaxa(ps1_V9_RWUG), "\n")
# Original number of taxa: 3671 
# Filtered number of taxa: 981

  # Calculate how many samples are 3% of your total ps1_V9_RWUS_all
  sample_count <- nsamples(ps1_V9_RWUS_all)
  min_samples <- ceiling(0.03 * sample_count)

  # Filter to keep only taxa present in at least 3% of samples
  ps1_V9_RWUS<- filter_taxa(ps1_V9_RWUS_all,
                                     function(x) sum(x > 0) >= min_samples,
                                     prune=TRUE)

  # Check how many taxa were kept
  cat("Original number of taxa:", ntaxa(ps1_V9_RWUS_all), "\n")
  cat("Filtered number of taxa:", ntaxa(ps1_V9_RWUS), "\n")
# Original number of taxa: 3671 
# Filtered number of taxa: 1119
  
  # Calculate how many samples are 3% of your total ps1_V9_USUG_all
  sample_count <- nsamples(ps1_V9_USUG_all)
  min_samples <- ceiling(0.03 * sample_count)

  # Filter to keep only taxa present in at least 3% of samples
  ps1_V9_USUG<- filter_taxa(ps1_V9_USUG_all,
                                     function(x) sum(x > 0) >= min_samples,
                                     prune=TRUE)

  # Check how many taxa were kept
  cat("Original number of taxa:", ntaxa(ps1_V9_USUG_all), "\n")
  cat("Filtered number of taxa:", ntaxa(ps1_V9_USUG), "\n")
# Original number of taxa: 3671 
# Filtered number of taxa: 1035
  
# 3% prevalence: early time point
# Calculate how many samples are 3% of your total ps1_V2_RWUG_all
  sample_count <- nsamples(ps1_V2_RWUG_all)
  min_samples <- ceiling(0.03 * sample_count)

  # Filter to keep only taxa present in at least 3% of samples
  ps1_V2_RWUG<- filter_taxa(ps1_V2_RWUG_all,
                                     function(x) sum(x > 0) >= min_samples,
                                     prune=TRUE)

  # Check how many taxa were kept
  cat("Original number of taxa:", ntaxa(ps1_V2_RWUG_all), "\n")
  cat("Filtered number of taxa:", ntaxa(ps1_V2_RWUG), "\n")
# Original number of taxa: 3671 
# Filtered number of taxa: 1119

  # Calculate how many samples are 3% of your total ps1_V2_RWUS_all
  sample_count <- nsamples(ps1_V2_RWUS_all)
  min_samples <- ceiling(0.03 * sample_count)

  # Filter to keep only taxa present in at least 3% of samples
  ps1_V2_RWUS<- filter_taxa(ps1_V2_RWUS_all,
                                     function(x) sum(x > 0) >= min_samples,
                                     prune=TRUE)

  # Check how many taxa were kept
  cat("Original number of taxa:", ntaxa(ps1_V2_RWUS_all), "\n")
  cat("Filtered number of taxa:", ntaxa(ps1_V2_RWUS), "\n")
# Original number of taxa: 3671 
# Filtered number of taxa: 611
  
  # Calculate how many samples are 3% of your total ps1_V2_USUG_all
  sample_count <- nsamples(ps1_V2_USUG_all)
  min_samples <- ceiling(0.03 * sample_count)

  # Filter to keep only taxa present in at least 3% of samples
  ps1_V2_USUG<- filter_taxa(ps1_V2_USUG_all,
                                     function(x) sum(x > 0) >= min_samples,
                                     prune=TRUE)

  # Check how many taxa were kept
  cat("Original number of taxa:", ntaxa(ps1_V2_USUG_all), "\n")
  cat("Filtered number of taxa:", ntaxa(ps1_V2_USUG), "\n")
# Original number of taxa: 3671 
# Filtered number of taxa: 931

  # 3% prevalence 
# Calculate how many samples are 3% of your total ps1_M_RWUG_all
  sample_count <- nsamples(ps1_M_RWUG_all)
  min_samples <- ceiling(0.03 * sample_count)

  # Filter to keep only taxa present in at least 3% of samples
  ps1_M_RWUG<- filter_taxa(ps1_M_RWUG_all,
                                     function(x) sum(x > 0) >= min_samples,
                                     prune=TRUE)

  # Check how many taxa were kept
  cat("Original number of taxa:", ntaxa(ps1_M_RWUG_all), "\n")
  cat("Filtered number of taxa:", ntaxa(ps1_M_RWUG), "\n")
# Original number of taxa: 3671 
# Filtered number of taxa: 1363

  # Calculate how many samples are 3% of your total ps1_M_RWUS_all
  sample_count <- nsamples(ps1_M_RWUS_all)
  min_samples <- ceiling(0.03 * sample_count)

  # Filter to keep only taxa present in at least 3% of samples
  ps1_M_RWUS<- filter_taxa(ps1_M_RWUS_all,
                                     function(x) sum(x > 0) >= min_samples,
                                     prune=TRUE)

  # Check how many taxa were kept
  cat("Original number of taxa:", ntaxa(ps1_M_RWUS_all), "\n")
  cat("Filtered number of taxa:", ntaxa(ps1_M_RWUS), "\n")
# Original number of taxa: 3671 
# Filtered number of taxa: 914
  
  # Calculate how many samples are 3% of your total ps1_M_USUG_all
  sample_count <- nsamples(ps1_M_USUG_all)
  min_samples <- ceiling(0.03 * sample_count)

  # Filter to keep only taxa present in at least 3% of samples
  ps1_M_USUG<- filter_taxa(ps1_M_USUG_all,
                                     function(x) sum(x > 0) >= min_samples,
                                     prune=TRUE)

  # Check how many taxa were kept
  cat("Original number of taxa:", ntaxa(ps1_M_USUG_all), "\n")
  cat("Filtered number of taxa:", ntaxa(ps1_M_USUG), "\n")
# Original number of taxa: 3671 
# Filtered number of taxa: 922

```

# Standardize ASV names
```{r Standardize-ASV-names}
# Step 1: Create a master ASV mapping table from your original phyloseq object
  # Extract all ASVs from the original object
  all_asvs <- taxa_names(ps1_V9)

  # Create a permanent mapping dataframe
  asv_mapping <- data.frame(
    ASV = all_asvs,
    OTU_ID = paste0("ASV_", 1:length(all_asvs))
  )

  # Save this mapping for future reference if needed
  write.csv(asv_mapping, "./table/ASV_to_OTU_mapping.csv", row.names = FALSE)
  

```

# Read in phage data
```{r Read in phage data}
source("./data/shared_R_scripts/Helper_Functions.R")
physeqPhage <- readRDS("./data/RData_Objects/physeqPhage.RDS")
physeqPhage # 685 x 147

# Add variables to sample data
sampleData <- as(sample_data(physeqPhage), "data.frame")

"patient_complete" %in% colnames(sampleData) # FALSE
"sub_region" %in% colnames(sampleData) # FALSE

# The patient_complete column is missing, pull in from the 16S metadata file
#   "hiv_vaccine_microbiome_response_calls.txt
bacterialMetadata <- read.delim("./data/hiv_vaccine_microbiome_response_calls.txt",
                                check.names = FALSE, sep = "\t",
                                stringsAsFactors = FALSE)

subRegionLUT <- bacterialMetadata %>% 
  select(SampleID, sub_region) %>% 
  deframe()

sampleData$SampleID <- as.character(sampleData$SampleID)

sampleDataModified <- sampleData %>% 
  mutate(sub_region = subRegionLUT[SampleID])

# Add back to the phyloseq object
sample_data(physeqPhage) <- sample_data(sampleDataModified)

# Remove samples with ND for region or are in group 8
physeqFilteredSamples <- physeqPhage %>% 
  subset_samples(region != "ND" & group != "GROUP 8") %>% 
  prune_taxa(taxa_sums(.) > 0, .)
physeqFilteredSamples # 682 x 132

# Add a patient_complete column, which I believe should be a 1 if the patient
#   appears in the data set more than once (is paired).  Going to use the
#   patient_id column to determine which samples are duplicated.
sampleDataFilteredSamples <- as(sample_data(physeqFilteredSamples), "data.frame")
duplicatedPatientIDs <- sampleDataFilteredSamples$patient_id[duplicated(sampleDataFilteredSamples$patient_id)] # 34

sampleDataFilteredSamples <- sampleDataFilteredSamples %>% 
  mutate(patient_complete_virome = ifelse(patient_id %in% duplicatedPatientIDs, yes = 1, no = 0))

sample_data(physeqFilteredSamples) <- sample_data(sampleDataFilteredSamples)
physeqCompleteSamples <- physeqFilteredSamples %>% 
  subset_samples(patient_complete_virome == 1) %>% 
  prune_taxa(taxa_sums(.) > 0, .)
physeqCompleteSamples # 561 x 68
# physeqCompleteSamples_US <- physeqCompleteSamples %>% subset_samples(sub_region == "US")
# physeqCompleteSamples_US # 561 x 48
# physeqCompleteSamples_UG <- physeqCompleteSamples %>% subset_samples(sub_region == "UG")
# physeqCompleteSamples_UG # 561 x 20
```

# Add colors
```{r add-colors}
Phylumcolor<-c("Fusobacteriota"="#4575B4",
               "Actinomycetota"= "#74ADD1",
               "Pseudomonadota"="#ABD9E9", 
               "Elusimicrobiota" = "#E0F3F8",
               "Verrucomicrobiota"="#FFFFBF",
               "Spirochaetota"="#FEE090", 
               "Bacteroidota"= "#F46D43",
               "Bacillota"= "#D73027")


regioncolor <- c("UG" ="#00468BFF", "RW" = "#42B540FF", "US" = "#ED0000FF")

```

# Figure 1. Immune responses to Ad26-based HIV-1 vaccination regimens vary between geographic regions
#  Fig 1 A: Heatmap of immune responses 
```{r Fig 1A}
# Import data - use your existing data import code
map <- import_qiime_sample_data("./data/hiv_vaccine_microbiome_response_calls_heatmap.txt")

# Include all regions including Uganda (UG) that was excluded in the original
df_v9 <- map %>% subset_samples(Heatmap == "1") %>% 
                 subset_samples(group != "ND")  # Remove ND but keep UG

df_v9 <- as_tibble(sample_data(df_v9))

df_v9 <- df_v9 %>% mutate(vaccination_regimens_categories = if_else(group == "GROUP 1" | group == "GROUP 4", "2X HD", 
                           ifelse(group == "GROUP 2" | group == "GROUP 3" | group == "GROUP 5" | group == "GROUP 6", "2X LD", 
                           ifelse(group == "GROUP 7", "1X HD", "Placebo"))))

df_v9 <- df_v9 %>% group_by(vaccination_regimens_categories, sub_region) %>% 
                  arrange(match(vaccination_regimens_categories, c("2X HD", "2X LD", "1X HD", "Placebo"))) %>% 
                  arrange(sub_region) %>% 
                  remove_rownames %>% 
                  column_to_rownames(var="patient_id") %>% 
                  droplevels()

df_v9.t <- t(df_v9)

# Create the matrix for the heatmap
mat.v9 = as.matrix(df_v9.t[grep("call", colnames(df_v9)),])

# Clean up any leading whitespace
trim.leading <- function (x) sub("^\\s+", "", x)
mat.v9 <- trim.leading(mat.v9)

# Replace string values with numeric for visualization (assuming "1" for responder, "0" for non-responder)
# If your data already has 1s and 0s, this may not be needed
# Convert to numeric matrix while keeping NA values
mat.v9_numeric <- matrix(as.numeric(mat.v9), nrow=nrow(mat.v9))
rownames(mat.v9_numeric) <- rownames(mat.v9)
colnames(mat.v9_numeric) <- colnames(mat.v9)

# Set up annotation file and colors
ann.v9 <- data.frame(df_v9.t["sub_region",], df_v9$vaccination_regimens_categories)
colnames(ann.v9) = c("sub_region", "group")

# Updated colors to match Figure 2
colours.v9 <- list(
    "sub_region" = c("RW" = "#008800", "UG" = "#00008B", "US" = "#E41A1C"),
    "group" = c("2X HD" = "#8DD3C7", 
                "2X LD" = "#FFFFB3", 
                "1X HD" = "#BEBADA", 
                "Placebo" = "#B3DE69")
)

# Set up the colors for the heatmap cells - blue for responders, red for non-responders, black for NA
col_fun = c("0" = "#E41A1C", "1" = "#377EB8")

# Set up heatmap options
ht_opt(
    legend_title_gp = gpar(fontsize = 16, fontface = "bold"), 
    legend_labels_gp = gpar(fontsize = 14), 
    heatmap_column_names_gp = gpar(fontsize = 8),
    heatmap_column_title_gp = gpar(fontsize = 10),
    heatmap_row_title_gp = gpar(fontsize = 8)
)

# Create the column annotation with country names on color bars
# First create a function to add column labels on the annotation bars
column_title_fun = function(index) {
  # Map region codes to full names
  region_names = c("RW" = "Rwanda", "UG" = "Uganda", "US" = "USA")
  return(region_names[index])
}

# Create the column annotation
ha.v9 = HeatmapAnnotation(df = ann.v9,
                          which = 'col',
                          col = colours.v9,
                          annotation_width = unit(c(1, 4), 'cm'), 
                          annotation_name_side = "right", 
                          annotation_label = c("Geographic Region","Vaccine Groups"),
                          show_annotation_name = c(sub_region = FALSE, group = FALSE),
                          gap = unit(1, 'mm'),
                          show_legend = c("Geographic Region" = FALSE, "Vaccine Groups" =TRUE),
                          annotation_legend_param = list(
                            at = c("2X HD", 
                                   "2X LD" , 
                                   "1X HD", 
                                   "Placebo"), 
                            labels = c("Ad26/Ad26 or MVA plus high-dose gp140", 
                                      "Ad26/Ad26 or MVA plus low-dose gp140", 
                                      "Ad26/high-dose gp140",
                                      "Placebo")))

# Create row names for the right side labels - match Figure 2
# This maps the original assay names to the labels shown in Figure 2
assay_labels <- c(
    "esa_cla_call" = "Clade A",
    "esa_clb_call" = "Clade B",
    "esa_coc_call" = "Clade C (Con C)",
    "esa_clc_call" = "Clade C",
    "esa_mos1_call" = "Mos1",
    "adcp_cla_call" = "Clade A",
    "adcp_clb_call" = "Clade B",
    "adcp_coc_call" = "Clade C (Con C)",
    "adcp_clc_call" = "Clade C",
    "adcp_mos1_call" = "Mos1",
    "pot_em1_call" = "Env Mos1",
    "pot_em2_call" = "Env Mos2",
    "pot_gm1_call" = "Gag Mos1",
    "pot_gm2_call" = "Gag Mos2",
    "pot_pm1_call" = "Pol Mos1",
    "pot_pm2_call" = "Pol Mos2",
    "pot_e1p_call" = "Env1 PTE",
    "pot_e2p_call" = "Env2 PTE",
    "pot_e3p_call" = "Env3 PTE",
    "pot_gp_call" = "Gag PTE",
    "pot_pp_call" = "Pol PTE"
)

# Create the main heatmap
h.v9 = Heatmap(mat.v9_numeric, name = "Immune response", 
               na_col = "black", 
               col = col_fun, 
               row_split = factor(c("A", "A", "A", "A", "A",
                                  "B", "B", "B", "B", "B",
                                  "C", "C", "C", "C", "C",
                                  "C", "C", "C", "C", "C", "C"), levels = LETTERS[1:3]),
               column_split = factor(ann.v9[,1]),
               column_title = c("Rwanda", "Uganda", "USA"),  # Updated column titles
               top_annotation = ha.v9, 
               show_row_names = FALSE,  # We'll use row labels on the right instead
               show_column_names = FALSE,
               rect_gp = gpar(col = "white"),
               row_title = c("ELISA", "ADCP", "ELISpot"),
               cluster_rows = FALSE,
               cluster_columns = FALSE,
               heatmap_legend_param = list(
                   title = "Immune response", 
                   at = c(0, 1, NA), 
                   labels = c("Non-responder", "Responder", "NA")
               )
)

# Create the right-side row labels
rowAnno = rowAnnotation(
    labels = anno_text(
        assay_labels[rownames(mat.v9)],
        gp = gpar(fontsize = 10),
        just = "left"
    ),
    width = unit(3, "cm")
)

# Combine the heatmap with annotations
ht_list = h.v9 + rowAnno

# Draw the combined heatmap
draw(ht_list, merge_legends = TRUE, heatmap_legend_side = "left")
```

# Fig 1B, 1C. ELISA, ADCP and ELispot value 
```{r Fig 1B, 1C}
# Subset data as in original code
ps1_V9_RW_US_UG <- ps1_V9 %>% 
  subset_samples(group != "ND") %>% 
  subset_samples(vaccine_group == "vaccine")

sampleDF_RW_US_UG <- sample_data(ps1_V9_RW_US_UG)
sampleDF_RW_US_UG$sub_region = factor(sampleDF_RW_US_UG$sub_region, levels = c("RW", "UG", "US"))

# Set color scheme for regions (matching your image)
regioncolor <- c("RW" = "#008800", "UG" = "#00008B", "US" = "#E41A1C")

# Updated region labels with sample sizes
region_labels <- c("RW (n = 46)", "UG (n = 16)", "US (n = 32)")
names(region_labels) <- c("RW", "UG", "US")

# Function to calculate responder percentages
calc_percent_responders <- function(data) {
  data %>%
    group_by(sub_region, Group) %>%
    summarize(
      total = n(),
      responders = sum(Response > Threshold, na.rm = TRUE),
      percent = round(responders/total * 100, 1)
    ) %>%
    ungroup()
}

#----------------------------------------
# Process ADCP data for Panel B
#----------------------------------------
sampleDF_ADCP <- as_tibble(sampleDF_RW_US_UG[, c("sub_region", 
                                      "ADCP.7.VISIT.11.CLA", 
                                      "ADCP.7.VISIT.11.CLB", 
                                      "ADCP.7.VISIT.11.COC", 
                                      "ADCP.7.VISIT.11.CLC", 
                                      "ADCP.7.VISIT.11.MOS1")]) %>%
  pivot_longer(cols = starts_with("ADCP"),
               names_to = "Assay",
               values_to = "Response")

# Set thresholds
sampleDF_ADCP$Threshold <- ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLA", 5.16,
                             ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLB", 6.43,
                                   ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLC", 4.32,
                                         ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.COC", 6.49,
                                               ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.MOS1", 4.32, NA)))))

# Label groups
sampleDF_ADCP$Group <- ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLA", "Clade-A",
                          ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLB", "Clade-B",
                                ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLC", "Clade-C",
                                      ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.COC", "Clade-C\nCon C",
                                            ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.MOS1", "MOS-1", NA)))))

# Calculate percentage of responders
adcp_data <- calc_percent_responders(sampleDF_ADCP)

#----------------------------------------
# Process ELISpot data for Panel C
#----------------------------------------
sampleDF_POT <- as_tibble(sampleDF_RW_US_UG[, c("sub_region", 
                                     "POT.6.VISIT.10.EM1", 
                                     "POT.6.VISIT.10.EM2", 
                                     "POT.6.VISIT.10.E1P", 
                                     "POT.6.VISIT.10.E2P", 
                                     "POT.6.VISIT.10.E3P", 
                                     "POT.6.VISIT.10.GP", 
                                     "POT.6.VISIT.10.GM1", 
                                     "POT.6.VISIT.10.GM2", 
                                     "POT.6.VISIT.10.PP", 
                                     "POT.6.VISIT.10.PM1", 
                                     "POT.6.VISIT.10.PM2")]) %>%
  pivot_longer(cols = starts_with("POT"),
               names_to = "Assay",
               values_to = "Response")

# Set thresholds
sampleDF_POT$Threshold <- ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.EM1", 73,
                            ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.EM2", 112,
                                  ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E1P", 100,
                                        ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E2P", 100,
                                              ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E3P", 100, 
                                                    ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GP", 181,
                                                          ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GM1", 87,
                                                                ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GM2", 70,
                                                                      ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PP", 105,
                                                                            ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PM1", 63,
                                                                                  ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PM2", 55, NA)))))))))))

# Label groups
sampleDF_POT$Group <- ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.EM1", "Env\nMos1",
                        ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.EM2", "Env\nMos2",
                              ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E1P", "Env1\nPTE",
                                    ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E2P", "Env2\nPTE",
                                          ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E3P", "Env3\nPTE", 
                                                ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GP", "Gag\nPTE",
                                                      ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GM1", "Gag\nMos1",
                                                            ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GM2", "Gag\nMos2",
                                                                  ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PP", "Pol\nPTE",
                                                                        ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PM1", "Pol\nMos1",
                                                                              ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PM2", "Pol\nMos2", NA)))))))))))

# Calculate percentage of responders
elispot_data <- calc_percent_responders(sampleDF_POT)

#----------------------------------------
# Statistical significance annotations (based on image)
#----------------------------------------
# For Panel B - ADCP
adcp_sig <- data.frame(
  Group = c("Clade-A", "Clade-A", 
            "Clade-B", "Clade-B",  
            "Clade-C\nCon C", "Clade-C\nCon C", 
            "Clade-C", "Clade-C", 
            "MOS-1", "MOS-1"),
  comparison = c("RW_US", "UG_US", 
                "RW_US", "UG_US", 
                "RW_US", "UG_US", 
                "RW_US", "UG_US", 
                "RW_US", "UG_US"),
  y = c(45, 40, 
        90, 85, 
        112, 108,  
        85, 80, 
        112, 108),
  p_val = c("*", "ns", 
           "***", "**", 
           "ns", "ns", 
           "*", "***", 
           "*", "ns")
)

#----------------------------------------
# Create Panel B - ADCP
#----------------------------------------
panel_B <- ggplot(adcp_data, aes(x = Group, y = percent, fill = sub_region)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), width = 0.8) +
  scale_fill_manual(values = regioncolor, 
                   labels = region_labels, # Use custom labels with sample sizes
                   name = NULL) + # Remove the legend title
  geom_text(aes(label = paste0(percent, "%"), y = percent + 3), 
           position = position_dodge(width = 0.9), size = 2.5, angle = 0, hjust = 0.5) +
  labs(y = "Percentage of ADCP\nresponder in vaccine group", x = "") +
  scale_y_continuous(breaks = seq(0, 100, 20)) +
  coord_cartesian(ylim = c(0, 100), clip = "off") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 8),
    legend.position = "none", # Hide legend from panel B
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(30, 5.5, 30, 5.5) # Add extra margin at the top
  )

# Add significance indicators to Panel B
for(i in 1:nrow(adcp_sig)) {
  grp <- adcp_sig$Group[i]
  comp <- adcp_sig$comparison[i]
  
  # Get the position index of the group
  grp_pos <- which(unique(adcp_data$Group) == grp)
  
  # Calculate x positions based on the comparison type
  if(comp == "RW_US") {
    x1 <- grp_pos - 0.3
    x2 <- grp_pos + 0.3
  } else if(comp == "UG_US") {
    x1 <- grp_pos - 0.0
    x2 <- grp_pos + 0.3
  } else if(comp == "RW_UG") {
    x1 <- grp_pos - 0.3
    x2 <- grp_pos - 0.0
  }
  
panel_B <- panel_B + 
    # Horizontal line
    geom_segment(data = data.frame(x = x1, xend = x2, y = adcp_sig$y[i], yend = adcp_sig$y[i]),
                aes(x = x, y = y, xend = xend, yend = yend),
                inherit.aes = FALSE) +
    # Left bracket (vertical line)
    geom_segment(data = data.frame(x = x1, xend = x1, y = adcp_sig$y[i], yend = adcp_sig$y[i] - 3),
                aes(x = x, y = y, xend = xend, yend = yend),
                inherit.aes = FALSE) +
    # Right bracket (vertical line)
    geom_segment(data = data.frame(x = x2, xend = x2, y = adcp_sig$y[i], yend = adcp_sig$y[i] - 3),
                aes(x = x, y = y, xend = xend, yend = yend),
                inherit.aes = FALSE) +
    # Text label
    geom_text(data = data.frame(x = (x1+x2)/2, y = adcp_sig$y[i] + 2, label = adcp_sig$p_val[i]),
          aes(x = x, y = y, label = label),
          size = 3.5, inherit.aes = FALSE)
}

#----------------------------------------
# For Panel C - ELISpot
#----------------------------------------
elispot_sig <- data.frame(
  Group = c("Env\nMos1", "Env\nMos1", 
           "Env\nMos2", "Env\nMos2",
           "Gag\nMos1", "Gag\nMos1",
           "Gag\nMos2", "Gag\nMos2",
           "Pol\nMos1", "Pol\nMos1",
           "Pol\nMos2", "Pol\nMos2",
           "Env1\nPTE", "Env1\nPTE",
           "Env2\nPTE", "Env2\nPTE",
           "Env3\nPTE", "Env3\nPTE",
           "Gag\nPTE", "Gag\nPTE",
           "Pol\nPTE", "Pol\nPTE"),
  comparison = c("RW_US", "UG_US",
                "RW_US", "UG_US",
                "RW_US", "UG_US",
                "RW_US", "UG_US",
                "RW_US", "UG_US",
                "RW_US", "UG_US",
                "RW_US", "UG_US",
                "RW_US", "UG_US",
                "RW_US", "UG_US",
                "RW_US", "UG_US",
                "RW_US", "UG_US"),
  y = c(112, 108,
       85, 80,
       98, 93,
       88, 83,
       112, 108,
       112, 108,
       75, 70,
       58, 53,
       65, 60,
       88, 83,
       112, 108),
  p_val = c("ns", "ns",
           "*", "*",
           "*", "**",
           "**", "**",
           "***", "***",
           "***", "*",
           "ns", "*",
           "ns", "ns",
           "ns", "**",
           "*", "**",
           "***", "**")
)

# Define the desired order of groups for x-axis
group_order <- c("Env\nMos1", "Env\nMos2", "Gag\nMos1", "Gag\nMos2", 
                "Pol\nMos1", "Pol\nMos2", "Env1\nPTE", "Env2\nPTE", 
                "Env3\nPTE", "Gag\nPTE", "Pol\nPTE")

elispot_data$Group <- factor(elispot_data$Group, levels = group_order)

# Panel C - use the same scale_fill_manual as in Panel B for consistency
panel_C <- ggplot(elispot_data, aes(x = Group, y = percent, fill = sub_region)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), width = 0.8) +
  scale_fill_manual(values = regioncolor,
                   labels = region_labels, # Use custom labels with sample sizes
                   name = NULL) + # Remove the legend title
  geom_text(aes(label = paste0(percent, "%"), y = percent + 3),
           position = position_dodge(width = 0.9), size = 2.5, angle = 0, hjust = 0.5) +
  labs(y = "Percentage of ELISpot\nresponder in vaccine group", x = "") +
  scale_y_continuous(breaks = seq(0, 100, 20)) +
  coord_cartesian(ylim = c(0, 100), clip = "off") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 8),
    legend.position = "bottom", # Show legend for panel C
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(30, 5.5, 30, 5.5) # Add extra margin at top and bottom
  )

# Add significance indicators to Panel C with the same approach as Panel B
for(i in 1:nrow(elispot_sig)) {
  grp <- elispot_sig$Group[i]
  comp <- elispot_sig$comparison[i]
  
  # Get the position index of the group
  grp_pos <- which(levels(elispot_data$Group) == grp)
  
  # Calculate x positions based on the comparison type
  if(comp == "RW_US") {
    x1 <- grp_pos - 0.3
    x2 <- grp_pos + 0.3
  } else if(comp == "UG_US") {
    x1 <- grp_pos - 0.0
    x2 <- grp_pos + 0.3
  } else if(comp == "RW_UG") {
    x1 <- grp_pos - 0.3
    x2 <- grp_pos - 0.0
  }
  
  panel_C <- panel_C + 
    # Horizontal line
    geom_segment(data = data.frame(x = x1, xend = x2, y = elispot_sig$y[i], yend = elispot_sig$y[i]),
                aes(x = x, y = y, xend = xend, yend = yend),
                inherit.aes = FALSE) +
    # Left bracket (vertical line)
    geom_segment(data = data.frame(x = x1, xend = x1, y = elispot_sig$y[i], yend = elispot_sig$y[i] - 3),
                aes(x = x, y = y, xend = xend, yend = yend),
                inherit.aes = FALSE) +
    # Right bracket (vertical line)
    geom_segment(data = data.frame(x = x2, xend = x2, y = elispot_sig$y[i], yend = elispot_sig$y[i] - 3),
                aes(x = x, y = y, xend = xend, yend = yend),
                inherit.aes = FALSE) +
    # Text label
    geom_text(data = data.frame(x = (x1+x2)/2, y = elispot_sig$y[i] + 2, label = elispot_sig$p_val[i]),
             aes(x = x, y = y, label = label),
             size = 3.5, inherit.aes = FALSE)
}

#----------------------------------------
# Combine panels with a shared legend
#----------------------------------------
# Define labels
region_labels <- c("RW (n = 46)", "UG (n = 16)", "US (n = 32)")
names(region_labels) <- c("RW", "UG", "US")

# First, make sure both panels don't have legends
panel_B <- panel_B + theme(legend.position = "none")
panel_C <- panel_C + theme(legend.position = "none")

# Create a much simpler legend panel using grid graphics directly
create_legend_panel <- function() {
  # Create a new viewport that's the size of the panel
  grid.newpage()
  
  # Set the background to white
  grid.rect(gp = gpar(fill = "white", col = NA))
  
  # Set up colors and labels
  colors <- c("#008800", "#00008B", "#E41A1C")
  labels <- c("RW (n = 46)", "UG (n = 16)", "US (n = 32)")
  
  # Calculate positions for three evenly spaced elements
  x_positions <- seq(0.2, 0.8, length.out = 3)
  
  # Draw the squares and labels
  for (i in 1:3) {
    # Draw colored square
    grid.rect(x = x_positions[i] - 0.08, 
              y = 0.5, 
              width = 0.07, 
              height = 0.4,
              gp = gpar(fill = colors[i], col = NA))
    
    # Draw label text
    grid.text(labels[i], 
              x = x_positions[i], 
              y = 0.5, 
              just = "left",
              gp = gpar(fontsize = 14))
  }
  
  # Capture the current graphical device
  legend_grob <- grid.grab()
  return(legend_grob)
}

# Create the legend panel
legend_panel <- create_legend_panel()

# Arrange panels B and C in the top row
top_row <- plot_grid(
  panel_B, panel_C,
  ncol = 2,
  rel_widths = c(1, 1.8),
  labels = c("B.", "C."),
  label_size = 16,
  label_fontface = "bold",
  align = "h"
)

# Create the combined figure with the legend at the bottom
combined_figure <- plot_grid(
  top_row,
  legend_panel,
  ncol = 1,
  nrow = 2,
  rel_heights = c(10, 1)
)

# Display the figure
combined_figure

```

# Final Figure 1
```{r figure 1}
# Capture the heatmap (Fig 1A) as a grob
heatmap_grob <- grid.grabExpr({
  draw(ht_list, merge_legends = TRUE, heatmap_legend_side = "left")
})

# Convert to a ggplot-compatible object
heatmap_plot <- ggplotify::as.ggplot(heatmap_grob)

# Top row with just the heatmap and "A." label
top_row <- plot_grid(
  heatmap_plot,
  labels = "A.",
  label_size = 16,
  label_fontface = "bold"
)

# Middle row with panels B and C (retain your existing layout)
# Ensure the panels are labeled correctly
middle_row <- plot_grid(
  panel_B, panel_C,
  ncol = 2,
  rel_widths = c(1, 1.8),
  labels = c("B.", "C."),
  label_size = 16,
  label_fontface = "bold",
  align = "h"
)

# Create the combined figure with the legend at the bottom
final_figure <- plot_grid(
  top_row,
  middle_row,
  legend_panel,
  ncol = 1,
  nrow = 3,
  rel_heights = c(1.5, 1, 0.2)  # Adjust these values as needed
)

# Save the combined figure
ggsave("./figures/Figure_1.tiff", 
       final_figure, 
       width = 12, 
       height = 14,  # Increased height to accommodate all panels
       dpi = 300, 
       compression = "lzw",
       bg = "white")
```

# Supplemental figure 1. ELISA, ADCP and ELispot value
```{r Supplemental-Figure-1}
# create a dataframe contains all the ELISA value - Panel A
sampleDF_ESA <- as.tibble(sampleDF_RW_US_UG[ ,c("sub_region", "ESA.7.VISIT.11.CLA", "ESA.7.VISIT.11.CLB", "ESA.7.VISIT.11.COC", "ESA.7.VISIT.11.CLC", "ESA.7.VISIT.11.MOS1")])%>%
                pivot_longer(cols = starts_with("ESA"),
                             names_to = "Assay",
                             values_to = "Response") 

sampleDF_ESA$Threshold<- ifelse(sampleDF_ESA$Assay %in% "ESA.7.VISIT.11.CLA", log10(625),
                             ifelse(sampleDF_ESA$Assay %in% "ESA.7.VISIT.11.CLB", log10(156.25),
                                    ifelse(sampleDF_ESA$Assay %in% "ESA.7.VISIT.11.CLC", log10(625),
                                           ifelse(sampleDF_ESA$Assay %in% "ESA.7.VISIT.11.COC", log10(156.25),
                                                  ifelse(sampleDF_ESA$Assay %in% "ESA.7.VISIT.11.MOS1", log10(78.125), "NC")))))

sampleDF_ESA$Group <- ifelse(sampleDF_ESA$Assay %in% "ESA.7.VISIT.11.CLA", "Clade A",
                             ifelse(sampleDF_ESA$Assay %in% "ESA.7.VISIT.11.CLB", "Clade B",
                                    ifelse(sampleDF_ESA$Assay %in% "ESA.7.VISIT.11.CLC", "Clade C",
                                           ifelse(sampleDF_ESA$Assay %in% "ESA.7.VISIT.11.COC", "Clade C (Con C)",
                                                  ifelse(sampleDF_ESA$Assay %in% "ESA.7.VISIT.11.MOS1", "MOS1", "NC")))))

regioncolor <- c("RW" = "#008800", "UG" = "#00008B", "US" = "#E41A1C")

Plot_ESA <- ggplot(sampleDF_ESA, aes(x = sub_region, y = log10(Response))) + 
        ggplot2::geom_boxplot(
                            ggplot2::aes(color = sub_region), 
                            fill = "gray80", 
                            outlier.alpha = 0.0,
                            na.rm = TRUE,
                            alpha = .5,
                            show.legend = FALSE
                        ) +
        geom_jitter(aes(color = sub_region), alpha = 0.65,position = position_jitter(width = 0.3))+
        ggh4x::facet_grid2(~Group, scales = "free_y", space = "free_y", independent = "y")+
        scale_color_manual(values=regioncolor, name = "Geographic Region")+
        ylab("ELISA titer (Log10)") +
        xlab(" ") +
        ggplot2::theme(
                            panel.grid.major = ggplot2::element_blank(),
                            panel.grid.minor = ggplot2::element_blank(),
                            panel.background = ggplot2::element_blank(),
                            axis.line = ggplot2::element_line(colour = "black")
                        ) +
        theme(strip.text.x = element_text(size = 12),
          strip.background.x = element_rect(colour="black", fill="white")) +
        ggplot2::theme(legend.position = "bottom")+
        stat_compare_means(comparisons = list(c("RW", "US")), vjust = 0,label = "p.signif", label.x = 1.5, size = 4)

Plot_ESA <- Plot_ESA + geom_hline(aes(yintercept = 2.795), data = filter(sampleDF_ESA, Group == "Clade A"), lty = 2, lwd = 0.5)+ 
                       geom_hline(aes(yintercept = 2.193), data = filter(sampleDF_ESA, Group == "Clade B"), lty = 2, lwd = 0.5)+ 
                       geom_hline(aes(yintercept = 2.795), data = filter(sampleDF_ESA, Group == "Clade C"), lty = 2, lwd = 0.5)+
                       geom_hline(aes(yintercept = 2.193), data = filter(sampleDF_ESA, Group == "Clade C (Con C)"), lty = 2, lwd = 0.5)+
                       geom_hline(aes(yintercept = 1.892), data = filter(sampleDF_ESA, Group == "MOS1"), lty = 2, lwd = 0.5)
Plot_ESA

##########################
# create a dataframe contains all the ADCP value Panel B
sampleDF_ADCP <- as.tibble(sampleDF_RW_US_UG[ ,c("sub_region", "ADCP.7.VISIT.11.CLA", "ADCP.7.VISIT.11.CLB", "ADCP.7.VISIT.11.COC", "ADCP.7.VISIT.11.CLC", "ADCP.7.VISIT.11.MOS1")])%>%
                pivot_longer(cols = starts_with("ADCP"),
                             names_to = "Assay",
                             values_to = "Response") 

sampleDF_ADCP$Threshold<- ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLA", 5.16,
                             ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLB", 6.43,
                                    ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLC", 4.32,
                                           ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.COC", 6.49,
                                                  ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.MOS1", 4.32, "NC")))))


sampleDF_ADCP$Group <- ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLA", "Clade A",
                             ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLB", "Clade B",
                                    ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.CLC", "Clade C",
                                           ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.COC", "Clade C (Con C)",
                                                  ifelse(sampleDF_ADCP$Assay %in% "ADCP.7.VISIT.11.MOS1", "MOS1", "NC")))))

regioncolor <- c("RW" = "#008800", "UG" = "#00008B", "US" = "#E41A1C")

Plot_ADCP <- ggplot(sampleDF_ADCP, aes(x = sub_region, y = Response)) + 
        ggplot2::geom_boxplot(
                            ggplot2::aes(color = sub_region), 
                            fill = "gray80", 
                            outlier.alpha = 0.0,
                            na.rm = TRUE,
                            alpha = .5,
                            show.legend = FALSE
                        ) +
        geom_jitter(aes(color = sub_region), alpha = 0.65,position = position_jitter(width = 0.3))+
        ggh4x::facet_grid2(~Group, scales = "free_y", space = "free_y", independent = "y")+
        scale_color_manual(values=regioncolor, name = "Geographic Region")+
        ylab("Phagocytic score") +
        xlab(" ") +
        ggplot2::theme(
                            panel.grid.major = ggplot2::element_blank(),
                            panel.grid.minor = ggplot2::element_blank(),
                            panel.background = ggplot2::element_blank(),
                            axis.line = ggplot2::element_line(colour = "black")
                        ) +
        theme(strip.text.x = element_text(size = 12),
          strip.background.x = element_rect(colour="black", fill="white")) +
        ggplot2::theme(legend.position = "bottom")+
        stat_compare_means(comparisons = list(c("RW", "US")), vjust = 0,label = "p.signif", label.x = 1.5, size = 4)

Plot_ADCP <- Plot_ADCP + geom_hline(aes(yintercept = 5.16), data = filter(sampleDF_ADCP, Group == "Clade A"), lty = 2, lwd = 0.5)+ 
                       geom_hline(aes(yintercept = 6.43), data = filter(sampleDF_ADCP, Group == "Clade B"), lty = 2, lwd = 0.5)+ 
                       geom_hline(aes(yintercept = 4.32), data = filter(sampleDF_ADCP, Group == "Clade C"), lty = 2, lwd = 0.5)+
                       geom_hline(aes(yintercept = 6.49), data = filter(sampleDF_ADCP, Group == "Clade C (Con C)"), lty = 2, lwd = 0.5)+
                       geom_hline(aes(yintercept = 4.28), data = filter(sampleDF_ADCP, Group == "MOS1"), lty = 2, lwd = 0.5)

Plot_ADCP

##############################################################

# create a dataframe contains all the ELISpot value - Panel C
sampleDF_POT <- as.tibble(sampleDF_RW_US_UG[ ,c("sub_region", "POT.6.VISIT.10.EM1", "POT.6.VISIT.10.EM2", "POT.6.VISIT.10.E1P", "POT.6.VISIT.10.E2P", "POT.6.VISIT.10.E3P", "POT.6.VISIT.10.GP", "POT.6.VISIT.10.GM1", "POT.6.VISIT.10.GM2", "POT.6.VISIT.10.PP", "POT.6.VISIT.10.PM1", "POT.6.VISIT.10.PM2" )])%>%
                pivot_longer(cols = starts_with("POT"),
                             names_to = "Assay",
                             values_to = "Response") 

sampleDF_POT$Threshold<- ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.EM1", 73,
                             ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.EM2", 112,
                                    ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E1P", 100,
                                           ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E2P", 100,
                                                  ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E3P", 100, 
                                                         ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GP", 181,
                                                                ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GM1", 87,
                                                                       ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GM2", 70,
                                                                              ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PP", 105,
                                                                              ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PM1", 63,
                                                                                     ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PM2", 55,"NC")
                                                                                     ))))))))))

sampleDF_POT$Group <- ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.EM1", "Env Mos1",
                             ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.EM2", "Env Mos2",
                                    ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E1P", "Env1 PTE",
                                           ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E2P", "Env2 PTE",
                                                  ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.E3P", "Env3 PTE", 
                                                         ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GP", "Gag PTE",
                                                                ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GM1", "Gag Mos1",
                                                                       ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.GM2", "Gag Mos2",
                                                                              ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PP", "Pol PTE",
                                                                              ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PM1", "Pol Mos1",
                                                                                     ifelse(sampleDF_POT$Assay %in% "POT.6.VISIT.10.PM2", "Pol Mos2","NC")
                                                                                     ))))))))))

regioncolor <- c("RW" = "#008800", "UG" = "#00008B", "US" = "#E41A1C")

Plot_POT <- ggplot(sampleDF_POT, aes(x = sub_region, y = log10(Response))) + 
        ggplot2::geom_boxplot(
                            ggplot2::aes(color = sub_region), 
                            fill = "gray80", 
                            outlier.alpha = 0.0,
                            na.rm = TRUE,
                            alpha = .5,
                            show.legend = FALSE
                        ) +
        geom_jitter(aes(color = sub_region), alpha = 0.65,position = position_jitter(width = 0.3))+
        ggh4x::facet_grid2(~Group, scales = "free_y", space = "free_y", independent = "y")+
        scale_color_manual(values=regioncolor, name = "Geographic Region")+
        ylab("SFU (Log10)/10e6 PBMC)") +
        xlab(" ") +
        ggplot2::theme(
                            panel.grid.major = ggplot2::element_blank(),
                            panel.grid.minor = ggplot2::element_blank(),
                            panel.background = ggplot2::element_blank(),
                            axis.line = ggplot2::element_line(colour = "black")
                        ) +
        theme(strip.text.x = element_text(size = 12),
          strip.background.x = element_rect(colour="black", fill="white")) +
        ggplot2::theme(legend.position = "bottom")+
        stat_compare_means(comparisons = list(c("RW", "US")), vjust = 0,label = "p.signif", label.x = 1.5, size = 4)

Plot_POT <- Plot_POT + geom_hline(aes(yintercept = log10(73)), data = filter(sampleDF_POT, Group == "Env Mos1"), lty = 2, lwd = 0.5)+ 
                       geom_hline(aes(yintercept = log10(73)), data = filter(sampleDF_POT, Group == "Env Mos2"), lty = 2, lwd = 0.5)+ 
                       geom_hline(aes(yintercept = log10(100)), data = filter(sampleDF_POT, Group == "Env1 PTE"), lty = 2, lwd = 0.5)+
                       geom_hline(aes(yintercept = log10(100)), data = filter(sampleDF_POT, Group == "Env2 PTE"), lty = 2, lwd = 0.5)+
                       geom_hline(aes(yintercept = log10(100)), data = filter(sampleDF_POT, Group == "Env3 PTE"), lty = 2, lwd = 0.5)+
                           geom_hline(aes(yintercept = log10(181)), data = filter(sampleDF_POT, Group == "Gag PTE"), lty = 2, lwd = 0.5)+
                           geom_hline(aes(yintercept = log10(87)), data = filter(sampleDF_POT, Group == "Gag Mos1"), lty = 2, lwd = 0.5)+
                           geom_hline(aes(yintercept = log10(70)), data = filter(sampleDF_POT, Group == "Gag Mos2"), lty = 2, lwd = 0.5)+
                           geom_hline(aes(yintercept = log10(105)), data = filter(sampleDF_POT, Group == "Pol PTE"), lty = 2, lwd = 0.5)+
                           geom_hline(aes(yintercept = log10(63)), data = filter(sampleDF_POT, Group == "Pol Mos1"), lty = 2, lwd = 0.5)+
                      geom_hline(aes(yintercept = log10(55)), data = filter(sampleDF_POT, Group == "Pol Mos2"), lty = 2, lwd = 0.5)
Plot_POT

# Add panel labels to each plot
Plot_ESA <- Plot_ESA + 
  theme(
    plot.margin = margin(t = 15, r = 10, b = 15, l = 40),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12),
    strip.text.x = element_text(size = 14, face = "bold"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12)
  )

Plot_ADCP <- Plot_ADCP + 
  theme(
    plot.margin = margin(t = 15, r = 10, b = 15, l = 40),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12),
    strip.text.x = element_text(size = 14, face = "bold"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12)
  )

Plot_POT <- Plot_POT + 
  theme(
    plot.margin = margin(t = 15, r = 10, b = 15, l = 40),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12),
    strip.text.x = element_text(size = 14, face = "bold"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12)
  )

# Create a shared legend to reduce duplicate legends
shared_legend <- get_legend(
  Plot_ESA + 
    theme(legend.position = "bottom",
          legend.box.margin = margin(0, 0, 0, 0),
          legend.title = element_text(size = 14, face = "bold"),
          legend.text = element_text(size = 12))
)

# Remove legends from individual plots
Plot_ESA <- Plot_ESA + theme(legend.position = "none")
Plot_ADCP <- Plot_ADCP + theme(legend.position = "none")
Plot_POT <- Plot_POT + theme(legend.position = "none")

# Combine the three plots into a single figure with tighter spacing
combined_figure_S1 <- ggdraw(xlim = c(0, 1), ylim = c(0, 1)) +  # Standard canvas dimensions
  # Add the three main plots with minimal spacing between them
  draw_plot(Plot_ESA, x = 0.05, y = 0.68, width = 0.70, height = 0.32) +
  draw_plot(Plot_ADCP, x = 0.05, y = 0.36, width = 0.70, height = 0.32) +
  draw_plot(Plot_POT, x = 0.05, y = 0.02, width = 0.95, height = 0.34) +
  # Add the panel labels at the top of each row with larger font
  draw_label("A.", x = 0.02, y = 0.95, size = 24, fontface = "bold") +
  draw_label("B.", x = 0.02, y = 0.63, size = 24, fontface = "bold") +
  draw_label("C.", x = 0.02, y = 0.31, size = 24, fontface = "bold") +
  # Add the shared legend at the bottom
  draw_grob(shared_legend, x = 0.5, y = 0.01, width = 0.9, height = 0.05)

# Save the combined figure as a compressed TIFF
ggsave("./figures/Supplemental_Figure_1.tiff", 
       combined_figure_S1, 
       width = 16,
       height = 18,      # Reduced height to eliminate excess white space
       dpi = 300,
       compression = "lzw",
       bg = "white")

```

# Fig 2A
```{r Fig 2A}
threshold = 0.01
ps1.phylum_V2 <- ps1_V2 %>%
  tax_glom(taxrank = "Phylum") %>%
  transform_sample_counts(function(x) {x/sum(x)} ) %>%
  psmelt %>%
  filter(Abundance > threshold) %>%
  arrange(Phylum, Abundance)
ps1.phylum_V2_US <- ps1.phylum_V2%>% filter(sub_region == "US")

# New facet label names for vaccinegroup variable
vaccinegroup.labs <- c("PG", "Vaccine Group")
names(vaccinegroup.labs) <- c("placebo", "vaccine")

# Create the plots
p.cc.region_V2_US <- ggplot(ps1.phylum_V2_US, aes(x = as.factor(sample_id), y = Abundance, fill = fct_reorder(Phylum, Abundance))) +
  geom_bar(stat = "identity", width = 1) +
  ggtitle("Early vaccination") +
  facet_grid(~vaccine_group, scales = "free", space = "free", labeller = labeller(vaccine_group = vaccinegroup.labs)) +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
  scale_fill_manual(values = Phylumcolor)+
  theme(axis.text.x = element_blank()) +
  theme(axis.title.x = element_blank()) +
  labs(fill = "Phylum")
  
ps1.phylum_V9 <- ps1_V9 %>%
  tax_glom(taxrank = "Phylum") %>%
  transform_sample_counts(function(x) {x/sum(x)} ) %>%
  psmelt %>%
  filter(Abundance > threshold) %>%
  arrange(Phylum, Abundance)
ps1.phylum_V9_US <- ps1.phylum_V9%>% filter(sub_region == "US")

# Create the second plot
p.cc.region_V9_US <- ggplot(ps1.phylum_V9_US, aes(x = as.factor(sample_id), y = Abundance, fill = fct_reorder(Phylum, Abundance))) +
  geom_bar(stat = "identity", width = 1) +
  ggtitle("Late vaccination") +
  facet_grid(~vaccine_group, scales = "free", space = "free", labeller = labeller(vaccine_group = vaccinegroup.labs)) +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none") +
  scale_fill_manual(values = Phylumcolor) +
  theme(axis.text.x = element_blank()) +
  theme(axis.title.x = element_blank()) +
  labs(fill = "Phylum")

# Combine the plots horizontally
p.cc.region_US <- plot_grid(p.cc.region_V2_US, p.cc.region_V9_US, ncol = 2)

# Create the title
title <- grid::textGrob("US Samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Create a separate, simple plot just for the legend
dummy_data <- data.frame(
  Phylum = names(Phylumcolor),
  y = rep(1, length(Phylumcolor))
)

legend_plot <- ggplot(dummy_data, aes(x = Phylum, y = y, fill = Phylum)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = Phylumcolor) +
  labs(fill = "Phylum") +
  theme_minimal() +
  theme(legend.position = "bottom", 
        legend.box = "horizontal",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8))

# Extract just the legend - with a safer method
legend_only <- ggpubr::as_ggplot(ggpubr::get_legend(legend_plot))

# Combine everything
final_plot <- plot_grid(
  title,
  p.cc.region_US,
  legend_only,
  ncol = 1,
  rel_heights = c(0.1, 1, 0.2)
)

# Display the final result
final_plot
```

# Fig 2B 
```{r Fig 2B}
threshold = 0.01
ps1.phylum_V2 <- ps1_V2 %>%
  tax_glom(taxrank = "Phylum") %>%
  transform_sample_counts(function(x) {x/sum(x)} ) %>%
  psmelt %>%
  filter(Abundance > threshold) %>%
  arrange(Phylum, Abundance)
ps1.phylum_V2_UG <- ps1.phylum_V2%>% filter(sub_region == "UG")

# New facet label names for vaccinegroup variable
vaccinegroup.labs <- c("PG", "Vaccine Group")
names(vaccinegroup.labs) <- c("placebo", "vaccine")

# Create the plots
p.cc.region_V2_UG <- ggplot(ps1.phylum_V2_UG, aes(x = as.factor(sample_id), y = Abundance, fill = fct_reorder(Phylum, Abundance))) +
  geom_bar(stat = "identity", width = 1) +
  ggtitle("Early vaccination") +
  facet_grid(~vaccine_group, scales = "free", space = "free", labeller = labeller(vaccine_group = vaccinegroup.labs)) +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
  scale_fill_manual(values = Phylumcolor)+
  theme(axis.text.x = element_blank()) +
  theme(axis.title.x = element_blank()) +
  labs(fill = "Phylum")
  
ps1.phylum_V9 <- ps1_V9 %>%
  tax_glom(taxrank = "Phylum") %>%
  transform_sample_counts(function(x) {x/sum(x)} ) %>%
  psmelt %>%
  filter(Abundance > threshold) %>%
  arrange(Phylum, Abundance)
ps1.phylum_V9_UG <- ps1.phylum_V9%>% filter(sub_region == "UG")

# Create the second plot
p.cc.region_V9_UG <- ggplot(ps1.phylum_V9_UG, aes(x = as.factor(sample_id), y = Abundance, fill = fct_reorder(Phylum, Abundance))) +
  geom_bar(stat = "identity", width = 1) +
  ggtitle("Late vaccination") +
  facet_grid(~vaccine_group, scales = "free", space = "free", labeller = labeller(vaccine_group = vaccinegroup.labs)) +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none") +
  scale_fill_manual(values = Phylumcolor) +
  theme(axis.text.x = element_blank()) +
  theme(axis.title.x = element_blank()) +
  labs(fill = "Phylum")

# Combine the plots horizontally
p.cc.region_UG <- plot_grid(p.cc.region_V2_UG, p.cc.region_V9_UG, ncol = 2)

# Create the title
title <- grid::textGrob("UG Samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Create a separate, simple plot just for the legend
dummy_data <- data.frame(
  Phylum = names(Phylumcolor),
  y = rep(1, length(Phylumcolor))
)

legend_plot <- ggplot(dummy_data, aes(x = Phylum, y = y, fill = Phylum)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = Phylumcolor) +
  labs(fill = "Phylum") +
  theme_minimal() +
  theme(legend.position = "bottom", 
        legend.box = "horizontal",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8))

# Extract just the legend - with a safer method
legend_only <- ggpubr::as_ggplot(ggpubr::get_legend(legend_plot))

# Combine everything
final_plot <- plot_grid(
  title,
  p.cc.region_UG,
  legend_only,
  ncol = 1,
  rel_heights = c(0.1, 1, 0.2)
)

# Display the final result
final_plot
```

# Fig 2C
```{r  Fig 2C}
# US
# Diversity calculations
diversity_M <- as_tibble(microbiome::alpha(ps1_M))
# ignroe the warning message
diversity_M

# Faith's phylogenetic diversity
library("btools")
v_M.faiths <- ps1_M %>%
  estimate_pd() %>%
  select(-SR)

# Bind sample data to diversity data
sd_M <- as.tibble(sample_data(ps1_M)) # useful to coerce the phyloseq object into an R data frame
# Bind sample data to diversity data and Pielou's evenness
ps1.M.alpha <- as.tibble(cbind(sd_M, diversity_M, v_M.faiths)) # merge sd by row names

ps1.US_M <- ps1.M.alpha %>% filter(sub_region == "US") %>% group_by(visit_description) %>% mutate(group2 = 1:n())
ps1.US_M

# Select diversity measures
alpha.div.meas <- c("evenness_pielou",
                    "observed",
                    "PD")
# Pivot to long form
alpha.US_M <- ps1.US_M %>%
  pivot_longer(cols = observed:PD,
               names_to = "Alpha",
               values_to = "Value")
# Convert Alpha to factor
alpha.US_M$Alpha <- as.factor(alpha.US_M$Alpha)
alpha.US_M.select <- alpha.US_M %>%
  filter(Alpha %in% alpha.div.meas) %>%
  mutate(Alpha=recode(Alpha, evenness_pielou = "Pielous Evenness",
                      observed = "Richness",
                      PD = "Faith's PD")) %>%
  droplevels()
alpha.US_M.select$Alpha <- factor(alpha.US_M.select$Alpha, levels = c("Richness",
                                                                  "Faith's PD",
                                                                  "Pielous Evenness"))
# Stats
alpha.US_M.select.wilcox <- alpha.US_M.select %>%
  group_by(Alpha) %>%
  wilcox_test(Value ~ visit_description, p.adjust.method= "holm")
alpha.US_M.select.wilcox

# Summary stats
alpha.US_M.select %>%
  select(visit_description, Alpha, Value) %>%
  #filter(Alpha == "Richness") %>%
  group_by(visit_description, Alpha) %>%
  summarize(mean = mean(Value), stdev = sd(Value))


#######################
matchcolor <- c("V2 STOOL COLLECTION" ="#00A087B2", "V9 STOOL COLLECTION" = "#F39B7FB2")

richness_US_M <- ggpaired(data = ps1.US_M, x = "visit_description", y = "observed",id = "group2", color = "visit_description", point.size = 2.5,line.color = "gray", line.size = 0.4, palette = "jco")+
  stat_compare_means(comparisons = list(c("V2 STOOL COLLECTION", "V9 STOOL COLLECTION")), label = "p.signif", paired = TRUE, label.y = 380) +
  ylab("Bacterial Richness") +
  xlab(" ") +
  scale_color_manual(values=matchcolor)+
  scale_x_discrete(labels=c("V2 STOOL COLLECTION" = "Early", "V9 STOOL COLLECTION" = "Late")) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")

FPD_US_M <- ggpaired(data = ps1.US_M, x = "visit_description", y = "PD",id = "group2",
         color = "visit_description", point.size = 2.5,line.color = "gray", line.size = 0.4, palette = "jco")+
  stat_compare_means(comparisons = list(c("V2 STOOL COLLECTION", "V9 STOOL COLLECTION")), label = "p.signif", paired = TRUE, label.y = 45) +
  ylab("Bacterial Faith's PD") +
  xlab(" ") +
  scale_color_manual(values=matchcolor)+
  scale_x_discrete(labels=c("V2 STOOL COLLECTION" = "Early", "V9 STOOL COLLECTION" = "Late")) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")

####################
alphadiversity_US_M <- ggarrange(richness_US_M, FPD_US_M, ncol = 2)
alphadiversity_US_M <-  plot_grid(NULL, alphadiversity_US_M, ncol = 1, rel_heights = c(0.15,1))

# Create a text grob for the title
title <- grid::textGrob("US Samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Add the title to your plot
alphadiversity_US_M <- plot_grid(
  title,  # Add the title grob as the first element
  alphadiversity_US_M,  # Your existing plot
  ncol = 1,  # Stack vertically
  rel_heights = c(0.15, 1)  # Title takes 15% of the height
)

alphadiversity_US_M

```

# Fig 2D
```{r  Fig 2D}
# UG
ps1.UG_M <- ps1.M.alpha %>% filter(sub_region == "UG") %>% group_by(visit_description) %>% mutate(group2 = 1:n())
ps1.UG_M

# Select diversity measures
alpha.div.meas <- c("evenness_pielou",
                    "observed",
                    "PD")
# Pivot to long form
alpha.UG_M <- ps1.UG_M %>%
  pivot_longer(cols = observed:PD,
               names_to = "Alpha",
               values_to = "Value")
# Convert Alpha to factor
alpha.UG_M$Alpha <- as.factor(alpha.UG_M$Alpha)
alpha.UG_M.select <- alpha.UG_M %>%
  filter(Alpha %in% alpha.div.meas) %>%
  mutate(Alpha=recode(Alpha, evenness_pielou = "Pielous Evenness",
                      observed = "Richness",
                      PD = "Faith's PD")) %>%
  droplevels()
alpha.UG_M.select$Alpha <- factor(alpha.UG_M.select$Alpha, levels = c("Richness",
                                                                  "Faith's PD",
                                                                  "Pielous Evenness"))
# Stats
alpha.UG_M.select.wilcox <- alpha.UG_M.select %>%
  group_by(Alpha) %>%
  wilcox_test(Value ~ visit_description, p.adjust.method= "holm")
alpha.UG_M.select.wilcox

# Summary stats
alpha.UG_M.select %>%
  select(visit_description, Alpha, Value) %>%
  #filter(Alpha == "Richness") %>%
  group_by(visit_description, Alpha) %>%
  summarize(mean = mean(Value), stdev = sd(Value))


#######################
matchcolor <- c("V2 STOOL COLLECTION" ="#00A087B2", "V9 STOOL COLLECTION" = "#F39B7FB2")

richness_UG_M <- ggpaired(data = ps1.UG_M, x = "visit_description", y = "observed",id = "group2", color = "visit_description", point.size = 2.5,line.color = "gray", line.size = 0.4, palette = "jco")+
  stat_compare_means(comparisons = list(c("V2 STOOL COLLECTION", "V9 STOOL COLLECTION")), label = "p.signif", paired = TRUE, label.y = 380) +
  ylab("Bacterial Richness") +
  xlab(" ") +
  scale_color_manual(values=matchcolor)+
  scale_x_discrete(labels=c("V2 STOOL COLLECTION" = "Early", "V9 STOOL COLLECTION" = "Late")) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")

FPD_UG_M <- ggpaired(data = ps1.UG_M, x = "visit_description", y = "PD",id = "group2",
         color = "visit_description", point.size = 2.5,line.color = "gray", line.size = 0.4, palette = "jco")+
  stat_compare_means(comparisons = list(c("V2 STOOL COLLECTION", "V9 STOOL COLLECTION")), label = "p.signif", paired = TRUE, label.y = 45) +
  ylab("Bacterial Faith's PD") +
  xlab(" ") +
  scale_color_manual(values=matchcolor)+
  scale_x_discrete(labels=c("V2 STOOL COLLECTION" = "Early", "V9 STOOL COLLECTION" = "Late")) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")

####################
alphadiversity_UG_M <- ggarrange(richness_UG_M, FPD_UG_M, ncol = 2)
alphadiversity_UG_M <-  plot_grid(NULL, alphadiversity_UG_M, ncol = 1, rel_heights = c(0.15,1))

# Create a text grob for the title
title <- grid::textGrob("UG Samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Add the title to your plot
alphadiversity_UG_M <- plot_grid(
  title,  # Add the title grob as the first element
  alphadiversity_UG_M,  # Your existing plot
  ncol = 1,  # Stack vertically
  rel_heights = c(0.15, 1)  # Title takes 15% of the height
)

alphadiversity_UG_M

```

### beta-adonis test for PCOA analysis between two individual collection from the same people

# Fig 2E combo
``` {r Fig 2E combo}
# Combine US and UG samples for a single plot
# Ensure ps1_M contains all samples (both US and UG)

# Calculate ordination for the full dataset
ord.pcoa.wuni_M_all <- ordinate(ps1_M, method = "PCoA", distance = "wunifrac")
evals.wuni_M_all <- ord.pcoa.wuni_M_all$values$Eigenvalues

# Set seed for reproducibility
set.seed(46395617)

# Calculate percent variation explained for axis labels
axis1_var <- round(100 * evals.wuni_M_all[1] / sum(evals.wuni_M_all), 1)
axis2_var <- round(100 * evals.wuni_M_all[2] / sum(evals.wuni_M_all), 1)

# Create the combined plot with both shape and color to differentiate groups
p.pcoa.wuni.combined <- plot_ordination(ps1_M, ord.pcoa.wuni_M_all, 
                              color = "sub_region", shape = "visit_description") +
  geom_point(size = 3) +
  labs(title = "Combined US and UG Samples", 
       color = "Region", 
       shape = "Timepoint",
       x = paste0("PC1 (", axis1_var, "%)"),
       y = paste0("PC2 (", axis2_var, "%)")) +
  scale_color_manual(values = c("US" = "#3B9AB2", "UG" = "#E14B31")) +
  scale_shape_manual(values = c("V2 STOOL COLLECTION" = 16, "V9 STOOL COLLECTION" = 17),
                     labels = c("V2 STOOL COLLECTION" = "Early vaccination", 
                               "V9 STOOL COLLECTION" = "Late vaccination")) +
  stat_ellipse(aes(color = sub_region, group = interaction(sub_region, visit_description)), 
               type = "norm", linetype = 2) +
  geom_hline(yintercept = 0, lty = 2, lwd = 0.1) +
  geom_vline(xintercept = 0, lty = 2, lwd = 0.1) +
  theme_bw() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  ) 

# Add fixed p-values in the lower right corner ONLY
p.pcoa.wuni.combined <- p.pcoa.wuni.combined +
  annotate("text", x = 0.55, y = -0.35,
           label = paste("ADONIS p-values:\nRegion: p = 0.001", 
                         "\nTimepoint: p = 0.447",
                         "\nInteraction: p = 0.324"),
           hjust = 1, vjust = 0, size = 3.5)

# Display the plot
print(p.pcoa.wuni.combined)

# Optional: Save the plot
# ggsave("combined_pcoa_plot.pdf", p.pcoa.wuni.combined, width = 10, height = 8)
```

# Final Figure 2 combo
```{r figure 2 combo}
# Final Figure 2 combo
# Clean theme without borders
clean_theme <- theme(
  panel.background = element_rect(fill = "white", color = NA),
  plot.background = element_rect(fill = "white", color = NA),
  panel.border = element_blank(),
  legend.background = element_rect(fill = "white", color = NA),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  legend.position = "bottom"  # Move all legends to bottom
)

# Apply clean theme to all plots
p.cc.region_US_clean <- p.cc.region_US + clean_theme
p.cc.region_UG_clean <- p.cc.region_UG + clean_theme
alphadiversity_US_M_clean <- alphadiversity_US_M + clean_theme
alphadiversity_UG_M_clean <- alphadiversity_UG_M + clean_theme
#p.pcoa.wuni.combined <- p.pcoa.wuni.combined + clean_theme

# Remove legends from plotting panels
p.cc.region_US_no_legend <- p.cc.region_US_clean + theme(legend.position = "none")
p.cc.region_UG_no_legend <- p.cc.region_UG_clean + theme(legend.position = "none")
alphadiversity_US_M_no_legend <- alphadiversity_US_M_clean + theme(legend.position = "none")
alphadiversity_UG_M_no_legend <- alphadiversity_UG_M_clean + theme(legend.position = "none")
#p.pcoa.wuni.combined_no_legend <- p.pcoa.wuni.combined + theme(legend.position = "none")

# Create a separate, simple plot for the phylum legend with our approach that worked before
dummy_data <- data.frame(
  Phylum = names(Phylumcolor),
  y = rep(1, length(Phylumcolor))
)

legend_plot <- ggplot(dummy_data, aes(x = Phylum, y = y, fill = Phylum)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = Phylumcolor) +
  labs(fill = "Phylum") +
  theme_minimal() +
  theme(legend.position = "bottom", 
        legend.box = "horizontal",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8))

# Extract the phylum legend with horizontal orientation
phylum_legend <- ggpubr::as_ggplot(ggpubr::get_legend(legend_plot))

# Extract the sample group legend
sample_group_legend <- get_legend(
  p.pcoa.wuni.combined + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom",
          legend.box.margin = margin(0, 0, 0, 0))
)

# Create simple rows without dividers
top_row <- plot_grid(
  p.cc.region_US_no_legend, p.cc.region_UG_no_legend, 
  ncol = 2,
  labels = c("A.", "B."),
  label_size = 18
)

# Create small space padding
small_space <- ggplot() + theme_void()

middle_row <- plot_grid(
  alphadiversity_US_M_no_legend, alphadiversity_UG_M_no_legend,
  ncol = 2,
  labels = c("C.", "D."),
  label_size = 18
)

# Create a blank plot for the empty column
blank_plot <- ggplot() + theme_void()

# Modified bottom row with panel E and a blank column
bottom_row <- plot_grid(
  p.pcoa.wuni.combined, blank_plot,
  ncol = 2,
  labels = c("E.", ""),  # Empty label for blank plot
  label_size = 18,
  rel_widths = c(1, 1)  # Equal widths for the PCoA plot and blank space
)

# New layout:
# 1. Top row (A & B)
# 2. Phylum legend
# 3. Middle row (C & D)
# 4. More space
# 5. Bottom row (E & blank)
# 6. Sample group legend at the very bottom
final_plot <- plot_grid(
  top_row,
  small_space,
  phylum_legend,  # Phylum legend between rows 1 and 2
  small_space,
  middle_row,
  small_space,
  bottom_row,
  small_space,
  sample_group_legend,  # Sample group legend at the bottom
  ncol = 1,
  rel_heights = c(1, 0.05, 0.2, 0.05, 1, 0.05, 1, 0.05, 0.2)  # Adjusted heights
)

# Final figure with clean white background
final_plot_with_bg_combo <- ggdraw() + 
  draw_plot(final_plot) +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA)
  )

# Save as compressed TIFF with white background
ggsave(
  "./figures/Figure_2_combo.tiff",
  plot = final_plot_with_bg_combo,
  width = 14,    # Wider
  height = 16,
  dpi = 300,
  compression = "lzw",
  bg = "white"
)

# Display the final plot
final_plot_with_bg_combo
```

# Fig Supplemental 2A
```{r Fig S2A}
# Diversity calculations
diversity_phageM <- as_tibble(microbiome::alpha(physeqCompleteSamples, index = c("observed", "diversity_shannon", "evenness_pielou")))
diversity_phageM

# Bind sample data to diversity data
sd_phageM <- as.tibble(sample_data(physeqCompleteSamples)) # useful to coerce the phyloseq object into an R data frame
# Bind sample data to diversity data and Pielou's evenness
ps1.phageM.alpha <- as.tibble(cbind(sd_phageM, diversity_phageM)) # merge sd by row names
ps1.phageM.alpha$group <- factor(ps1.phageM.alpha$group, levels = c("GROUP 1", "GROUP 2", "GROUP 3", "GROUP 4", "GROUP 5", "GROUP 6", "GROUP 7", "GROUP 8"))

ps1.US_phageM <- ps1.phageM.alpha %>% filter(sub_region == "US") %>% group_by(visit_description) %>% mutate(group2 = 1:n())
ps1.US_phageM

# Select diversity measures
alpha.div.meas.phage <- c("observed",
                          "diversity_shannon",
                          "evenness_pielou")
# Pivot to long form
alpha.US_phageM <- ps1.US_phageM %>%
  pivot_longer(cols = observed:evenness_pielou,
               names_to = "Alpha",
               values_to = "Value")
# Convert Alpha to factor
alpha.US_phageM$Alpha <- as.factor(alpha.US_phageM$Alpha)
alpha.US_phageM.select <- alpha.US_phageM %>%
  filter(Alpha %in% alpha.div.meas.phage) %>%
  mutate(Alpha=recode(Alpha, evenness_pielou = "Pielous Evenness",
                      observed = "Richness",
                      diversity_shannon = "Shannon Diversity")) %>%
  droplevels()
alpha.US_phageM.select$Alpha <- factor(alpha.US_phageM.select$Alpha, levels = c("Richness",
                                                                  "Shannon Diversity",
                                                                  "Pielous Evenness"))
# Stats
alpha.US_phageM.select.wilcox <- alpha.US_phageM.select %>%
  group_by(Alpha) %>%
  wilcox_test(Value ~ visit_description)
alpha.US_phageM.select.wilcox

# Summary stats
alpha.US_phageM.select %>%
  select(visit_description, Alpha, Value) %>%
  #filter(Alpha == "Richness") %>%
  group_by(visit_description, Alpha) %>%
  summarize(mean = mean(Value), stdev = sd(Value))

#######################
matchcolor <- c("V2 STOOL COLLECTION" ="#00A087B2", "V9 STOOL COLLECTION" = "#F39B7FB2")

richness_US_phageM <- ggpaired(data = ps1.US_phageM, x = "visit_description", y = "observed",id = "group2", color = "visit_description", point.size = 2.5,line.color = "gray", line.size = 0.4, palette = "jco")+
  stat_compare_means(comparisons = list(c("V2 STOOL COLLECTION", "V9 STOOL COLLECTION")), label = "p.signif", paired = TRUE, label.y = 130) +
  ylab("Phage Richness") +
  xlab(" ") +
  scale_color_manual(values=matchcolor)+
  scale_x_discrete(labels=c("V2 STOOL COLLECTION" = "Early", "V9 STOOL COLLECTION" = "Late")) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")

Shannon_US_phageM <- ggpaired(data = ps1.US_phageM, x = "visit_description", y = "diversity_shannon",id = "group2",
         color = "visit_description", point.size = 2.5,line.color = "gray", line.size = 0.4, palette = "jco")+
  stat_compare_means(comparisons = list(c("V2 STOOL COLLECTION", "V9 STOOL COLLECTION")), label = "p.signif", paired = TRUE, label.y = 4) +
  ylab("Phage Shannon Diversity") +
  xlab(" ") +
  scale_color_manual(values=matchcolor)+
  scale_x_discrete(labels=c("V2 STOOL COLLECTION" = "Early", "V9 STOOL COLLECTION" = "Late")) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")

####################
alphadiversity_US_phageM <- ggarrange(richness_US_phageM, Shannon_US_phageM, ncol = 2)

# Create the title with centered alignment
title <- grid::textGrob("US Samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Make the entire plot with the title on top
alphadiversity_US_phageM <- plot_grid(
  title,  # Title grob at the top
  alphadiversity_US_phageM,  # Your plot below
  ncol = 1,  # Stack vertically
  rel_heights = c(0.15, 1)  # Title takes 15% of the height
)

alphadiversity_US_phageM

```

# Fig Supplemental 2B
```{r Fig S2B}
# Diversity calculations
diversity_phageM <- as_tibble(microbiome::alpha(physeqCompleteSamples, index = c("observed", "diversity_shannon", "evenness_pielou")))
diversity_phageM

# Bind sample data to diversity data
sd_phageM <- as.tibble(sample_data(physeqCompleteSamples)) # useful to coerce the phyloseq object into an R data frame
# Bind sample data to diversity data and Pielou's evenness
ps1.phageM.alpha <- as.tibble(cbind(sd_phageM, diversity_phageM)) # merge sd by row names
ps1.phageM.alpha$group <- factor(ps1.phageM.alpha$group, levels = c("GROUP 1", "GROUP 2", "GROUP 3", "GROUP 4", "GROUP 5", "GROUP 6", "GROUP 7", "GROUP 8"))

ps1.UG_phageM <- ps1.phageM.alpha %>% filter(sub_region == "UG") %>% group_by(visit_description) %>% mutate(group2 = 1:n())
ps1.UG_phageM

# Select diversity measures
alpha.div.meas.phage <- c("observed",
                          "diversity_shannon",
                          "evenness_pielou")
# Pivot to long form
alpha.UG_phageM <- ps1.UG_phageM %>%
  pivot_longer(cols = observed:evenness_pielou,
               names_to = "Alpha",
               values_to = "Value")
# Convert Alpha to factor
alpha.UG_phageM$Alpha <- as.factor(alpha.UG_phageM$Alpha)
alpha.UG_phageM.select <- alpha.UG_phageM %>%
  filter(Alpha %in% alpha.div.meas.phage) %>%
  mutate(Alpha=recode(Alpha, evenness_pielou = "Pielous Evenness",
                      observed = "Richness",
                      diversity_shannon = "Shannon Diversity")) %>%
  droplevels()
alpha.UG_phageM.select$Alpha <- factor(alpha.UG_phageM.select$Alpha, levels = c("Richness",
                                                                  "Shannon Diversity",
                                                                  "Pielous Evenness"))
# Stats
alpha.UG_phageM.select.wilcox <- alpha.UG_phageM.select %>%
  group_by(Alpha) %>%
  wilcox_test(Value ~ visit_description)
alpha.UG_phageM.select.wilcox

# Summary stats
alpha.UG_phageM.select %>%
  select(visit_description, Alpha, Value) %>%
  #filter(Alpha == "Richness") %>%
  group_by(visit_description, Alpha) %>%
  summarize(mean = mean(Value), stdev = sd(Value))

#######################
matchcolor <- c("V2 STOOL COLLECTION" ="#00A087B2", "V9 STOOL COLLECTION" = "#F39B7FB2")

richness_UG_phageM <- ggpaired(data = ps1.UG_phageM, x = "visit_description", y = "observed",id = "group2", color = "visit_description", point.size = 2.5,line.color = "gray", line.size = 0.4, palette = "jco")+
  stat_compare_means(comparisons = list(c("V2 STOOL COLLECTION", "V9 STOOL COLLECTION")), label = "p.signif", paired = TRUE, label.y = 130) +
  ylab("Phage Richness") +
  xlab(" ") +
  scale_color_manual(values=matchcolor)+
  scale_x_discrete(labels=c("V2 STOOL COLLECTION" = "Early", "V9 STOOL COLLECTION" = "Late")) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")

Shannon_UG_phageM <- ggpaired(data = ps1.UG_phageM, x = "visit_description", y = "diversity_shannon",id = "group2",
         color = "visit_description", point.size = 2.5,line.color = "gray", line.size = 0.4, palette = "jco")+
  stat_compare_means(comparisons = list(c("V2 STOOL COLLECTION", "V9 STOOL COLLECTION")), label = "p.signif", paired = TRUE, label.y = 4) +
  ylab("Phage Shannon Diversity") +
  xlab(" ") +
  scale_color_manual(values=matchcolor)+
  scale_x_discrete(labels=c("V2 STOOL COLLECTION" = "Early", "V9 STOOL COLLECTION" = "Late")) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")

####################
alphadiversity_UG_phageM <- ggarrange(richness_UG_phageM, Shannon_UG_phageM, ncol = 2)

# Create the title with centered alignment
title <- grid::textGrob("UG Samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Make the entire plot with the title on top
alphadiversity_UG_phageM <- plot_grid(
  title,  # Title grob at the top
  alphadiversity_UG_phageM,  # Your plot below
  ncol = 1,  # Stack vertically
  rel_heights = c(0.15, 1)  # Title takes 15% of the height
)

alphadiversity_UG_phageM

```

# Fig Supplemental 1C US Supplemental 1D UG Phage - Bray Distances
```{r Fig S1C, S1D}
#----- subset-physeq-by-sub-region -----#
physeqUS <- physeqCompleteSamples %>% 
  subset_samples(sub_region == "US") %>% 
  prune_taxa(taxa_sums(.) > 0, .)
physeqUS # 346 x 48

physeqUG <- physeqCompleteSamples %>% 
  subset_samples(sub_region == "UG") %>% 
  prune_taxa(taxa_sums(.) > 0, .)
physeqUG # 430 x 20
#----- subset-physeq-by-sub-region -----#

#----- calculate ordinations -----#
set.seed(17810968)
ordUG <- ordinate(physeqUG, method = "PCoA", distance = "bray")
ordUS <- ordinate(physeqUS, method = "PCoA", distance = "bray")

#----- calculate ADONIS p-values -----#
RunAdonis <- function(physeqObj, category, distance) {
  
  bdist <- phyloseq::distance(physeqObj, distance)
  col <- as(sample_data(physeqObj), "data.frame")[, category]
  
  # Adonis test
  adonis.bdist <- adonis2(bdist ~ col)
  return(adonis.bdist)
}
set.seed(17810968)

adonisUG <- RunAdonis(physeqUG, "visit_description", "bray") # p = 0.72
adonisUS <- RunAdonis(physeqUS, "visit_description", "bray") # p = 0.989

#----- plot ordinations -----#
PlotOrdinations <- function(physeqObj, ordObj, ordTitle, ordSubTitle, adonisP) {
  
  annotationP <- paste("ADONIS\n p =", adonisP, sep = " ")
  
  ordPlot <- plot_ordination(physeqObj, 
                             ordObj, 
                             color = "visit_description", 
                             axes = c(1, 2)) + 
  scale_color_jco()+
  geom_point(size = 3) +
  labs(title = ordTitle,
       subtitle = ordSubTitle, 
       color = "Sample Group") +
  stat_ellipse(type = "norm", linetype = 2) +
  scale_color_manual(label = c("V2 STOOL COLLECTION" ="Early vaccination", "V9 STOOL COLLECTION" = "Late vaccination"), values = matchcolor)+
  geom_hline(yintercept = 0, lty = 2, lwd = 0.1) +
  geom_vline(xintercept = 0, lty = 2, lwd = 0.1) +
  theme(legend.position="none",
        plot.subtitle = element_text(hjust = 0.5, face = "bold"))+
  annotate("text", x=0.5, y=-0.4, label = annotationP, col = "black")
  
}
brayPlotList <- pmap(.l = list(physeqObj = list(UG = physeqUG, 
                                                US = physeqUS),
                               ordObj = list(UG = ordUG,
                                             US = ordUS),
                               ordTitle = list(UG = "",
                                               US = ""),
                               ordSubTitle = list(UG = "", 
                                                  US = ""),
                               adonisP = list(UG = "0.72", 
                                              US = "0.99")),
                     .f = PlotOrdinations)

# Fig S1C US
ordinationPlots_US <- ggarrange( brayPlotList$US,
                               common.legend = TRUE, legend = "bottom")

# Create the title with centered alignment
title <- grid::textGrob("US Samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Make the entire plot with the title on top
ordinationPlots_US <- plot_grid(
  title,  # Title grob at the top
  ordinationPlots_US,  # Your plot below
  ncol = 1,  # Stack vertically
  rel_heights = c(0.15, 1)  # Title takes 15% of the height
)

ordinationPlots_US

# Fig S1D UG
ordinationPlots_UG <- ggarrange( brayPlotList$UG,
                               common.legend = TRUE, legend = "bottom")

# Create the title with centered alignment
title <- grid::textGrob("UG Samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Make the entire plot with the title on top
ordinationPlots_UG <- plot_grid(
  title,  # Title grob at the top
  ordinationPlots_UG,  # Your plot below
  ncol = 1,  # Stack vertically
  rel_heights = c(0.15, 1)  # Title takes 15% of the height
)

ordinationPlots_UG

```

# Fig Supplemental 2E
```{r Fig S2E}
# Make a boxplot of samples' richness and diversity, grouped by Site
# Diversity calculations
diversity_V2 <- as_tibble(microbiome::alpha(ps1_V2))
# ignore the warning message
diversity_V2

# Faith's phylogenetic diversity
library("btools")
v2.faiths <- ps1_V2 %>%
  estimate_pd() %>%
  select(-SR)

# Bind sample data to diversity data
sd_V2 <- as.tibble(sample_data(ps1_V2)) # useful to coerce the phyloseq object into an R data frame

# Bind sample data to diversity data and Pielou's evenness
ps1.v2.alpha <- as.tibble(cbind(sd_V2, diversity_V2, v2.faiths)) # merge sd by row names

ps1.v2.alpha$group <- factor(ps1.v2.alpha$group, levels = c("GROUP 1", "GROUP 2", "GROUP 3", "GROUP 4", "GROUP 5", "GROUP 6", "GROUP 7", "GROUP 8"))


ps1.v2.alpha <- ps1.v2.alpha %>% filter(sub_region != "UG") %>% filter(vaccine_group != "NA")

ps1.v2.alpha

# Select diversity measures
alpha.div.meas <- c("evenness_pielou",
                    "observed",
                    "PD")
# Pivot to long form
alpha.V2 <- ps1.v2.alpha %>%
  pivot_longer(cols = observed:PD,
               names_to = "Alpha",
               values_to = "Value")

# Convert Alpha to factor
alpha.V2$Alpha <- as.factor(alpha.V2$Alpha)

alpha.V2.select <- alpha.V2 %>%
  filter(Alpha %in% alpha.div.meas) %>%
  mutate(Alpha=recode(Alpha, evenness_pielou = "Pielous Evenness",
                      observed = "Richness",
                      PD = "Faith's PD")) %>%
  droplevels()
alpha.V2.select$Alpha <- factor(alpha.V2.select$Alpha, levels = c("Richness",
                                                                  "Faith's PD",
                                                                  "Pielous Evenness"))
# Stats
alpha.V2.select.wilcox <- alpha.V2.select %>%
  group_by(Alpha) %>%
  wilcox_test(Value ~ vaccine_group)
alpha.V2.select.wilcox

# Summary stats
alpha.V2.select %>%
  select(sub_region, Alpha, Value) %>%
  group_by(sub_region, Alpha) %>%
  summarize(mean = mean(Value), stdev = sd(Value))



#Plot
#########################
vaccinecolor <- c("placebo" ="#868686FF", "vaccine" = "#0073c2ff")

richnessPlot_vaccinegroup_Day_V2 <- ggplot(ps1.v2.alpha,
                       aes(x = vaccine_group, y = observed)) + ylim(0,500)+
                       geom_jitter(aes(color = vaccine_group), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = vaccine_group), fill = "gray80", alpha = 0.25, width = 0.4)+
  ylab("Bacterial Richness") +
  xlab(" ") +
    scale_x_discrete(labels=c("placebo" = "Placebo", "vaccine" = "Vaccine")) +
    facet_wrap(~sub_region) +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5, vjust = 1.5), legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    theme(plot.subtitle = element_text(size = 8))  +
  stat_compare_means(comparisons = list(c("placebo", "vaccine")), vjust = 0,label = "p.signif", label.y = 400, label.x = 1.5)+ scale_color_manual(values=vaccinecolor)
richnessPlot_vaccinegroup_Day_V2

FPD_Plot_vaccinegroup_Day_V2 <- ggplot(ps1.v2.alpha,
                       aes(x = vaccine_group, y = PD)) + ylim(0,70)+
                       geom_jitter(aes(color = vaccine_group), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = vaccine_group), fill = "gray80", alpha = 0.25, width = 0.4)+
                        ylab("Bacterial Faith's PD") +
                        xlab(" ") +
                        scale_x_discrete(labels=c("placebo" = "Placebo", "vaccine" = "Vaccine")) +
                        facet_wrap(~sub_region) +
                        theme_pubr() +
                        theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
                        theme(axis.text.x = element_text(angle = 45, hjust = 1))+
                        stat_compare_means(comparisons = list(c("placebo", "vaccine")), vjust = 0,label = "p.signif", label.y = 50, label.x = 1.5)+ scale_color_manual(values=vaccinecolor)
FPD_Plot_vaccinegroup_Day_V2



####################
alphadiversity_vaccinegroup_V2 <- ggarrange(richnessPlot_vaccinegroup_Day_V2, FPD_Plot_vaccinegroup_Day_V2, ncol = 2)
#alphadiversity_vaccinegroup_V2 <-  plot_grid(NULL, alphadiversity_vaccinegroup_V2, ncol = 1, rel_heights = c(0.1,1))
alphadiversity_vaccinegroup_V2<- annotate_figure(alphadiversity_vaccinegroup_V2,
               top = text_grob("Early Vaccination", face = "bold", size = 14))

alphadiversity_vaccinegroup_V2<- plot_grid(alphadiversity_vaccinegroup_V2, NULL,  rel_widths  = c(1,.1), ncol = 2)
alphadiversity_vaccinegroup_V2
```

# Fig Supplemental 2F
```{r Fig S2F}
# Make a boxplot of samples' richness and diversity, grouped by Site
# Diversity calculations
diversity_V9 <- as_tibble(microbiome::alpha(ps1_V9))
# ignore the warning message
diversity_V9

# Faith's phylogenetic diversity
library("btools")
v9.faiths <- ps1_V9 %>%
  estimate_pd() %>%
  select(-SR)

# Bind sample data to diversity data
sd_V9 <- as.tibble(sample_data(ps1_V9)) # useful to coerce the phyloseq object into an R data frame

# Bind sample data to diversity data and Pielou's evenness
ps1.v9.alpha <- as.tibble(cbind(sd_V9, diversity_V9, v9.faiths)) # merge sd by row names

ps1.v9.alpha$group <- factor(ps1.v9.alpha$group, levels = c("GROUP 1", "GROUP 2", "GROUP 3", "GROUP 4", "GROUP 5", "GROUP 6", "GROUP 7", "GROUP 8"))


ps1.v9.alpha.RWUS <- ps1.v9.alpha %>% filter(sub_region != "UG") %>% filter(vaccine_group != "NA")

# Select diversity measures
alpha.div.meas <- c("evenness_pielou",
                    "observed",
                    "PD")
# Pivot to long form
alpha.V9.RWUS <- ps1.v9.alpha.RWUS %>%
  pivot_longer(cols = observed:PD,
               names_to = "Alpha",
               values_to = "Value")

# Convert Alpha to factor
alpha.V9.RWUS$Alpha <- as.factor(alpha.V9.RWUS$Alpha)

alpha.V9.RWUS.select <- alpha.V9.RWUS %>%
  filter(Alpha %in% alpha.div.meas) %>%
  mutate(Alpha=recode(Alpha, evenness_pielou = "Pielous Evenness",
                      observed = "Richness",
                      PD = "Faith's PD")) %>%
  droplevels()
alpha.V9.RWUS.select$Alpha <- factor(alpha.V9.RWUS.select$Alpha, levels = c("Richness",
                                                                  "Faith's PD",
                                                                  "Pielous Evenness"))
# Stats
alpha.V9.RWUS.select.wilcox <- alpha.V9.RWUS.select %>%
  group_by(sub_region, Alpha) %>%
  wilcox_test(Value ~ vaccine_group)
alpha.V9.RWUS.select.wilcox

# Summary stats
alpha.V9.RWUS.select %>%
  select(sub_region, Alpha, Value) %>%
  group_by(sub_region, Alpha) %>%
  summarize(mean = mean(Value), stdev = sd(Value))

#Plot
#########################
vaccinecolor <- c("placebo" ="#868686FF", "vaccine" = "#0073c2ff")

richnessPlot_vaccinegroup_Day_V9 <- ggplot(ps1.v9.alpha.RWUS,
                       aes(x = vaccine_group, y = observed)) + ylim(0,500)+
                       geom_jitter(aes(color = vaccine_group), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = vaccine_group), fill = "gray80", alpha = 0.25, width = 0.4)+
  ylab("Bacterial Richness") +
  xlab(" ") +
    scale_x_discrete(labels=c("placebo" = "Placebo", "vaccine" = "Vaccine")) +
    facet_wrap(~sub_region) +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5, vjust = 1.5), legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    theme(plot.subtitle = element_text(size = 8))  +
  stat_compare_means(comparisons = list(c("placebo", "vaccine")), vjust = 0,label = "p.signif", label.x = 1.5)+ scale_color_manual(values=vaccinecolor)
richnessPlot_vaccinegroup_Day_V9

FPD_Plot_vaccinegroup_Day_V9 <- ggplot(ps1.v9.alpha.RWUS,
                       aes(x = vaccine_group, y = PD)) + ylim(0,70)+
                       geom_jitter(aes(color = vaccine_group), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = vaccine_group), fill = "gray80", alpha = 0.25, width = 0.4)+
                        ylab("Bacterial Faith's PD") +
                        xlab(" ") +
                        scale_x_discrete(labels=c("placebo" = "Placebo", "vaccine" = "Vaccine")) +
                        facet_wrap(~sub_region) +
                        theme_pubr() +
                        theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
                        theme(axis.text.x = element_text(angle = 45, hjust = 1))+
                        stat_compare_means(comparisons = list(c("placebo", "vaccine")), vjust = 0,label = "p.signif", label.y = 55, label.x = 1.5)+ scale_color_manual(values=vaccinecolor)
FPD_Plot_vaccinegroup_Day_V9


evenness_Plot_vaccinegroup_Day_V9 <- ggplot(ps1.v9.alpha.RWUS,
                       aes(x = vaccine_group, y = evenness_pielou)) + ylim(0,1.2)+
                       geom_jitter(aes(color = vaccine_group), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = vaccine_group), fill = "gray80", alpha = 0.25, width = 0.4)+
                        ylab("Bacterial Pielous evenness") +
                        xlab(" ") +
                        scale_x_discrete(labels=c("placebo" = "Placebo", "vaccine" = "Vaccine")) +
                        facet_wrap(~sub_region) +
                        theme_pubr() +
                        theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
                        theme(axis.text.x = element_text(angle = 45, hjust = 1))+
                        stat_compare_means(comparisons = list(c("placebo", "vaccine")), vjust = 0,label = "p.signif", label.y = 0.85, label.x = 1.5)+ scale_color_manual(values=vaccinecolor)
evenness_Plot_vaccinegroup_Day_V9

####################
alphadiversity_vaccinegroup_V9 <- ggarrange(richnessPlot_vaccinegroup_Day_V9, FPD_Plot_vaccinegroup_Day_V9, ncol = 2)
#alphadiversity_vaccinegroup_V2 <-  plot_grid(NULL, alphadiversity_vaccinegroup_V2, ncol = 1, rel_heights = c(0.1,1))
alphadiversity_vaccinegroup_V9<- annotate_figure(alphadiversity_vaccinegroup_V9,
               top = text_grob("Late Vaccination", face = "bold", size = 14))

alphadiversity_vaccinegroup_V9

```

# Fig Supplemental 2G
```{r Fig S2G}
# Subset group for beta-adonis
ps1_V2_US <- subset_samples(ps1_V2, sub_region == "US")
ps1_V2_UG <- subset_samples(ps1_V2, sub_region == "UG")

ord.pcoa.uni_V2_US <- ordinate(ps1_V2_US, method = "PCoA", distance = "unifrac")
evals.uni_V2_US <- ord.pcoa.uni_V2_US$values$Eigenvalues
ord.pcoa.wuni_V2_US <- ordinate(ps1_V2_US, method = "PCoA", distance = "wunifrac")
evals.wuni_V2_US <- ord.pcoa.wuni_V2_US$values$Eigenvalues

#{r beta-adonis,V2 US}
set.seed(46395617)
# Unifrac
bdist_unf_US <- phyloseq::distance(ps1_V2_US, "unifrac")
col_unf_US <- as(sample_data(ps1_V2_US), "data.frame")[, "vaccine_group"]
adonis.bdist_unf_US <- adonis2(bdist_unf_US ~ col_unf_US)
adonis.bdist_unf_US

# Weighted Unifrac
bdist_wunf_US <- phyloseq::distance(ps1_V2_US, "wunifrac")
col_wunf_US <- as(sample_data(ps1_V2_US), "data.frame")[, "vaccine_group"]
adonis.bdist_wunf_US <- adonis2(bdist_wunf_US ~ col_wunf_US)
adonis.bdist_wunf_US

## Ordination plots US samples

## V2-US Weighted Unifrac
p.pcoa.wuni.subregion_V2_US_vaccine <- plot_ordination(ps1_V2_US, ord.pcoa.wuni_V2_US, color = "vaccine_group", axes = c(1,2)) +
  geom_point(size = 3) +
  labs(title = " ",  subtitle = "US", color = "Vaccine Group") + 
  scale_color_hue(labels = c("Placebo", "Vaccine"))+
  stat_ellipse(type = "norm", linetype = 2) +
  scale_color_manual(label = c("placebo" ="Placebo", "vaccine" = "Vaccine"), values=vaccinecolor)+
  geom_hline(yintercept = 0, lty = 2, lwd = 0.1) +
  geom_vline(xintercept = 0, lty = 2, lwd = 0.1) +
  theme(legend.position="bottom",
        plot.subtitle = element_text(hjust = 0.5, face = "bold")) +  
  annotate("text", x=0.4, y=-0.2, label ="ADONIS\n p = 0.315", col = "black")
p.pcoa.wuni.subregion_V2_US_vaccine


b_diversity_vaccine.v2 <- plot_grid(p.pcoa.wuni.subregion_V2_US_vaccine, NULL,  rel_widths  = c(1,.1), ncol = 2)

b_diversity_vaccine.v2

```

# Fig Supplemental 2H
```{r Fig S2H}
# Subset group for beta-adonis
ps1_V9_RW <- subset_samples(ps1_V9, sub_region == "RW")

ps1_V9_US <- subset_samples(ps1_V9, sub_region == "US")

ps1_V9_UG <- subset_samples(ps1_V9, sub_region == "UG")

# beta-adonis,V9 RW
set.seed(46395617)

# Unifrac
bdist_unf_RW <- phyloseq::distance(ps1_V9_RW, "unifrac")
col_unf_RW <- as(sample_data(ps1_V9_RW), "data.frame")[, "vaccine_group"]
adonis.bdist_unf_RW <- adonis2(bdist_unf_RW ~ col_unf_RW)
adonis.bdist_unf_RW

# Weighted Unifrac
bdist_wunf_RW <- phyloseq::distance(ps1_V9_RW, "wunifrac")
col_wunf_RW <- as(sample_data(ps1_V9_RW), "data.frame")[, "vaccine_group"]
adonis.bdist_wunf_RW <- adonis2(bdist_wunf_RW ~ col_wunf_RW)
adonis.bdist_wunf_RW

# beta-adonis,V9 US
set.seed(46395617)
# Unifrac
bdist_unf_US <- phyloseq::distance(ps1_V9_US, "unifrac")
col_unf_US <- as(sample_data(ps1_V9_US), "data.frame")[, "vaccine_group"]
adonis.bdist_unf_US <- adonis2(bdist_unf_US ~ col_unf_US)
adonis.bdist_unf_US

# Weighted Unifrac
bdist_wunf_US <- phyloseq::distance(ps1_V9_US, "wunifrac")
col_wunf_US <- as(sample_data(ps1_V9_US), "data.frame")[, "vaccine_group"]
adonis.bdist_wunf_US <- adonis2(bdist_wunf_US ~ col_wunf_US)
adonis.bdist_wunf_US

# ordination
# Calculate ordinations
# make the ordination plots separately
ord.pcoa.uni_V9_RW <- ordinate(ps1_V9_RW, method = "PCoA", distance = "unifrac")
evals.uni_V9_RW <- ord.pcoa.uni_V9_RW$values$Eigenvalues
ord.pcoa.wuni_V9_RW <- ordinate(ps1_V9_RW, method = "PCoA", distance = "wunifrac")
evals.wuni_V9_RW <- ord.pcoa.wuni_V9_RW$values$Eigenvalues

ord.pcoa.uni_V9_US <- ordinate(ps1_V9_US, method = "PCoA", distance = "unifrac")
evals.uni_V9_US <- ord.pcoa.uni_V9_US$values$Eigenvalues
ord.pcoa.wuni_V9_US <- ordinate(ps1_V9_US, method = "PCoA", distance = "wunifrac")
evals.wuni_V9_US <- ord.pcoa.wuni_V9_US$values$Eigenvalues

# make the ordination plots separately 
## Ordination plots US samples
## V9-RW&US Weighted Unifrac
p.pcoa.wuni.subregion_V9_RW_vaccine <- plot_ordination(ps1_V9_RW, ord.pcoa.wuni_V9_RW, color = "vaccine_group", axes = c(1,2)) +
  geom_point(size = 3) +
  labs(title = " ", subtitle = "RW", color = "Vaccine Group") +
  scale_color_hue(labels = c("Placebo", "Vaccine"))+
  stat_ellipse(type = "norm", linetype = 2) +
  scale_color_manual(label = c("placebo" ="Placebo", "vaccine" = "Vaccine"), values=vaccinecolor)+
  geom_hline(yintercept = 0, lty = 2, lwd = 0.1) +
  geom_vline(xintercept = 0, lty = 2, lwd = 0.1) +
  theme(legend.position="bottom",
        plot.subtitle = element_text(hjust = 0.5, face = "bold")) +  
  annotate("text", x=0.35, y=-0.1, label ="ADONIS\n p = 0.683", col = "black")
p.pcoa.wuni.subregion_V9_RW_vaccine

p.pcoa.wuni.subregion_V9_US_vaccine <- plot_ordination(ps1_V9_US, ord.pcoa.wuni_V9_US, color = "vaccine_group", axes = c(1,2)) +
  geom_point(size = 3) +
  labs(title = " ", subtitle = "US", color = "Vaccine Group") +
  scale_color_hue(labels = c("Placebo", "Vaccine"))+
  stat_ellipse(type = "norm", linetype = 2) +
  scale_color_manual(label = c("placebo" ="Placebo", "vaccine" = "Vaccine"), values=vaccinecolor)+
  geom_hline(yintercept = 0, lty = 2, lwd = 0.1) +
  geom_vline(xintercept = 0, lty = 2, lwd = 0.1) +
  theme(legend.position="bottom",
        plot.subtitle = element_text(hjust = 0.5, face = "bold")) +  
  annotate("text", x=0.25, y=-0.1, label ="ADONIS\n p = 0.695", col = "black")
p.pcoa.wuni.subregion_V9_US_vaccine


b_diversity_vaccine.v9 <- plot_grid(p.pcoa.wuni.subregion_V9_RW_vaccine, p.pcoa.wuni.subregion_V9_US_vaccine,  rel_widths  = c(1,1), ncol = 2)

b_diversity_vaccine.v9

```

# Fig Supplemental 2I phage alpha diversity, early
```{r S2I}
# Make a boxplot of samples' richness and diversity, grouped by Site
# Diversity calculations
diversity_V2 <- as_tibble(microbiome::alpha(ps1_V2))

diversity_V2

# Faith's phylogenetic diversity
library("btools")
v2.faiths <- ps1_V2 %>%
  estimate_pd() %>%
  select(-SR)

# Bind sample data to diversity data
sd_V2 <- as.tibble(sample_data(ps1_V2)) # useful to coerce the phyloseq object into an R data frame

# Bind sample data to diversity data and Pielou's evenness
ps1.v2.alpha <- as.tibble(cbind(sd_V2, diversity_V2, v2.faiths)) # merge sd by row names

ps1.v2.alpha$group <- factor(ps1.v2.alpha$group, levels = c("GROUP 1", "GROUP 2", "GROUP 3", "GROUP 4", "GROUP 5", "GROUP 6", "GROUP 7", "GROUP 8"))


ps1.v2.alpha <- ps1.v2.alpha %>% filter(sub_region != "UG") %>% filter(vaccine_group != "NA")

ps1.v2.alpha

# Select diversity measures
alpha.div.meas <- c("evenness_pielou",
                    "observed",
                    "PD")
# Pivot to long form
alpha.V2 <- ps1.v2.alpha %>%
  pivot_longer(cols = observed:PD,
               names_to = "Alpha",
               values_to = "Value")

# Convert Alpha to factor
alpha.V2$Alpha <- as.factor(alpha.V2$Alpha)

alpha.V2.select <- alpha.V2 %>%
  filter(Alpha %in% alpha.div.meas) %>%
  mutate(Alpha=recode(Alpha, evenness_pielou = "Pielous Evenness",
                      observed = "Richness",
                      PD = "Faith's PD")) %>%
  droplevels()
alpha.V2.select$Alpha <- factor(alpha.V2.select$Alpha, levels = c("Richness",
                                                                  "Faith's PD",
                                                                  "Pielous Evenness"))
# Stats
alpha.V2.select.wilcox <- alpha.V2.select %>%
  group_by(Alpha) %>%
  wilcox_test(Value ~ vaccine_group)
alpha.V2.select.wilcox

# Summary stats
alpha.V2.select %>%
  select(sub_region, Alpha, Value) %>%
  group_by(sub_region, Alpha) %>%
  summarize(mean = mean(Value), stdev = sd(Value))

#Plot
#########################
vaccinecolor <- c("placebo" ="#868686FF", "vaccine" = "#0073c2ff")

richnessPlot_vaccinegroup_Day_V2 <- ggplot(ps1.v2.alpha,
                       aes(x = vaccine_group, y = observed)) + ylim(0,500)+
                       geom_jitter(aes(color = vaccine_group), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = vaccine_group), fill = "gray80", alpha = 0.25, width = 0.4)+
  ylab("Bacterial Richness") +
  xlab(" ") +
    scale_x_discrete(labels=c("placebo" = "Placebo", "vaccine" = "Vaccine")) +
    facet_wrap(~sub_region) +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5, vjust = 1.5), legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    theme(plot.subtitle = element_text(size = 8))  +
  stat_compare_means(comparisons = list(c("placebo", "vaccine")), vjust = 0,label = "p.signif", label.y = 400, label.x = 1.5)+ scale_color_manual(values=vaccinecolor)
richnessPlot_vaccinegroup_Day_V2

FPD_Plot_vaccinegroup_Day_V2 <- ggplot(ps1.v2.alpha,
                       aes(x = vaccine_group, y = PD)) + ylim(0,70)+
                       geom_jitter(aes(color = vaccine_group), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = vaccine_group), fill = "gray80", alpha = 0.25, width = 0.4)+
                        ylab("Bacterial Faith's PD") +
                        xlab(" ") +
                        scale_x_discrete(labels=c("placebo" = "Placebo", "vaccine" = "Vaccine")) +
                        facet_wrap(~sub_region) +
                        theme_pubr() +
                        theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
                        theme(axis.text.x = element_text(angle = 45, hjust = 1))+
                        stat_compare_means(comparisons = list(c("placebo", "vaccine")), vjust = 0,label = "p.signif", label.y = 50, label.x = 1.5)+ scale_color_manual(values=vaccinecolor)
FPD_Plot_vaccinegroup_Day_V2


####################
phage_alphadiversity_vaccinegroup_V2 <- ggarrange(richnessPlot_vaccinegroup_Day_V2, FPD_Plot_vaccinegroup_Day_V2, ncol = 2)

title <- grid::textGrob("Early vaccination samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Make the entire plot with the title on top
phage_alphadiversity_vaccinegroup_V2 <- plot_grid(
  title,  # Title grob at the top
  phage_alphadiversity_vaccinegroup_V2,  # Your plot below
  ncol = 1,  # Stack vertically
  rel_heights = c(0.15, 1)  # Title takes 15% of the height
)

phage_alphadiversity_vaccinegroup_V2

```

# Fig Supplemental SJ phage alpha diversity, late
```{r Fig 2SJ}
# Make a boxplot of samples' richness and diversity, grouped by Site
# Diversity calculations
diversity_V9 <- as_tibble(microbiome::alpha(ps1_V9))

diversity_V9

# Faith's phylogenetic diversity
library("btools")
v9.faiths <- ps1_V9 %>%
  estimate_pd() %>%
  select(-SR)

# Bind sample data to diversity data
sd_V9 <- as.tibble(sample_data(ps1_V9)) # useful to coerce the phyloseq object into an R data frame

# Bind sample data to diversity data and Pielou's evenness
ps1.v9.alpha <- as.tibble(cbind(sd_V9, diversity_V9, v9.faiths)) # merge sd by row names

ps1.v9.alpha$group <- factor(ps1.v9.alpha$group, levels = c("GROUP 1", "GROUP 2", "GROUP 3", "GROUP 4", "GROUP 5", "GROUP 6", "GROUP 7", "GROUP 8"))


ps1.v9.alpha.RWUS <- ps1.v9.alpha %>% filter(sub_region != "UG") %>% filter(vaccine_group != "NA")

ps1.v9.alpha

# Select diversity measures
alpha.div.meas <- c("evenness_pielou",
                    "observed",
                    "PD")
# Pivot to long form
alpha.V9.RWUS <- ps1.v9.alpha.RWUS %>%
  pivot_longer(cols = observed:PD,
               names_to = "Alpha",
               values_to = "Value")

# Convert Alpha to factor
alpha.V9.RWUS$Alpha <- as.factor(alpha.V9.RWUS$Alpha)

alpha.V9.RWUS.select <- alpha.V9.RWUS %>%
  filter(Alpha %in% alpha.div.meas) %>%
  mutate(Alpha=recode(Alpha, evenness_pielou = "Pielous Evenness",
                      observed = "Richness",
                      PD = "Faith's PD")) %>%
  droplevels()
alpha.V9.RWUS.select$Alpha <- factor(alpha.V9.RWUS.select$Alpha, levels = c("Richness",
                                                                  "Faith's PD",
                                                                  "Pielous Evenness"))
# Stats
alpha.V9.RWUS.select.wilcox <- alpha.V9.RWUS.select %>%
  group_by(sub_region, Alpha) %>%
  wilcox_test(Value ~ vaccine_group)
alpha.V9.RWUS.select.wilcox

# Summary stats
alpha.V9.RWUS.select %>%
  select(sub_region, Alpha, Value) %>%
  group_by(sub_region, Alpha) %>%
  summarize(mean = mean(Value), stdev = sd(Value))

#Plot
#########################
vaccinecolor <- c("placebo" ="#868686FF", "vaccine" = "#0073c2ff")

richnessPlot_vaccinegroup_Day_V9 <- ggplot(ps1.v9.alpha.RWUS,
                       aes(x = vaccine_group, y = observed)) + ylim(0,500)+
                       geom_jitter(aes(color = vaccine_group), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = vaccine_group), fill = "gray80", alpha = 0.25, width = 0.4)+
  ylab("Bacterial Richness") +
  xlab(" ") +
    scale_x_discrete(labels=c("placebo" = "Placebo", "vaccine" = "Vaccine")) +
    facet_wrap(~sub_region) +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5, vjust = 1.5), legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    theme(plot.subtitle = element_text(size = 8))  +
  stat_compare_means(comparisons = list(c("placebo", "vaccine")), vjust = 0,label = "p.signif", label.x = 1.5)+ scale_color_manual(values=vaccinecolor)
richnessPlot_vaccinegroup_Day_V9

FPD_Plot_vaccinegroup_Day_V9 <- ggplot(ps1.v9.alpha.RWUS,
                       aes(x = vaccine_group, y = PD)) + ylim(0,70)+
                       geom_jitter(aes(color = vaccine_group), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = vaccine_group), fill = "gray80", alpha = 0.25, width = 0.4)+
                        ylab("Bacterial Faith's PD") +
                        xlab(" ") +
                        scale_x_discrete(labels=c("placebo" = "Placebo", "vaccine" = "Vaccine")) +
                        facet_wrap(~sub_region) +
                        theme_pubr() +
                        theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
                        theme(axis.text.x = element_text(angle = 45, hjust = 1))+
                        stat_compare_means(comparisons = list(c("placebo", "vaccine")), vjust = 0,label = "p.signif", label.y = 55, label.x = 1.5)+ scale_color_manual(values=vaccinecolor)
FPD_Plot_vaccinegroup_Day_V9

####################
phage_alphadiversity_vaccinegroup_V9 <- ggarrange(richnessPlot_vaccinegroup_Day_V9, FPD_Plot_vaccinegroup_Day_V9, ncol = 2)

title <- grid::textGrob("Late vaccination samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Make the entire plot with the title on top
phage_alphadiversity_vaccinegroup_V9 <- plot_grid(
  title,  # Title grob at the top
  phage_alphadiversity_vaccinegroup_V9,  # Your plot below
  ncol = 1,  # Stack vertically
  rel_heights = c(0.15, 1)  # Title takes 15% of the height
)

phage_alphadiversity_vaccinegroup_V9

```

# Fig Supplemental 2K phage beta diversity, early
```{r Fig S2K}
# Subset group for beta-adonis
ps1_V2_US <- subset_samples(ps1_V2, sub_region == "US")
ps1_V2_UG <- subset_samples(ps1_V2, sub_region == "UG")

ord.pcoa.uni_V2_US <- ordinate(ps1_V2_US, method = "PCoA", distance = "unifrac")
evals.uni_V2_US <- ord.pcoa.uni_V2_US$values$Eigenvalues
ord.pcoa.wuni_V2_US <- ordinate(ps1_V2_US, method = "PCoA", distance = "wunifrac")
evals.wuni_V2_US <- ord.pcoa.wuni_V2_US$values$Eigenvalues

#{r beta-adonis,V2 US}
set.seed(46395617)
# Unifrac
bdist_unf_US <- phyloseq::distance(ps1_V2_US, "unifrac")
col_unf_US <- as(sample_data(ps1_V2_US), "data.frame")[, "vaccine_group"]
adonis.bdist_unf_US <- adonis2(bdist_unf_US ~ col_unf_US)
adonis.bdist_unf_US

# Weighted Unifrac
bdist_wunf_US <- phyloseq::distance(ps1_V2_US, "wunifrac")
col_wunf_US <- as(sample_data(ps1_V2_US), "data.frame")[, "vaccine_group"]
adonis.bdist_wunf_US <- adonis2(bdist_wunf_US ~ col_wunf_US)
adonis.bdist_wunf_US

# Ordination plots US samples
## V2-US Weighted Unifrac
p.pcoa.wuni.subregion_V2_US_vaccine <- plot_ordination(ps1_V2_US, ord.pcoa.wuni_V2_US, color = "vaccine_group", axes = c(1,2)) +
  geom_point(size = 3) +
  labs(title = " ",  subtitle = "US", color = "Vaccine Group") + 
  scale_color_hue(labels = c("Placebo", "Vaccine"))+
  stat_ellipse(type = "norm", linetype = 2) +
  scale_color_manual(label = c("placebo" ="Placebo", "vaccine" = "Vaccine"), values=vaccinecolor)+
  geom_hline(yintercept = 0, lty = 2, lwd = 0.1) +
  geom_vline(xintercept = 0, lty = 2, lwd = 0.1) +
  theme(legend.position="bottom",
        plot.subtitle = element_text(hjust = 0.5, face = "bold")) +  
  annotate("text", x=0.3, y=-0.1, label ="ADONIS\n p = 0.315", col = "black")
p.pcoa.wuni.subregion_V2_US_vaccine


phage_b_diversity_vaccine.v2 <- plot_grid(p.pcoa.wuni.subregion_V2_US_vaccine)

title <- grid::textGrob("Early vaccination samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Make the entire plot with the title on top
phage_b_diversity_vaccine.v2 <- plot_grid(
  title,  # Title grob at the top
  phage_b_diversity_vaccine.v2,  # Your plot below
  ncol = 1,  # Stack vertically
  rel_heights = c(0.15, 1)  # Title takes 15% of the height
)

phage_b_diversity_vaccine.v2

```

# Fig Supplemental 2L phage beta diversity, late
```{r Fig S2L}
# Subset group for beta-adonis
ps1_V9_RW <- subset_samples(ps1_V9, sub_region == "RW")

ps1_V9_US <- subset_samples(ps1_V9, sub_region == "US")

ps1_V9_UG <- subset_samples(ps1_V9, sub_region == "UG")

# beta-adonis,V9 RW
set.seed(46395617)

# Unifrac
bdist_unf_RW <- phyloseq::distance(ps1_V9_RW, "unifrac")
col_unf_RW <- as(sample_data(ps1_V9_RW), "data.frame")[, "vaccine_group"]
adonis.bdist_unf_RW <- adonis2(bdist_unf_RW ~ col_unf_RW)
adonis.bdist_unf_RW

# Weighted Unifrac
bdist_wunf_RW <- phyloseq::distance(ps1_V9_RW, "wunifrac")
col_wunf_RW <- as(sample_data(ps1_V9_RW), "data.frame")[, "vaccine_group"]
adonis.bdist_wunf_RW <- adonis2(bdist_wunf_RW ~ col_wunf_RW)
adonis.bdist_wunf_RW

# beta-adonis,V9 US
set.seed(46395617)

# Unifrac
bdist_unf_US <- phyloseq::distance(ps1_V9_US, "unifrac")
col_unf_US <- as(sample_data(ps1_V9_US), "data.frame")[, "vaccine_group"]
adonis.bdist_unf_US <- adonis2(bdist_unf_US ~ col_unf_US)
adonis.bdist_unf_US

# Weighted Unifrac
bdist_wunf_US <- phyloseq::distance(ps1_V9_US, "wunifrac")
col_wunf_US <- as(sample_data(ps1_V9_US), "data.frame")[, "vaccine_group"]
adonis.bdist_wunf_US <- adonis2(bdist_wunf_US ~ col_wunf_US)
adonis.bdist_wunf_US

# ordination
# Calculate ordinations
# make the ordination plots separately

ord.pcoa.uni_V9_RW <- ordinate(ps1_V9_RW, method = "PCoA", distance = "unifrac")
evals.uni_V9_RW <- ord.pcoa.uni_V9_RW$values$Eigenvalues
ord.pcoa.wuni_V9_RW <- ordinate(ps1_V9_RW, method = "PCoA", distance = "wunifrac")
evals.wuni_V9_RW <- ord.pcoa.wuni_V9_RW$values$Eigenvalues

ord.pcoa.uni_V9_US <- ordinate(ps1_V9_US, method = "PCoA", distance = "unifrac")
evals.uni_V9_US <- ord.pcoa.uni_V9_US$values$Eigenvalues
ord.pcoa.wuni_V9_US <- ordinate(ps1_V9_US, method = "PCoA", distance = "wunifrac")
evals.wuni_V9_US <- ord.pcoa.wuni_V9_US$values$Eigenvalues

# make the ordination plots separately 
## Ordination plots US samples
## V9-RW&US Weighted Unifrac
p.pcoa.wuni.subregion_V9_RW_vaccine <- plot_ordination(ps1_V9_RW, ord.pcoa.wuni_V9_RW, color = "vaccine_group", axes = c(1,2)) +
  geom_point(size = 3) +
  labs(title = " ", subtitle = "RW", color = "Vaccine Group") +
  scale_color_hue(labels = c("Placebo", "Vaccine"))+
  stat_ellipse(type = "norm", linetype = 2) +
  scale_color_manual(label = c("placebo" ="Placebo", "vaccine" = "Vaccine"), values=vaccinecolor)+
  geom_hline(yintercept = 0, lty = 2, lwd = 0.1) +
  geom_vline(xintercept = 0, lty = 2, lwd = 0.1) +
  theme(legend.position="bottom",
        plot.subtitle = element_text(hjust = 0.5, face = "bold")) +  
  annotate("text", x=0.35, y=-0.1, label ="ADONIS\n p = 0.683", col = "black")
p.pcoa.wuni.subregion_V9_RW_vaccine

p.pcoa.wuni.subregion_V9_US_vaccine <- plot_ordination(ps1_V9_US, ord.pcoa.wuni_V9_US, color = "vaccine_group", axes = c(1,2)) +
  geom_point(size = 3) +
  labs(title = " ", subtitle = "US", color = "Vaccine Group") +
  scale_color_hue(labels = c("Placebo", "Vaccine"))+
  stat_ellipse(type = "norm", linetype = 2) +
  scale_color_manual(label = c("placebo" ="Placebo", "vaccine" = "Vaccine"), values=vaccinecolor)+
  geom_hline(yintercept = 0, lty = 2, lwd = 0.1) +
  geom_vline(xintercept = 0, lty = 2, lwd = 0.1) +
  theme(legend.position="bottom",
        plot.subtitle = element_text(hjust = 0.5, face = "bold")) +  
  annotate("text", x=0.2, y=-0.1, label ="ADONIS\n p = 0.695", col = "black")
p.pcoa.wuni.subregion_V9_US_vaccine


phage_b_diversity_vaccine.v9 <- plot_grid(p.pcoa.wuni.subregion_V9_RW_vaccine, p.pcoa.wuni.subregion_V9_US_vaccine,  rel_widths  = c(1,1), ncol = 2)
title <- grid::textGrob("Late vaccination samples", gp = grid::gpar(fontsize = 16, fontface = "bold"))

# Make the entire plot with the title on top
phage_b_diversity_vaccine.v9 <- plot_grid(
  title,  # Title grob at the top
  phage_b_diversity_vaccine.v9,  # Your plot below
  ncol = 1,  # Stack vertically
  rel_heights = c(0.15, 1)  # Title takes 15% of the height
)

phage_b_diversity_vaccine.v9

```

# Final Supplemental Figure 2
```{r figure S2}
# First row with A and C
first_row <- plot_grid(
  alphadiversity_US_phageM, ordinationPlots_US,
  ncol = 2,
  rel_widths = c(1, 1),
  labels = c("A.","C."),
  label_size = 16,
  label_fontface = "bold",
  align = "h"
)

# 2nd row with B and D
second_row <- plot_grid(
  alphadiversity_UG_phageM, ordinationPlots_UG,
  ncol = 2,
  rel_widths = c(1, 1),
  labels = c("B.", "D."),
  label_size = 16,
  label_fontface = "bold",
  align = "h"
)

# 3rd row with E and G
third_row <- plot_grid(
  alphadiversity_vaccinegroup_V2, b_diversity_vaccine.v2,
  ncol = 2,
  rel_widths = c(1, 1),
  labels = c("E.","G."),
  label_size = 16,
  label_fontface = "bold",
  align = "h"
)

# 4th row with F and H
fourth_row <- plot_grid(
  alphadiversity_vaccinegroup_V9, b_diversity_vaccine.v9,
  ncol = 2,
  rel_widths = c(1, 1),
  labels = c("F.", "H."),
  label_size = 16,
  label_fontface = "bold",
  align = "h"
)

# 5th row with I and K
fifth_row <- plot_grid(
  phage_alphadiversity_vaccinegroup_V2, phage_b_diversity_vaccine.v2,
  ncol = 2,
  rel_widths = c(1, 1),
  labels = c("I.","K."),
  label_size = 16,
  label_fontface = "bold",
  align = "h"
)

# 6th row with J and L
sixth_row <- plot_grid(
  phage_alphadiversity_vaccinegroup_V9, phage_b_diversity_vaccine.v9,
  ncol = 2,
  rel_widths = c(1, 1),
  labels = c("J.", "L."),
  label_size = 16,
  label_fontface = "bold",
  align = "h"
)

# Try combining two rows first
top_third <- plot_grid(
  first_row,
  second_row,
  ncol = 1
)

# Then add more rows
middle_third <- plot_grid(
  third_row,
  fourth_row,
  ncol = 1
)

# Then the bottom
bottom_third <- plot_grid(
  fifth_row,
  sixth_row,
  ncol = 1
)

# Create the combined figure with the legend at the bottom
S2_final_figure <- plot_grid(
  top_third,
  middle_third,
  bottom_third,
  ncol = 1
)

# Save the combined figure
ggsave("./figures/Supplemental_Figure_2.tiff", 
       S2_final_figure, 
       width = 16, 
       height = 24,  # Increased height to accommodate all panels
       dpi = 300, 
       compression = "lzw",
       bg = "white")
```

# Fig 3A Late post-vaccination RW vs US vs UG phylum relative abundance
```{r Fig 3A}
threshold = 0.01
ps1.phylum_V9 <- ps1_V9 %>%
  tax_glom(taxrank = "Phylum") %>%
  transform_sample_counts(function(x) {x/sum(x)} ) %>%
  psmelt %>%
  filter(Abundance > threshold) %>%
  arrange(Phylum, Abundance)

Phylumcolor<-c("Fusobacteriota"="#4575B4",
               "Actinomycetota"= "#74ADD1",
               "Pseudomonadota"="#ABD9E9", 
               "Elusimicrobiota" = "#E0F3F8",
               "Verrucomicrobiota"="#FFFFBF",
               "Spirochaetota"="#FEE090", 
               "Bacteroidota"= "#F46D43",
               "Bacillota"= "#D73027")

# New facet label names for sub_region variable
subregion.labs <- c("RW", "US", "UG")
names(subregion.labs) <- c("Rwanda", "US", "Uganda")

# Create the plots
p.cc.region_V9 <- ggplot(ps1.phylum_V9, aes(x = as.factor(sample_id), y = Abundance, fill = fct_reorder(Phylum, Abundance))) +
  geom_bar(stat = "identity", width = 1) +
  facet_grid(~sub_region, scales = "free", space = "free", labeller = labeller(sub_region = subregion.labs)) +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
  scale_fill_manual(values = Phylumcolor)+
  theme(axis.text.x = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(legend.position="right") +
  labs(fill = "Phylum")
 
p.cc.region_V9

```

# Fig 3B: Alpha-diversity analysis in V9 stool samples RW and US
```{r Fig 3B}
# Diversity calculations
diversity_V9 <- as_tibble(microbiome::alpha(ps1_V9))

diversity_V9

# Faith's phylogenetic diversity
library("btools")
v9.faiths <- ps1_V9 %>%
  estimate_pd() %>%
  select(-SR)

# Bind sample data to diversity data
sd_V9 <- as.tibble(sample_data(ps1_V9)) # useful to coerce the phyloseq object into an R data frame

# Bind sample data to diversity data and Pielou's evenness
ps1.v9.alpha <- as.tibble(cbind(sd_V9, diversity_V9, v9.faiths)) # merge sd by row names

ps1.v9.alpha$group <- factor(ps1.v9.alpha$group, levels = c("GROUP 1", "GROUP 2", "GROUP 3", "GROUP 4", "GROUP 5", "GROUP 6", "GROUP 7", "GROUP 8"))

ps1.v9.alpha

# Select diversity measures
alpha.div.meas <- c("evenness_pielou",
                    "observed",
                    "PD")
# Pivot to long form
alpha.V9 <- ps1.v9.alpha %>%
  pivot_longer(cols = observed:PD,
               names_to = "Alpha",
               values_to = "Value")

# Convert Alpha to factor
alpha.V9$Alpha <- as.factor(alpha.V9$Alpha)

alpha.V9.select <- alpha.V9 %>%
  filter(Alpha %in% alpha.div.meas) %>%
  mutate(Alpha=recode(Alpha, evenness_pielou = "Pielous Evenness",
                      observed = "Richness",
                      PD = "Faith's PD")) %>%
  droplevels()
alpha.V9.select$Alpha <- factor(alpha.V9.select$Alpha, levels = c("Richness",
                                                                  "Faith's PD",
                                                                  "Pielous Evenness"))
# Stats
# kruskal-dunn_test
alpha.V9.select.kruskal_test <- alpha.V9.select %>%
  group_by(Alpha) %>%
  kruskal_test(Value ~ sub_region)
alpha.V9.select.kruskal_test

pwc_ALL_Day_V9_region <- alpha.V9.select  %>% group_by(Alpha) %>%
  dunn_test(Value ~ sub_region, p.adjust.method = "BH") 

#pwc_ALL_Day_V9_region  <- pwc_ALL_Day_V9_region %>% add_xy_position(x = "sub_region")
pwc_ALL_Day_V9_region

pwc_richness_Day_V9_region <- pwc_ALL_Day_V9_region %>% filter(Alpha == "Richness")
pwc_FPD_Day_V9_region <- pwc_ALL_Day_V9_region %>% filter(Alpha == "Faith's PD")

# Summary stats
alpha.V9.select %>%
  select(sub_region, Alpha, Value) %>%
  group_by(sub_region, Alpha) %>%
  summarize(mean = mean(Value), stdev = sd(Value))

#######################
regioncolor <- c("UG" ="#00468BFF", "RW" = "#42B540FF", "US" = "#ED0000FF")

richnessPlot_Day_V9_ALL <- ggplot(ps1.v9.alpha,
                       aes(x = sub_region, y = observed)) + ylim(0,600)+
                       scale_color_manual(values=regioncolor)+
                       geom_jitter(aes(color = sub_region), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = sub_region), fill = "gray80", alpha = 0.25, width = 0.4)+
  ylab("Bacterial Richness") +
  xlab(" ") +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5, vjust = 1.5), legend.position = "none")+
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))+
    theme(plot.subtitle = element_text(size = 8))  +
  stat_pvalue_manual(pwc_richness_Day_V9_region, vjust = 0,label = "p.adj.signif",y.position = c(480, 580, 530))
richnessPlot_Day_V9_ALL

FPD_Plot_Day_V9_ALL <- ggplot(ps1.v9.alpha,
                       aes(x = sub_region, y = PD)) +
                       scale_color_manual(values=regioncolor)+
                       geom_jitter(aes(color = sub_region), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = sub_region), fill = "gray80", alpha = 0.25, width = 0.4)+
                        ylab("Bacterial Faith's PD") +
                        xlab(" ") +
                        theme_pubr() +
                        theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
                        theme(axis.text.x = element_text(angle = 0, hjust = 0.5))+
                        stat_pvalue_manual(pwc_FPD_Day_V9_region, vjust = 0,label = "p.adj.signif", y.position = c(52, 62, 57), label.x = 1.5)
FPD_Plot_Day_V9_ALL


####################
alphadiversity_V9 <- ggarrange(richnessPlot_Day_V9_ALL, FPD_Plot_Day_V9_ALL, ncol = 2)
alphadiversity_V9 <-  plot_grid(NULL, alphadiversity_V9, ncol = 1, rel_heights = c(0.1,1))
alphadiversity_V9

```

# Fig 3C beta diversity bacteria
```{r Fig 3C}
# V9_prev
set.seed(46395617)
# Unifrac
bdist_unf_V9_prev <- phyloseq::distance(ps1_V9_prev, "unifrac")
col_unf_V9_prev <- as(sample_data(ps1_V9_prev), "data.frame")[, "sub_region"]
adonis.bdist_unf_V9_prev <- adonis2(bdist_unf_V9_prev ~ col_unf_V9_prev)
adonis.bdist_unf_V9_prev

# Weighted Unifrac
bdist_wunf_V9_prev<- phyloseq::distance(ps1_V9_prev, "wunifrac")
col_wunf_V9_prev<- as(sample_data(ps1_V9_prev), "data.frame")[, "sub_region"]
adonis.bdist_wunf_V9_prev<- adonis2(bdist_wunf_V9_prev ~ col_wunf_V9_prev)
adonis.bdist_wunf_V9_prev

# Calculate total ordinations
ord.pcoa.uni_V9_prev<- ordinate(ps1_V9_prev, method = "PCoA", distance = "unifrac")
evals.uni_V9_prev<- ord.pcoa.uni_V9_prev$values$Eigenvalues
ord.pcoa.wuni_V9_prev<- ordinate(ps1_V9_prev, method = "PCoA", distance = "wunifrac")
evals.wuni_V9_prev<- ord.pcoa.wuni_V9_prev$values$Eigenvalues

# Define your groups
groups <- unique(col_wunf_V9_prev)  # e.g., US, UG, RW

# Create a function for pairwise PERMANOVA
pairwise_permanova <- function(dist_matrix, groups_vector) {
  # Convert to character to avoid factor issues
  groups_vector <- as.character(groups_vector)
  
  # Create an empty matrix to store results
  group_levels <- unique(groups_vector)
  n_groups <- length(group_levels)
  result_matrix <- matrix(NA, nrow=n_groups, ncol=n_groups)
  rownames(result_matrix) <- group_levels
  colnames(result_matrix) <- group_levels
  
  # Run pairwise tests
  for (i in 1:(n_groups-1)) {
    for (j in (i+1):n_groups) {
      # Select samples from the two groups
      group1 <- group_levels[i]
      group2 <- group_levels[j]
      idx <- groups_vector %in% c(group1, group2)
      
      if (sum(idx) > 0) {  # Ensure we have samples
        sub_dist <- as.dist(as.matrix(dist_matrix)[idx, idx])
        sub_groups <- groups_vector[idx]
        
        # Run PERMANOVA
        set.seed(123)  # For reproducibility
        perm_result <- adonis2(sub_dist ~ sub_groups)
        
        # Store p-value
        result_matrix[i,j] <- perm_result$`Pr(>F)`[1]
        result_matrix[j,i] <- result_matrix[i,j]  # Mirror the matrix
      }
    }
  }
  
  return(result_matrix)
}

pairwise_results <- pairwise_permanova(bdist_wunf_V9_prev, col_wunf_V9_prev)

# Apply correction for multiple testing
library(reshape2)
p_values <- melt(pairwise_results)
p_values <- p_values[!is.na(p_values$value), ]  # Remove NA values
p_values$adjusted <- p.adjust(p_values$value, method = "bonferroni")

# Print results in a nice format
colnames(p_values) <- c("Group1", "Group2", "p_value", "p_adjusted")
p_values <- p_values[p_values$Group1 != p_values$Group2, ]  # Remove self-comparisons
p_values$pair <- apply(p_values[, c("Group1", "Group2")], 1, function(x) {
  paste(sort(x), collapse="-")
})
p_values <- p_values[!duplicated(p_values$pair), ]
p_values$pair <- NULL
print(p_values)
#   Group1 Group2 p_value p_adjusted
# 2     RW     US   0.001      0.006
# 3     UG     US   0.001      0.006
# 6     UG     RW   0.003      0.018

# Ordination plots all samples
regioncolor <- c("UG" ="#00468BFF", "RW" = "#42B540FF", "US" = "#ED0000FF")

# Weighted Unifrac
p.pcoa.wuni.region_V9_prev <- plot_ordination(ps1_V9_prev, ord.pcoa.wuni_V9_prev, color = "sub_region", axes = c(1,2)) +
  theme_bw() +
  scale_color_manual(values=regioncolor)+
  geom_point(size = 3) +
  labs(title = "", color = "Geographic Region") +
  stat_ellipse(type = "norm", linetype = 2) + 
  annotate("text", x=0.34, y=0.20, label ="ADONIS\nRW - UG p = 0.003\nRW - US p = 0.001\nUS - UG p = 0.001\n", col = "black")+ 
  theme(legend.position="bottom")

p.pcoa.wuni.region_V9_prev
```

# Fig 3D Phage Beta Diversity by Location
```{r Fig 3D}
# Subset physeqPhage by visit_description
physeqPhageV2 <- physeqPhage %>% 
    subset_samples(visit_description == "V2 STOOL COLLECTION") %>% 
    RemoveMissingTaxa()
physeqPhageV2 # 527 x 45

physeqPhageV9 <- physeqPhage %>% 
    subset_samples(visit_description == "V9 STOOL COLLECTION") %>% 
    RemoveMissingTaxa()
physeqPhageV9 # 672 x 102

physeqSubsetList <- list("V2" = physeqPhageV2, "V9" = physeqPhageV9)

# Get pairwise p-values
set.seed(39731037)
RunAdonis(physeqSubsetList$V9, "location", "bray") # 0.002

# Calculate p-values for distances b/w each location
# Rwanda vs. Uganda
physeqV9RwandaUganda <- subset_samples(physeqSubsetList$V9, 
                                       location %in% c("Rwanda", "Uganda")) %>% 
    RemoveMissingTaxa()
set.seed(39731037)
adonisRwandaUganda <- RunAdonis(physeqV9RwandaUganda, "location", "bray") # 0.012

# Rwanda vs. US
physeqV9RwandaUS <- subset_samples(physeqSubsetList$V9,
                                   location %in% c("Rwanda", "US")) %>% 
    RemoveMissingTaxa()
set.seed(39731037)
adonisRwandaUS <- RunAdonis(physeqV9RwandaUS, "location", "bray") # 0.001

# Uganda vs. US
physeqV9UgandaUS <- subset_samples(physeqSubsetList$V9,
                                   location %in% c("Uganda", "US")) %>% 
    RemoveMissingTaxa()
set.seed(39731037)
adonisUgandaUS <- RunAdonis(physeqV9UgandaUS, "location", "bray") # 0.001

########################

ordinationV9 <- ordinate(physeqSubsetList$V9, method = "MDS", 
                         distance = "bray")

regioncolor <- c("Uganda" ="#00468BFF", "Rwanda" = "#42B540FF", "US" = "#ED0000FF")


ordPlotAllLocationsV9 <- plot_ordination(physeqSubsetList$V9, 
                                         ordination = ordinationV9,
                                         color = "location",
                                         title = "") +
    theme_bw() +
    scale_color_manual(values=regioncolor)+
    theme(plot.title = element_text(hjust = 0.5)) +
    geom_point(size = 3) +
    stat_ellipse(type = "norm", linetype = 2) +
    labs(color = "Geographic Region") +
    theme(legend.position="bottom",
        plot.title = element_text(hjust = 0.45, face = "bold"))+ 
    annotate("text", label = "ADONIS\nRW - UG p = 0.012\nRW - US p = 0.001\nUG - US p = 0.001", x = 0.44, y = 0.30)

ordPlotAllLocationsV9
```

# Fig 3E - Fig 3J
``` {r Fig 3E - Fig 3J}
## Function 1: Plot volcano plot at genus level
plotVolcanoGenus <- function(ps0, ps0.subset, factorOfInterest = NULL, alpha = NULL, 
                            baseMean = NULL, reference_region = "NULL", 
                            comparison_region = "NULL", ps_name = NULL) {
  ##count table replacement function
  replace_counts = function(ps0, dds) {
    dds_counts = DESeq2::counts(dds, normalized = TRUE)
    if (!identical(phyloseq::taxa_names(ps0), rownames(dds_counts))) {
      stop("OTU ids don't match")
    }
    phyloseq::otu_table(ps0) = phyloseq::otu_table(dds_counts, taxa_are_rows = TRUE)
    return(ps0)
  }
  
  # Make deseq ready object
  formula <- as.formula(paste0("~", factorOfInterest))
  ds.all <- phyloseq::phyloseq_to_deseq2(ps0, formula) # Can be any variable
  gm_mean = function(x, na.rm=TRUE) {
    exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
  }
  
  # Get the table with all the columns
  geoMeans <- apply(DESeq2::counts(ds.all), 1, gm_mean)
  ds.all <- DESeq2::estimateSizeFactors(ds.all, geoMeans = geoMeans)
  dds.all <- DESeq2::DESeq(ds.all, fitType = "local")
  rlog.all <- replace_counts(ps0, dds.all)
  rlog.all <- phyloseq::psmelt(rlog.all)
  rlog.all <- dplyr::rename(rlog.all, "ASV" = "OTU")
  
  # Convert phyloseq to deseq2 table
  ds.subset <- phyloseq::phyloseq_to_deseq2(ps0.subset, formula)
  
  # Compute geomeans
  geoMeans <- apply(DESeq2::counts(ds.subset), 1, gm_mean)
  
  # Estimate size factors
  ds.subset <- DESeq2::estimateSizeFactors(ds.subset, geoMeans = geoMeans)
  
  # Run deseq
  dds.subset <- DESeq2::DESeq(ds.subset)
  print(summary(DESeq2::results(dds.subset)))
  
  # Get deseq result
  res.dds.subset <- DESeq2::results(dds.subset, cooksCutoff = FALSE)
  res.dds.subset <- as.data.frame(res.dds.subset[which(res.dds.subset$baseMean > baseMean), ])
  
  # Tabulate the result table
  restable.dds.subset <- data.table(as(res.dds.subset, "data.frame"), keep.rownames = TRUE)
  setnames(restable.dds.subset, "rn", "OTU")
  setkeyv(restable.dds.subset, "OTU")
  
  # Extract taxa tables
  taxa.subset <- data.table(data.frame(as(phyloseq::tax_table(ps0.subset), "matrix")), keep.rownames = TRUE)
  setnames(taxa.subset, "rn", "OTU")
  setkeyv(taxa.subset, "OTU")
  
  restable.dds.subset <- as.data.frame(restable.dds.subset)
  taxa.subset <- as.data.frame(taxa.subset)
  rownames(restable.dds.subset) <- restable.dds.subset$OTU
  rownames(taxa.subset) <- taxa.subset$OTU
  restable_taxa.subset <- left_join(restable.dds.subset, taxa.subset)
  
  # If ps_name is not provided, use a default name
  if (is.null(ps_name)) {
    ps_name <- "ps0subset"  # Default fallback name
  }
  
  # Clean the table
  cleaned.table.subset <- restable_taxa.subset %>%
    filter(padj != "NA") %>%
    mutate(significant = padj < alpha)
  
  outdf <- subset(cleaned.table.subset, padj < 0.05)
  output_dir <- "./figures/"  # You can make this a parameter if needed

 write.csv(outdf, file.path(output_dir, paste0(ps_name, "_DESeqTable.csv")))
 write.csv(cleaned.table.subset, file.path(output_dir, paste0(ps_name, "_DESeqTable.cleaned.table.all.csv")))
   
  l <- unique(as.factor(cleaned.table.subset$Genus))
  color <- colorRampPalette(brewer.pal(9, "Set1"))(length(l))
  names(color) <- l
  
  print("Plotting volcano plot:")
  # Volcano plot
  p.volcano <- ggplot(data = cleaned.table.subset,
                     aes(x = log2FoldChange,
                         y = -log10(padj),
                         color = Phylum,
                         label1 = Family,
                         label2 = Genus,
                         label3 = Phylum)) +
    geom_point(data = subset(cleaned.table.subset, cleaned.table.subset$significant == FALSE),
              color = "grey") +
    geom_point(data = subset(cleaned.table.subset, cleaned.table.subset$significant == TRUE),
              aes(color = Phylum,
                  size = baseMean)) +
    geom_vline(xintercept = 0, lty = 2) +
    geom_hline(yintercept = -log10(0.05)) +
    geom_text_repel(data = subset(cleaned.table.subset, cleaned.table.subset$significant == TRUE), 
                   aes(label = Genus), show.legend = FALSE) +
    # Add region annotations inside the plot
    annotate("text", x = -max(abs(cleaned.table.subset$log2FoldChange))*0.6, y = max(-log10(cleaned.table.subset$padj), na.rm = TRUE)*0.94, 
             label = reference_region, size = 5, fontface = "bold") +
    annotate("text", x = max(abs(cleaned.table.subset$log2FoldChange))*0.6, y = max(-log10(cleaned.table.subset$padj), na.rm = TRUE)*0.94, 
             label = comparison_region, size = 5, fontface = "bold") +
    labs(title = paste0("By Genus"), 
         subtitle = paste0("alpha = ", alpha, ", baseMean = ", baseMean)) +
    theme_bw() +
    theme(axis.title = element_text(size = 12),
          axis.text = element_text(size = 12),
          axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
          legend.text = element_text(size = 8),
          legend.position = "right")
  
  # Return both the plot and the data for potential use in the second function
  return(list(plot = p.volcano, 
              data = list(cleaned.table = cleaned.table.subset, 
                         significant = outdf,
                         results = res.dds.subset)))
}

## Function 2: Plot phylum-level ASV counts - Independent function to plot phylum-level ASV 
plotPhylumDESeq <- function(ps0, factorOfInterest = NULL, alpha = 0.05, baseMean = 0) {
  # Aggregate counts at phylum level
  ps_phylum <- phyloseq::tax_glom(ps0, "Phylum")
  
  # Get phylum names for each taxa
  tax_table <- as.data.frame(phyloseq::tax_table(ps_phylum))
  phylum_names <- tax_table$Phylum
  
  # Formula for DESeq2
  formula <- as.formula(paste0("~", factorOfInterest))
  
  # Convert to DESeq2 object
  gm_mean <- function(x, na.rm=TRUE) {
    exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
  }
  
  # Convert phyloseq to DESeq2
  ds_phylum <- phyloseq::phyloseq_to_deseq2(ps_phylum, formula)
  
  # Calculate geometric means
  geoMeans <- apply(DESeq2::counts(ds_phylum), 1, gm_mean)
  
  # Estimate size factors
  ds_phylum <- DESeq2::estimateSizeFactors(ds_phylum, geoMeans = geoMeans)
  
  # Run DESeq2
  dds_phylum <- DESeq2::DESeq(ds_phylum, fitType = "local")
  
  # Get results
  res_phylum <- DESeq2::results(dds_phylum, cooksCutoff = FALSE)
  res_phylum <- as.data.frame(res_phylum[which(res_phylum$baseMean > baseMean), ])
  
  # Map results to phylum names
  res_phylum$Phylum <- phylum_names[match(rownames(res_phylum), rownames(tax_table))]
  
  # Filter for significance
  sig_phyla <- subset(res_phylum, padj < alpha)
  
  # Extract groups from sample data
  samp_data <- as.data.frame(phyloseq::sample_data(ps0))
  groups <- unique(samp_data[[factorOfInterest]])
  
  # Get original (non-aggregated) data
  ps_orig <- ps0
  
  # Extract OTU table and convert to presence/absence
  otu <- as.matrix(phyloseq::otu_table(ps_orig))
  if(phyloseq::taxa_are_rows(ps_orig) == FALSE) {
    otu <- t(otu)
  }
  
  # Get taxonomy
  tax <- as.data.frame(phyloseq::tax_table(ps_orig))
  
  # Get sample data
  sample_data <- as.data.frame(phyloseq::sample_data(ps_orig))
  
  # Initialize ASV count dataframe
  asv_counts <- data.frame()
  
  # Get list of all phyla in the dataset
  all_phyla <- unique(tax$Phylum)
  
  # For each phylum, count ASVs in each group
  for(p in all_phyla) {
    # Get ASVs in this phylum
    phylum_asvs <- rownames(tax[tax$Phylum == p, ])
    
    # For each group, count ASVs present
    for(group in groups) {
      # Get samples in this group
      group_samples <- rownames(sample_data[sample_data[[factorOfInterest]] == group, ])
      
      # Count ASVs present in at least one sample of this group
      asv_presence <- rowSums(otu[phylum_asvs, group_samples, drop = FALSE] > 0) > 0
      count <- sum(asv_presence)
      
      # Add to results
      asv_counts <- rbind(asv_counts, 
                         data.frame(Phylum = p,
                                   Count = count,
                                   Region = group,
                                   stringsAsFactors = FALSE))
    }
  }
  
  # If no ASV counts, return a message
  if(nrow(asv_counts) == 0) {
    message("No ASV counts could be generated")
    return(NULL)
  }
  
  # Add Direction column based on DESeq2 results
  asv_counts$Direction <- NA
  
  # For significant phyla, determine direction based on log2FoldChange
  if(nrow(sig_phyla) > 0) {
    for(p in unique(sig_phyla$Phylum)) {
      log2fc <- sig_phyla[sig_phyla$Phylum == p, "log2FoldChange"]
      if(length(log2fc) > 0) {
        # First group is reference (negative log2FC means higher in first group)
        asv_counts$Direction[asv_counts$Phylum == p] <- ifelse(log2fc < 0, 
                                                             groups[1], 
                                                             groups[2])
      }
    }
  }
  
  # Create plot
  library(ggplot2)

  # Order phyla with significant at top and non-significant at bottom
  # Create ordering data frame
  ordering_data <- data.frame(Phylum = unique(asv_counts$Phylum))
  
  # Add significance information
  ordering_data$Significant <- ordering_data$Phylum %in% unique(sig_phyla$Phylum)
  
  # Add p-value for significant phyla (use 1 for non-significant)
  ordering_data$PValue <- 1
  if(nrow(sig_phyla) > 0) {
    for(p in unique(sig_phyla$Phylum)) {
      ordering_data$PValue[ordering_data$Phylum == p] <- 
        sig_phyla[sig_phyla$Phylum == p, "padj"]
    }
  }
  
  # Add total counts
  phylum_totals <- aggregate(Count ~ Phylum, data = asv_counts, FUN = sum)
  ordering_data$TotalCount <- 0
  for(p in ordering_data$Phylum) {
    if(p %in% phylum_totals$Phylum) {
      ordering_data$TotalCount[ordering_data$Phylum == p] <- 
        phylum_totals$Count[phylum_totals$Phylum == p]
    }
  }
  
  # Split into significant and non-significant
  sig_data <- ordering_data[ordering_data$Significant, ]
  nonsig_data <- ordering_data[!ordering_data$Significant, ]
  
  # Order significant by p-value (descending p-value = ascending statistical significance)
  if(nrow(sig_data) > 0) {
    sig_data <- sig_data[order(sig_data$PValue, decreasing = TRUE), ]
  }
  
  # Order non-significant by count
  if(nrow(nonsig_data) > 0) {
    nonsig_data <- nonsig_data[order(nonsig_data$TotalCount, decreasing = TRUE), ]
  }
  
  # Combine: first all significant (ordered by p-value), then all non-significant (ordered by count)
  ordering_data <- rbind(nonsig_data, sig_data)
  
  # Set the phylum order
  phylum_order <- ordering_data$Phylum
  
  # Reorder factors
  asv_counts$Phylum <- factor(asv_counts$Phylum, levels = phylum_order)

  # Create new data frame for diverging bars
  plot_data <- asv_counts
  # For the first region, make the counts negative
  plot_data$Count[plot_data$Region == groups[1]] <- -plot_data$Count[plot_data$Region == groups[1]]

  # Find max count for x-axis limit (rounded up to next 150)
  max_count_raw <- max(abs(plot_data$Count))
  max_count <- ceiling(max_count_raw / 150) * 150

  # Add significance indicator to phylum names with p-values for significant phyla
  plot_data$Phylum_label <- as.character(plot_data$Phylum)
  if(nrow(sig_phyla) > 0) {
    for(p in unique(sig_phyla$Phylum)) {
      # Add star and p-value for significant phyla
      p_value <- sig_phyla[sig_phyla$Phylum == p, "padj"]
      p_value_fmt <- format(p_value, digits = 2, scientific = TRUE)
      plot_data$Phylum_label[plot_data$Phylum == p] <- paste0(p, " * (p=", p_value_fmt, ")")
    }
  }
  
  # Ensure the order of the labels matches the phylum factor order
  phylum_label_order <- unique(plot_data$Phylum_label[order(plot_data$Phylum)])
  plot_data$Phylum_label <- factor(plot_data$Phylum_label, levels = phylum_label_order)

  # Create the plot
  p <- ggplot(plot_data, aes(x = Count, y = Phylum_label, fill = Region)) +
    geom_bar(stat = "identity") +
    # Add count labels outside the bars
    geom_text(
    aes(
      label = abs(Count),
      # Keep the same hjust for non-zero values, but handle zeros specially
      hjust = ifelse(Count == 0, 
                    ifelse(Region == groups[1], 1.5, -0.5),  # Position zeros based on region
                    ifelse(Count < 0, 1.2, -0.2))  # Original positioning for non-zeros
    ),
    size = 3.5
    ) +
    scale_x_continuous(
      limits = c(-max_count, max_count),
      breaks = seq(-max_count, max_count, by = 100),
      labels = abs(seq(-max_count, max_count, by = 100))
    ) +
    scale_fill_manual(values = c("RW" = "#008800", "UG" = "#00008B", "US" = "#E41A1C"), 
                 name = "Geographic Region") +
    labs(
      title = "ASV Counts by Phylum",
      subtitle = paste0("alpha = ", alpha, ", baseMean = ", baseMean, 
                        "\n* indicates statistically significant difference (padj < ", alpha, ")"),
      x = "ASV counts",
      y = "Phylum"
    ) +
    theme_bw() +
    theme(
      legend.position = "bottom",
      axis.text.y = element_text(face = "plain"),
      panel.grid.major.y = element_blank(),
      axis.text.x = element_text(angle = 45, hjust = 1),
      # Add right margin to accommodate labels
 #     plot.margin = margin(t = 5, r = 60, b = 5, l = 5, unit = "pt") 
    ) +
    geom_vline(xintercept = 0, linetype = "solid", color = "black")

  # Return both the data and the plot in a list
  return(list(data = asv_counts, plot = p))
}

# Rwanda vs US Fig 3E, Fig 3F
volcano_result_RWUS <- plotVolcanoGenus(ps1_V9, ps1_V9_RWUS, 
                                       factorOfInterest = "sub_region", 
                                       alpha = 0.05, baseMean = 10, 
                                       reference_region = "RW", 
                                       comparison_region = "US",
                                       ps_name = "ps1_V9_RWUS")

volcano_result_RWUS
volcano_plot_RWUS <- volcano_result_RWUS$plot

phylum_plot_RWUS <- plotPhylumDESeq(ps1_V9_RWUS, "sub_region", 0.05, 0)
phylum_plot_RWUS_fin <- phylum_plot_RWUS$plot

# Uganda vs US
volcano_result_USUG <- plotVolcanoGenus(ps1_V9, ps1_V9_USUG, 
                                       factorOfInterest = "sub_region", 
                                       alpha = 0.05, baseMean = 10, 
                                       reference_region = "US", 
                                       comparison_region = "UG",
                                       ps_name = "ps1_V9_USUG")

volcano_result_USUG
volcano_plot_USUG <- volcano_result_USUG$plot

phylum_plot_USUG <- plotPhylumDESeq(ps1_V9_USUG, "sub_region", 0.05, 0)
phylum_plot_USUG_fin <- phylum_plot_USUG$plot

# Rwanda vs Uganda Fig 3E, Fig 3F
volcano_result_RWUG <- plotVolcanoGenus(ps1_V9, ps1_V9_RWUG, 
                                       factorOfInterest = "sub_region", 
                                       alpha = 0.05, baseMean = 10, 
                                       reference_region = "RW", 
                                       comparison_region = "UG",
                                       ps_name = "ps1_V9_RWUG")

volcano_result_RWUG
volcano_plot_RWUG <- volcano_result_RWUG$plot

phylum_plot_RWUG <- plotPhylumDESeq(ps1_V9_RWUG, "sub_region", 0.05, 0)
phylum_plot_RWUG_fin <- phylum_plot_RWUG$plot

```

# Final Figure 3
```{r figure 3}
# First row with A and B
# Update alphadiversity_V9 to remove gray background
alphadiversity_V9 <- alphadiversity_V9 + 
  theme_bw() +  # Sets white background with grid lines
  theme(
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    legend.background = element_rect(fill = "white", color = NA)
  )

first_row <- plot_grid(
  p.cc.region_V9, alphadiversity_V9,
  ncol = 2,
  rel_widths = c(1.5, 1),
  labels = c("A.","B."),
  label_size = 16,
  label_fontface = "bold"
)

# 2nd row with C and D
# Create second row with plots without legends
second_row <- plot_grid(
  p.pcoa.wuni.region_V9_prev + theme(legend.position = "none"), 
  ordPlotAllLocationsV9 + theme(legend.position = "none"),
  ncol = 2,
  rel_widths = c(1, 1),
  labels = c("C.", "D."),
  label_size = 16,
  label_fontface = "bold",
  align = "h",
  axis = "tb"
)

# Create a text-only legend with white background
  text_legend <- cowplot::ggdraw(xlim = c(0, 1), ylim = c(0, 1)) +
    # Add a white rectangle as background
    cowplot::draw_grob(grid::rectGrob(gp = grid::gpar(fill = "white", col = NA))) +
    cowplot::draw_label("Geographic Region:", x = 0.3, y = 0.5, size = 12, fontface = "plain") +
    # Instead of draw_point, we'll use small colored circles with text
    cowplot::draw_label("", x = 0.45, y = 0.5, size = 15, color = "#008800") +
    cowplot::draw_label("Rwanda", x = 0.5, y = 0.5, size = 10, color = "#008800", hjust = 0) +
    cowplot::draw_label("", x = 0.6, y = 0.5, size = 15, color = "#00008B") +
    cowplot::draw_label("Uganda", x = 0.63, y = 0.5, size = 10, color = "#00008B", hjust = 0) +
    cowplot::draw_label("", x = 0.75, y = 0.5, size = 15, color = "#E41A1C") +
    cowplot::draw_label("US", x = 0.78, y = 0.5, size = 10, color = "#E41A1C", hjust = 0)

# Create third row 
third_row <- plot_grid(
  volcano_plot_RWUS, phylum_plot_RWUS_fin,  # Replace with your actual plot variables
  ncol = 2,
  rel_widths = c(1, 1.2),
  labels = c("E.", "F."),
  label_size = 16,
  label_fontface = "bold",
  align = "h",
  axis = "tb"
)

# Fourth row (panels G and H)
fourth_row <- plot_grid(
  volcano_plot_USUG, phylum_plot_USUG_fin,  # Replace with your actual plot variables
  ncol = 2,
  rel_widths = c(1, 1.2),
  labels = c("G.", "H."),
  label_size = 16,
  label_fontface = "bold",
  align = "h",
  axis = "tb"
)

# Fifth row (panels I and J)
fifth_row <- plot_grid(
  volcano_plot_RWUG, phylum_plot_RWUG_fin,  # Replace with your actual plot variables
  ncol = 2,
  rel_widths = c(1, 1.2),
  labels = c("I.", "J."),
  label_size = 16,
  label_fontface = "bold",
  align = "h",
  axis = "tb"
)

# Combine all rows into final figure
F3_final_figure <- plot_grid(
  first_row,
  second_row,
  text_legend,
  third_row,
  fourth_row,
  fifth_row,
  ncol = 1,
  rel_heights = c(1, 1, 0.15, 1.5, 1.5, 1.5)  # Adjust based on actual plot proportions 
)

# Save the final figure
ggsave("figures/Figure_3.tiff", 
       F3_final_figure, 
       width = 11, height = 25,  # Adjust height as needed
       dpi = 300, 
       compression = "lzw")

```

# Fig Supplemental 3A Early post-vaccination US vs UG phylum relative abundance
```{r Fig 3A}
threshold = 0.01
ps1.phylum_V2_USUG <- ps1_V2_USUG %>%
  tax_glom(taxrank = "Phylum") %>%
  transform_sample_counts(function(x) {x/sum(x)} ) %>%
  psmelt %>%
  filter(Abundance > threshold) %>%
  arrange(Phylum, Abundance)

Phylumcolor<-c("Fusobacteriota"="#4575B4",
               "Actinomycetota"= "#74ADD1",
               "Pseudomonadota"="#ABD9E9", 
               "Elusimicrobiota" = "#E0F3F8",
               "Verrucomicrobiota"="#FFFFBF",
               "Spirochaetota"="#FEE090", 
               "Bacteroidota"= "#F46D43",
               "Bacillota"= "#D73027")

# New facet label names for sub_region variable
subregion.labs <- c("US", "UG")
names(subregion.labs) <- c("US", "Uganda")

# Create the plots
p.cc.region_V2_USUG <- ggplot(ps1.phylum_V2_USUG, aes(x = as.factor(sample_id), y = Abundance, fill = fct_reorder(Phylum, Abundance))) +
  geom_bar(stat = "identity", width = 1) +
  facet_grid(~sub_region, scales = "free", space = "free", labeller = labeller(sub_region = subregion.labs)) +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
  scale_fill_manual(values = Phylumcolor)+
  theme(axis.text.x = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(legend.position="right") +
  labs(fill = "Phylum")
 
p.cc.region_V2_USUG

```

# Fig Supplemental 3B: Alpha-diversity analysis in V2 stool samples RW and US
```{r Fig S3B}
# Diversity calculations
diversity_V2 <- as_tibble(microbiome::alpha(ps1_V2))

diversity_V2

# Faith's phylogenetic diversity
library("btools")
v2.faiths <- ps1_V2 %>%
  estimate_pd() %>%
  select(-SR)

# Bind sample data to diversity data
sd_V2 <- as.tibble(sample_data(ps1_V2)) # useful to coerce the phyloseq object into an R data frame

# Bind sample data to diversity data and Pielou's evenness
ps1.v2.alpha <- as.tibble(cbind(sd_V2, diversity_V2, v2.faiths)) # merge sd by row names

ps1.v2.alpha$group <- factor(ps1.v2.alpha$group, levels = c("GROUP 1", "GROUP 2", "GROUP 3", "GROUP 4", "GROUP 5", "GROUP 6", "GROUP 7", "GROUP 8"))

ps1.v2.alpha

# Select diversity measures
alpha.div.meas <- c("evenness_pielou",
                    "observed",
                    "PD")
# Pivot to long form
alpha.V2 <- ps1.v2.alpha %>%
  pivot_longer(cols = observed:PD,
               names_to = "Alpha",
               values_to = "Value")

# Convert Alpha to factor
alpha.V2$Alpha <- as.factor(alpha.V2$Alpha)

alpha.V2.select <- alpha.V2 %>%
  filter(Alpha %in% alpha.div.meas) %>%
  mutate(Alpha=recode(Alpha, evenness_pielou = "Pielous Evenness",
                      observed = "Richness",
                      PD = "Faith's PD")) %>%
  droplevels()
alpha.V2.select$Alpha <- factor(alpha.V2.select$Alpha, levels = c("Richness",
                                                                  "Faith's PD",
                                                                  "Pielous Evenness"))
# Stats
# kruskal-dunn_test
alpha.V2.select.kruskal_test <- alpha.V2.select %>%
  group_by(Alpha) %>%
  kruskal_test(Value ~ sub_region)
alpha.V2.select.kruskal_test

pwc_ALL_Day_V2_region <- alpha.V2.select  %>% group_by(Alpha) %>%
  dunn_test(Value ~ sub_region, p.adjust.method = "BH") 

#pwc_ALL_Day_V2_region  <- pwc_ALL_Day_V2_region %>% add_xy_position(x = "sub_region")
pwc_ALL_Day_V2_region

pwc_richness_Day_V2_region <- pwc_ALL_Day_V2_region %>% filter(Alpha == "Richness")
pwc_FPD_Day_V2_region <- pwc_ALL_Day_V2_region %>% filter(Alpha == "Faith's PD")
pwc_evenness_Day_V2_region <- pwc_ALL_Day_V2_region %>% filter(Alpha == "Pielous Evenness")

# Summary stats
alpha.V2.select %>%
  select(sub_region, Alpha, Value) %>%
  group_by(sub_region, Alpha) %>%
  summarize(mean = mean(Value), stdev = sd(Value))

#######################
regioncolor <- c("UG" ="#00468BFF", "US" = "#ED0000FF")

richnessPlot_Day_V2_ALL <- ggplot(ps1.v2.alpha,
                       aes(x = sub_region, y = observed)) + ylim(0,600)+
                       scale_color_manual(values=regioncolor)+
                       geom_jitter(aes(color = sub_region), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = sub_region), fill = "gray80", alpha = 0.25, width = 0.4)+
  ylab("Bacterial Richness") +
  xlab(" ") +
  theme_pubr() +
  theme(plot.title = element_text(hjust = 0.5, vjust = 1.5), legend.position = "none")+
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))+
    theme(plot.subtitle = element_text(size = 8))  +
  stat_pvalue_manual(pwc_richness_Day_V2_region, vjust = 0,label = "p.adj.signif",y.position = 480)
richnessPlot_Day_V2_ALL

FPD_Plot_Day_V2_ALL <- ggplot(ps1.v2.alpha,
                       aes(x = sub_region, y = PD)) +
                       scale_color_manual(values=regioncolor)+
                       geom_jitter(aes(color = sub_region), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = sub_region), fill = "gray80", alpha = 0.25, width = 0.4)+
                        ylab("Bacterial Faith's PD") +
                        xlab(" ") +
                        theme_pubr() +
                        theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
                        theme(axis.text.x = element_text(angle = 0, hjust = 0.5))+
                        stat_pvalue_manual(pwc_FPD_Day_V2_region, vjust = 0,label = "p.adj.signif", y.position = 52, label.x = 1.5)
FPD_Plot_Day_V2_ALL

evenness_Plot_Day_V2_ALL <- ggplot(ps1.v2.alpha,
                       aes(x = sub_region, y = evenness_pielou)) +
                       scale_color_manual(values=regioncolor)+
                       geom_jitter(aes(color = sub_region), alpha = 0.65,
                       position = position_jitter(width = 0.3)) +
                       geom_boxplot(aes(color = sub_region), fill = "gray80", alpha = 0.25, width = 0.4)+
                        ylab("Bacterial Pielous evenness") +
                        xlab(" ") +
                        theme_pubr() +
                        theme(plot.title = element_text(hjust = 0.5), legend.position = "none")+
                        theme(axis.text.x = element_text(angle = 0, hjust = 0.5))+
                        stat_pvalue_manual(pwc_evenness_Day_V2_region, vjust = 0,label = "p.adj.signif", y.position = 0.85, label.x = 1.5)
evenness_Plot_Day_V2_ALL

####################
alphadiversity_V2 <- ggarrange(richnessPlot_Day_V2_ALL, FPD_Plot_Day_V2_ALL, evenness_Plot_Day_V2_ALL, ncol = 3)

alphadiversity_V2_with_label <- alphadiversity_V2 +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    plot.title = element_text(size = 16, face = "bold", hjust = 0, margin = margin(b = 10))
  ) +
  ggtitle("B.")

alphadiversity_V2_with_label
```

# Fig Supplemental 3C beta diversity bacteria US vs UG
```{r Fig S3C}
# ps1_V2_USUG
set.seed(46395617)
# Weighted Unifrac
bdist_wunf_ps1_V2_USUG<- phyloseq::distance(ps1_V2_USUG, "wunifrac")
col_wunf_ps1_V2_USUG<- as(sample_data(ps1_V2_USUG), "data.frame")[, "sub_region"]
adonis.bdist_wunf_ps1_V2_USUG<- adonis2(bdist_wunf_ps1_V2_USUG ~ col_wunf_ps1_V2_USUG)
adonis.bdist_wunf_ps1_V2_USUG

# Calculate total ordinations
ord.pcoa.uni_ps1_V2_USUG<- ordinate(ps1_V2_USUG, method = "PCoA", distance = "unifrac")
evals.uni_ps1_V2_USUG<- ord.pcoa.uni_ps1_V2_USUG$values$Eigenvalues
ord.pcoa.wuni_ps1_V2_USUG<- ordinate(ps1_V2_USUG, method = "PCoA", distance = "wunifrac")
evals.wuni_ps1_V2_USUG<- ord.pcoa.wuni_ps1_V2_USUG$values$Eigenvalues

# Define your groups
groups <- unique(col_wunf_ps1_V2_USUG)  # e.g., US, UG

# Create a function for pairwise PERMANOVA
pairwise_permanova <- function(dist_matrix, groups_vector) {
  # Convert to character to avoid factor issues
  groups_vector <- as.character(groups_vector)
  
  # Create an empty matrix to store results
  group_levels <- unique(groups_vector)
  n_groups <- length(group_levels)
  result_matrix <- matrix(NA, nrow=n_groups, ncol=n_groups)
  rownames(result_matrix) <- group_levels
  colnames(result_matrix) <- group_levels
  
  # Run pairwise tests
  for (i in 1:(n_groups-1)) {
    for (j in (i+1):n_groups) {
      # Select samples from the two groups
      group1 <- group_levels[i]
      group2 <- group_levels[j]
      idx <- groups_vector %in% c(group1, group2)
      
      if (sum(idx) > 0) {  # Ensure we have samples
        sub_dist <- as.dist(as.matrix(dist_matrix)[idx, idx])
        sub_groups <- groups_vector[idx]
        
        # Run PERMANOVA
        set.seed(123)  # For reproducibility
        perm_result <- adonis2(sub_dist ~ sub_groups)
        
        # Store p-value
        result_matrix[i,j] <- perm_result$`Pr(>F)`[1]
        result_matrix[j,i] <- result_matrix[i,j]  # Mirror the matrix
      }
    }
  }
  
  return(result_matrix)
}

pairwise_results <- pairwise_permanova(bdist_wunf_ps1_V2_USUG, col_wunf_ps1_V2_USUG)

# Apply correction for multiple testing
library(reshape2)
p_values <- melt(pairwise_results)
p_values <- p_values[!is.na(p_values$value), ]  # Remove NA values
p_values$adjusted <- p.adjust(p_values$value, method = "bonferroni")

# Print results in a nice format
colnames(p_values) <- c("Group1", "Group2", "p_value", "p_adjusted")
p_values <- p_values[p_values$Group1 != p_values$Group2, ]  # Remove self-comparisons
p_values$pair <- apply(p_values[, c("Group1", "Group2")], 1, function(x) {
  paste(sort(x), collapse="-")
})
p_values <- p_values[!duplicated(p_values$pair), ]
p_values$pair <- NULL
print(p_values)
#   Group1 Group2 p_value p_adjusted
# 2     UG     US   0.005       0.01

# Ordination plots all samples
regioncolor <- c("UG" ="#00468BFF", "RW" = "#42B540FF", "US" = "#ED0000FF")

# Weighted Unifrac
p.pcoa.wuni.region_ps1_V2_USUG <- plot_ordination(ps1_V2_USUG, ord.pcoa.wuni_ps1_V2_USUG, color = "sub_region", axes = c(1,2)) +
  theme_bw() +
  scale_color_manual(values=regioncolor)+
  geom_point(size = 3) +
  labs(title = "", color = "Geographic Region") +
  stat_ellipse(type = "norm", linetype = 2) + 
  annotate("text", x=0.34, y=0.20, label ="ADONIS\nUS - UG p = 0.01\n", col = "black")+ 
  theme(legend.position="bottom")

p.pcoa.wuni.region_ps1_V2_USUG
```

# Fig Supplemental D Phage Beta Diversity by Location - US vs Uganda only in V2
```{r Fig 3D}
# Subset only Uganda and US from physeqPhageV2
physeqPhageV2_UG_US <- subset_samples(physeqPhageV2, 
                                   location %in% c("Uganda", "US")) %>% 
    RemoveMissingTaxa()

# Calculate p-values for distances between Uganda and US in V2
set.seed(39731037)
adonisUgandaUS_V2 <- RunAdonis(physeqPhageV2_UG_US, "location", "bray")

adonisUgandaUS_V2
# adonis2(formula = bdist ~ col)
#          Df SumOfSqs      R2     F Pr(>F)    
# Model     1   1.1021 0.06702 3.089  0.001 ***
# Residual 43  15.3417 0.93298                 
# Total    44  16.4438 1.00000                 
# ---
# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1

# Create ordination
ordinationV2_UG_US <- ordinate(physeqPhageV2_UG_US, method = "MDS", 
                         distance = "bray")

# Define color palette (just for Uganda and US)
regioncolor_UG_US <- c("Uganda" ="#00468BFF", "US" = "#ED0000FF")

# Plot ordination
ordPlot_UG_US_V2 <- plot_ordination(physeqPhageV2_UG_US, 
                                    ordination = ordinationV2_UG_US,
                                    color = "location",
                                    title = "") +
    theme_bw() +
    scale_color_manual(values=regioncolor_UG_US) +
    theme(plot.title = element_text(hjust = 0.5)) +
    geom_point(size = 3) +
    stat_ellipse(type = "norm", linetype = 2) +
    labs(color = "Geographic Region") +
    theme(legend.position="bottom",
        plot.title = element_text(hjust = 0.45, face = "bold")) + 
    annotate("text", label = paste0("ADONIS\nUG - US p = 0.001"), 
             x = 0.44, y = 0.30)

# Display the plot
ordPlot_UG_US_V2
```

# Fig Supplemental 3E Supplemental 3F volcano plot and phylum plot
``` {r Fig S3E, SF3F}
# Uganda vs US Fig 3E, Fig 3F
volcano_result_USUG <- plotVolcanoGenus(ps1_V2, ps1_V2_USUG, factorOfInterest = "sub_region", 
                                    alpha = 0.05, baseMean = 10, reference_region = "UG", comparison_region = "US")
volcano_result_USUG
volcano_plot_USUG <- volcano_result_USUG$plot

phylum_plot_USUG <- plotPhylumDESeq(ps1_V2_USUG, "sub_region", 0.05, 0)
phylum_plot_USUG_fin <- phylum_plot_USUG$plot
phylum_plot_USUG_fin

```

# Final Supplemental Figure 3
```{r figure S3}
# First row with A and B
first_row <- plot_grid(
  p.cc.region_V2_USUG + 
    theme(plot.title = element_text(size = 16, face = "bold", hjust = 0, margin = margin(b = 10))) +
    ggtitle("A."), 
  alphadiversity_V2_with_label,
  ncol = 2,
  rel_widths = c(1.3, 1),
  labels = c("", "")
)

# 2nd row with C and D
# Create second row with plots without legends
second_row <- plot_grid(
  p.pcoa.wuni.region_ps1_V2_USUG + theme(legend.position = "none"), 
  ordPlot_UG_US_V2 + theme(legend.position = "none"),
  ncol = 2,
  rel_widths = c(1, 1),
  labels = c("C.", "D."),
  label_size = 16,
  label_fontface = "bold",
  align = "h",
  axis = "tb"
)

# Create a text-only legend with white background
  text_legend <- cowplot::ggdraw(xlim = c(0, 1), ylim = c(0, 1)) +
    # Add a white rectangle as background
    cowplot::draw_grob(grid::rectGrob(gp = grid::gpar(fill = "white", col = NA))) +
    cowplot::draw_label("Geographic Region:", x = 0.3, y = 0.5, size = 12, fontface = "plain") +
    # Instead of draw_point, we'll use small colored circles with text
    cowplot::draw_label("", x = 0.6, y = 0.5, size = 15, color = "#00008B") +
    cowplot::draw_label("Uganda", x = 0.63, y = 0.5, size = 10, color = "#00008B", hjust = 0) +
    cowplot::draw_label("", x = 0.75, y = 0.5, size = 15, color = "#E41A1C") +
    cowplot::draw_label("US", x = 0.78, y = 0.5, size = 10, color = "#E41A1C", hjust = 0)

# Create third row 
third_row <- plot_grid(
  volcano_plot_USUG, phylum_plot_USUG_fin,  
  ncol = 2,
  rel_widths = c(1, 1),
  labels = c("E.", "F."),
  label_size = 16,
  label_fontface = "bold",
  align = "h",
  axis = "tb"
)

# Combine all rows into final figure
SF3_final_figure <- plot_grid(
  first_row,
  second_row,
  text_legend,
  third_row,
  ncol = 1,
  rel_heights = c(1, 1, 0.15, 1.5)  # Adjust based on actual plot proportions 
)

# Save the final figure
ggsave("figures/Supplemental_figure_3.tiff", 
       SF3_final_figure, 
       width = 12, height = 15,  # Adjust height as needed
       dpi = 300, 
       compression = "lzw")

```

# =============================================================================
# FIGURE 4: Bacterial diversity correlates with vaccine-elicited immune responses
# =============================================================================
# INSERT THIS CODE AFTER SUPPLEMENTAL FIGURE 3 SECTION (~line 4302) IN THE MAIN Rmd
# 
# This code generates:
# 1. Scatter plots for Panels B, C, D (WITHOUT statistics annotations)
# 2. CSV files with multiple statistical approaches for manual review
# 3. Correlation tables for Panel A
# =============================================================================

# =============================================================================
# SETUP AND DATA PREPARATION
# =============================================================================
```{r Fig4-setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(cowplot)
library(emmeans)

# Filter to exclude placebo (GROUP 8)
ps1.v9.alpha2 <- ps1.v9.alpha %>% filter(group != "GROUP 8")

# Define region colors
regioncolor <- c("RW" = "#42B540FF", "UG" = "#00468BFF", "US" = "#ED0000FF")

# Function to convert p-value to significance symbol
p_to_signif <- function(p) {
 dplyr::case_when(
    is.na(p) ~ "",
    p < 0.0001 ~ "****",
    p < 0.001 ~ "***",
    p < 0.01 ~ "**",
    p < 0.05 ~ "*",
    TRUE ~ "ns"
  )
}

# Helper function to create scatter plot (NO statistics annotations)
create_scatter_plot <- function(data, x_var, y_var, y_label, title, 
                                 log_transform_y = FALSE, y_intercept = NULL) {
  
  # Create the plot data
  plot_data <- data %>%
    filter(!is.na(.data[[y_var]]) & !is.na(.data[[x_var]])) %>%
    mutate(
      y_plot = if(log_transform_y) log10(.data[[y_var]] + 1) else .data[[y_var]],
      x_value = .data[[x_var]]
    )
  
  # Build the plot
  p <- ggplot(plot_data, aes(x = x_value, y = y_plot, color = sub_region)) +
    geom_point(size = 3, alpha = 0.7) +
    geom_smooth(method = "lm", se = TRUE, alpha = 0.2, linewidth = 1) +
    scale_color_manual(values = regioncolor) +
    labs(x = ifelse(x_var == "observed", "Bacterial Richness", "Bacterial Faith's PD"),
         y = y_label,
         title = title) +
    theme_bw() +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 11),
      axis.text = element_text(size = 9),
      plot.title = element_text(size = 10, hjust = 0.5),
      panel.grid.minor = element_blank()
    )
  
  # Add dashed horizontal line if specified
  if (!is.null(y_intercept)) {
    p <- p + geom_hline(yintercept = y_intercept, linetype = "dashed", 
                        color = "gray50", linewidth = 0.5)
  }
  
  return(p)
}

```

# =============================================================================
# FIGURE 4B: ELISA Scatter Plots
# =============================================================================
```{r Fig-4B-ELISA, message=FALSE, warning=FALSE}
B1 <- create_scatter_plot(ps1.v9.alpha2, "observed", "ESA.7.VISIT.11.CLB",
                          "ELISA titer (Log10)", "Env ELISA IgG-t gp140: Clade B (1990a)",
                          log_transform_y = TRUE, y_intercept = 2.19)

B2 <- create_scatter_plot(ps1.v9.alpha2, "observed", "ESA.7.VISIT.11.CLC",
                          "ELISA titer (Log10)", "Env ELISA IgG-t gp140: Clade C (C97ZA.012)",
                          log_transform_y = TRUE, y_intercept = 2.795)

B3 <- create_scatter_plot(ps1.v9.alpha2, "PD", "ESA.7.VISIT.11.CLB",
                          "ELISA titer (Log10)", "Env ELISA IgG-t gp140: Clade B (1990a)",
                          log_transform_y = TRUE, y_intercept = 2.19)

B4 <- create_scatter_plot(ps1.v9.alpha2, "PD", "ESA.7.VISIT.11.CLC",
                          "ELISA titer (Log10)", "Env ELISA IgG-t gp140: Clade C (C97ZA.012)",
                          log_transform_y = TRUE, y_intercept = 2.795)
```

# =============================================================================
# FIGURE 4C: ADCP Scatter Plots
# =============================================================================
```{r Fig-4C-ADCP, message=FALSE, warning=FALSE}
C1 <- create_scatter_plot(ps1.v9.alpha2, "observed", "ADCP.7.VISIT.11.COC",
                          "Phagocytic score", "ADCP Clade C (Con C)",
                          log_transform_y = FALSE, y_intercept = 6.49)

C2 <- create_scatter_plot(ps1.v9.alpha2, "observed", "ADCP.7.VISIT.11.MOS1",
                          "Phagocytic score", "ADCP Mos1",
                          log_transform_y = FALSE, y_intercept = 4.28)

C3 <- create_scatter_plot(ps1.v9.alpha2, "PD", "ADCP.7.VISIT.11.COC",
                          "Phagocytic score", "ADCP Clade C (Con C)",
                          log_transform_y = FALSE, y_intercept = 6.49)

C4 <- create_scatter_plot(ps1.v9.alpha2, "PD", "ADCP.7.VISIT.11.MOS1",
                          "Phagocytic score", "ADCP Mos1",
                          log_transform_y = FALSE, y_intercept = 4.28)
```

# =============================================================================
# FIGURE 4D: ELISpot Scatter Plots (12 panels)
# =============================================================================
```{r Fig-4D-ELISpot, message=FALSE, warning=FALSE}
# Row 1: Env Mos1 and Gag Mos1
D1 <- create_scatter_plot(ps1.v9.alpha2, "observed", "POT.6.VISIT.10.EM1",
                          "SFU (Log10) / 10e6 PBMC", "IFNg Env Mos1",
                          log_transform_y = TRUE, y_intercept = 1.86)

D2 <- create_scatter_plot(ps1.v9.alpha2, "observed", "POT.6.VISIT.10.GM1",
                          "SFU (Log10) / 10e6 PBMC", "IFNg Gag Mos1",
                          log_transform_y = TRUE, y_intercept = 1.94)

D3 <- create_scatter_plot(ps1.v9.alpha2, "PD", "POT.6.VISIT.10.EM1",
                          "SFU (Log10) / 10e6 PBMC", "IFNg Env Mos1",
                          log_transform_y = TRUE, y_intercept = 1.86)

D4 <- create_scatter_plot(ps1.v9.alpha2, "PD", "POT.6.VISIT.10.GM1",
                          "SFU (Log10) / 10e6 PBMC", "IFNg Gag Mos1",
                          log_transform_y = TRUE, y_intercept = 1.94)

# Row 2: Pol Mos1 and Pol Mos2
D5 <- create_scatter_plot(ps1.v9.alpha2, "observed", "POT.6.VISIT.10.PM1",
                          "SFU (Log10) / 10e6 PBMC", "IFNg Pol Mos1",
                          log_transform_y = TRUE, y_intercept = 1.8)

D6 <- create_scatter_plot(ps1.v9.alpha2, "observed", "POT.6.VISIT.10.PM2",
                          "SFU (Log10) / 10e6 PBMC", "IFNg Pol Mos2",
                          log_transform_y = TRUE, y_intercept = 1.74)

D7 <- create_scatter_plot(ps1.v9.alpha2, "PD", "POT.6.VISIT.10.PM1",
                          "SFU (Log10) / 10e6 PBMC", "IFNg Pol Mos1",
                          log_transform_y = TRUE, y_intercept = 1.8)

D8 <- create_scatter_plot(ps1.v9.alpha2, "PD", "POT.6.VISIT.10.PM2",
                          "SFU (Log10) / 10e6 PBMC", "IFNg Pol Mos2",
                          log_transform_y = TRUE, y_intercept = 1.74)

# Row 3: Gag PTE and Pol PTE
D9 <- create_scatter_plot(ps1.v9.alpha2, "observed", "POT.6.VISIT.10.GP",
                          "SFU (Log10) / 10e6 PBMC", "IFNg Gag PTE",
                          log_transform_y = TRUE, y_intercept = 2.26)

D10 <- create_scatter_plot(ps1.v9.alpha2, "observed", "POT.6.VISIT.10.PP",
                           "SFU (Log10) / 10e6 PBMC", "IFNg Pol PTE",
                           log_transform_y = TRUE, y_intercept = 2.02)

D11 <- create_scatter_plot(ps1.v9.alpha2, "PD", "POT.6.VISIT.10.GP",
                           "SFU (Log10) / 10e6 PBMC", "IFNg Gag PTE",
                           log_transform_y = TRUE, y_intercept = 2.26)

D12 <- create_scatter_plot(ps1.v9.alpha2, "PD", "POT.6.VISIT.10.PP",
                           "SFU (Log10) / 10e6 PBMC", "IFNg Pol PTE",
                           log_transform_y = TRUE, y_intercept = 2.02)
```

# =============================================================================
# FIGURE 4 ASSEMBLY (Panels B, C, D)
# =============================================================================
```{r Figure-4-assembly, message=FALSE, warning=FALSE}
# Assemble Panel B (ELISA - 4 plots in 1 row)
panel_B <- plot_grid(B1, B2, B3, B4, ncol = 4, align = "hv")

# Assemble Panel C (ADCP - 4 plots in 1 row)
panel_C <- plot_grid(C1, C2, C3, C4, ncol = 4, align = "hv")

# Assemble Panel D (ELISpot - 12 plots in 3 rows)
panel_D_row1 <- plot_grid(D1, D2, D3, D4, ncol = 4, align = "hv")
panel_D_row2 <- plot_grid(D5, D6, D7, D8, ncol = 4, align = "hv")
panel_D_row3 <- plot_grid(D9, D10, D11, D12, ncol = 4, align = "hv")

panel_D <- plot_grid(panel_D_row1, panel_D_row2, panel_D_row3, ncol = 1, align = "v")

# Add panel labels
panel_B_labeled <- plot_grid(NULL, panel_B, ncol = 1, rel_heights = c(0.05, 1),
                              labels = c("B.", ""), label_size = 14, label_fontface = "bold")
panel_C_labeled <- plot_grid(NULL, panel_C, ncol = 1, rel_heights = c(0.05, 1),
                              labels = c("C.", ""), label_size = 14, label_fontface = "bold")
panel_D_labeled <- plot_grid(NULL, panel_D, ncol = 1, rel_heights = c(0.02, 1),
                              labels = c("D.", ""), label_size = 14, label_fontface = "bold")

# Combine B, C, D panels
figure_4_BCD <- plot_grid(
  panel_B_labeled,
  panel_C_labeled,
  panel_D_labeled,
  ncol = 1,
  rel_heights = c(1, 1, 3)
)

# Save the figure (statistics to be added manually in image editor)
ggsave("figures/Figure_4_BCD.tiff", 
       figure_4_BCD, 
       width = 14, height = 18,
       dpi = 300, 
       compression = "lzw")

# Save individual panels
ggsave("figures/Figure_4B.tiff", panel_B, width = 14, height = 3.5, dpi = 300, compression = "lzw")
ggsave("figures/Figure_4C.tiff", panel_C, width = 14, height = 3.5, dpi = 300, compression = "lzw")
ggsave("figures/Figure_4D.tiff", panel_D, width = 14, height = 10, dpi = 300, compression = "lzw")

cat("Figure 4 panels saved to ./figures/\n")
```


# Supplemental Figure 4A, 4B, 4C
```{r Supplemental-Figure-4A-4B-4C}
regioncolor <- c("UG" ="#00468BFF", "RW" = "#42B540FF", "US" = "#ED0000FF")

# Plot S4A Richness
df9.ESA <- ps1.v9.alpha %>% 
    select(SampleID, sub_region, group, ESA.7.VISIT.11.CLA, ESA.7.VISIT.11.CLB, ESA.7.VISIT.11.CLC, ESA.7.VISIT.11.MOS1, ESA.7.VISIT.11.COC, observed, evenness_pielou, PD) %>% 
    pivot_longer(cols = starts_with("ESA"),
                 names_to = "Assay",
                 values_to = "Value") %>%
   group_by(Assay) %>%
    filter(group != "GROUP 8")

# Pairwise comparisons
pwc.ESA <- df9.ESA %>%
  group_by(Assay) %>% emmeans_test(Value ~ sub_region, covariate = observed,
    p.adjust.method = "holm")

pwc.ESA 

pwc.ESA <-  pwc.ESA %>% mutate(Assay2 =  if_else(Assay == "ESA.7.VISIT.11.CLA", "Clade A", ifelse(Assay == "ESA.7.VISIT.11.CLB", "Clade B", ifelse(Assay == "ESA.7.VISIT.11.CLC", "Clade C", ifelse(Assay == "ESA.7.VISIT.11.COC", "Clade C (Con C)", "Mos1")))))

pwc.ESA <-  pwc.ESA %>% mutate(group =  if_else(group1 == "RW" & group2 == "UG", "RWUG", ifelse(group1 == "RW" & group2 == "US", "RWUS", "UGUS")))
pwc.ESA <-  pwc.ESA %>% mutate(Assay2 = fct_reorder(Assay2, desc(Assay2))) 
pwc.ESA

pwcomparecolor <- c("RWUG" ="#440154", "RWUS" = "#1F948C", "UGUS" = "#F5191C")

S4A.1 <- ggplot(data=pwc.ESA, aes(y=Assay2, x=p.adj, color = group)) + 
  scale_color_manual(label = c("RWUG" ="RW VS UG", "RWUS" = "RW VS US", "UGUS" = "UG VS US"), values = pwcomparecolor)+
  labs(color = "Pairwise comparisons") +
   geom_jitter(aes(color = group), alpha = 0.65, size = 4,
                       position = position_jitter(width = 0.005, height = 0.3)) +
  labs(title='ELISA titer - Bacterial Richness', y='ELISA assay', x = 'Emmeans test: p-adjust value') +
  geom_vline(xintercept=0.05, color='black', linetype='dashed', alpha=.5) +
  scale_x_continuous(trans='log10', limits = c(0.0001, 1), labels = function(x) format(x, scientific = FALSE)) +
  theme_minimal()+
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    legend.background = element_rect(fill = "white", color = NA),
    legend.position="none",
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 15),
    plot.title = element_text(size = 18)
  )


# Plot S4B Richness
df9.ADCP <- ps1.v9.alpha %>% 
    select(SampleID, sub_region, group, ADCP.7.VISIT.11.CLA, ADCP.7.VISIT.11.CLB, ADCP.7.VISIT.11.MOS1, ADCP.7.VISIT.11.CLC,ADCP.7.VISIT.11.COC, observed, evenness_pielou, PD) %>% 
    pivot_longer(cols = starts_with("ADCP"),
                 names_to = "Assay",
                 values_to = "Value") %>%
   group_by(Assay) %>%
    filter(group != "GROUP 8")

# Pairwise comparisons
pwc.ADCP <- df9.ADCP %>%
  group_by(Assay) %>% emmeans_test(Value ~ sub_region, covariate = observed,
    p.adjust.method = "holm")

pwc.ADCP 

pwc.ADCP <-  pwc.ADCP %>% mutate(Assay2 =  if_else(Assay == "ADCP.7.VISIT.11.CLA", "Clade A", ifelse(Assay == "ADCP.7.VISIT.11.CLB", "Clade B", ifelse(Assay == "ADCP.7.VISIT.11.CLC", "Clade C", ifelse(Assay == "ADCP.7.VISIT.11.COC", "Clade C (Con C)", "Mos1")))))

pwc.ADCP <-  pwc.ADCP %>% mutate(group =  if_else(group1 == "RW" & group2 == "UG", "RWUG", ifelse(group1 == "RW" & group2 == "US", "RWUS", "UGUS")))
pwc.ADCP <-  pwc.ADCP %>% mutate(Assay2 = fct_reorder(Assay2, desc(Assay2))) 
pwc.ADCP

pwcomparecolor <- c("RWUG" ="#440154", "RWUS" = "#1F948C", "UGUS" = "#F5191C")

S4B.1 <- ggplot(data=pwc.ADCP, aes(y=Assay2, x=p.adj, color = group)) + 
  scale_color_manual(label = c("RWUG" ="RW VS UG", "RWUS" = "RW VS US", "UGUS" = "UG VS US"), values = pwcomparecolor)+
  labs(color = "Pairwise comparisons") +
   geom_jitter(aes(color = group), alpha = 0.65, size = 4,
                       position = position_jitter(width = 0.005, height = 0.3)) +
  labs(title="ADCP score - Bacterial Richness", y='ADCP assay', x = 'Emmeans test: p-adjust value') +
  geom_vline(xintercept=0.05, color='black', linetype='dashed', alpha=.5) +
  scale_x_continuous(trans='log10', limits = c(0.00001, 1.1), labels = function(x) format(x, scientific = FALSE)) +
  theme_minimal()+
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    legend.background = element_rect(fill = "white", color = NA),
    legend.position="none",
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 15),
    plot.title = element_text(size = 18)
  ) 

# Plot S4C Richness
df9.POT <- ps1.v9.alpha %>% 
    select(SampleID, sub_region, group, POT.6.VISIT.10.EM1, POT.6.VISIT.10.EM2, POT.6.VISIT.10.E1P, POT.6.VISIT.10.E2P, POT.6.VISIT.10.E3P, POT.6.VISIT.10.GP, POT.6.VISIT.10.GM1, POT.6.VISIT.10.GM2, POT.6.VISIT.10.PP, POT.6.VISIT.10.PM1, POT.6.VISIT.10.PM2, observed, evenness_pielou, PD) %>% 
    pivot_longer(cols = starts_with("POT"),
                 names_to = "Assay",
                 values_to = "Value") %>%
   group_by(Assay) %>%
    filter(group != "GROUP 8")

# Pairwise comparisons
pwc.POT <- df9.POT %>%
  group_by(Assay) %>% emmeans_test(Value ~ sub_region, covariate = observed,
    p.adjust.method = "holm")

pwc.POT 
pwc.POT <- pwc.POT %>% mutate(p.adj2 = ifelse(pwc.POT$p.adj <= 0.00001, 0.00001, pwc.POT$p.adj))

pwc.POT<-  pwc.POT%>% mutate(Assay2 =  if_else(Assay == "POT.6.VISIT.10.EM1", "Env Mos1", ifelse(Assay == "POT.6.VISIT.10.EM2", "Env Mos2", ifelse(Assay == "POT.6.VISIT.10.GM1", "Gag Mos1", ifelse(Assay == "POT.6.VISIT.10.GM2", "Gag Mos2", ifelse(Assay == "POT.6.VISIT.10.PM1", "Pol Mos1", ifelse(Assay == "POT.6.VISIT.10.PM2", "Pol Mos2", ifelse(Assay == "POT.6.VISIT.10.E1P", "Env1 PTE", ifelse(Assay == "POT.6.VISIT.10.E2P", "Env2 PTE", ifelse(Assay == "POT.6.VISIT.10.E3P", "Env3 PTE", ifelse(Assay == "POT.6.VISIT.10.GP", "Gag PTE", "Pol PTE")))))))))))

pwc.POT<-  pwc.POT%>% mutate(group =  if_else(group1 == "RW" & group2 == "UG", "RWUG", ifelse(group1 == "RW" & group2 == "US", "RWUS", "UGUS")))

pwc.POT<-  pwc.POT%>% mutate(Order =  if_else(Assay == "POT.6.VISIT.10.EM1", "A", ifelse(Assay == "POT.6.VISIT.10.EM2", "B", ifelse(Assay == "POT.6.VISIT.10.GM1", "C", ifelse(Assay == "POT.6.VISIT.10.GM2", "D", ifelse(Assay == "POT.6.VISIT.10.PM1", "E", ifelse(Assay == "POT.6.VISIT.10.PM2", "F", ifelse(Assay == "POT.6.VISIT.10.E1P", "G", ifelse(Assay == "POT.6.VISIT.10.E2P", "H", ifelse(Assay == "POT.6.VISIT.10.E3P", "I", ifelse(Assay == "POT.6.VISIT.10.GP", "J", "K")))))))))))

pwc.POT<-  pwc.POT%>% mutate(Assay2 = fct_reorder(Assay2, desc(Order))) 


pwcomparecolor <- c("RWUG" ="#440154", "RWUS" = "#1F948C", "UGUS" = "#F5191C")

S4C.1 <- ggplot(data=pwc.POT, aes(y=Assay2, x=p.adj2, color = group)) + 
  scale_color_manual(label = c("RWUG" ="RW VS UG", "RWUS" = "RW VS US", "UGUS" = "UG VS US"), values = pwcomparecolor)+
  labs(color = "Pairwise comparisons") +
   geom_jitter(aes(color = group), alpha = 0.65, size = 4,
                       position = position_jitter(width = 0.005, height = 0.3)) +
  labs(title="ELISPOT SFU - Bacterial Richness", y='ELISPOT assay', x = 'Emmeans test: p-adjust value') +
  geom_vline(xintercept=0.05, color='black', linetype='dashed', alpha=.5) +
  scale_x_continuous(trans='log10', limits = c(0.000001, 1.01), labels = function(x) format(x, scientific = FALSE)) +
  theme_minimal()+
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    legend.background = element_rect(fill = "white", color = NA),
    legend.position = "bottom",
    legend.box.just = "left",
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0),
    legend.box.margin = margin(t = 0, r = 0, b = 0, l = 0),
    legend.box.spacing = unit(0, "pt"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 15),
    plot.title = element_text(size = 18)
  )

# Plot S4A Faith's PD
# Pairwise comparisons Figure S4A.2
pwc.ESA <- df9.ESA %>%
  group_by(Assay) %>% emmeans_test(Value ~ sub_region, covariate = PD,
    p.adjust.method = "holm")

pwc.ESA 

pwc.ESA <-  pwc.ESA %>% mutate(Assay2 =  if_else(Assay == "ESA.7.VISIT.11.CLA", "Clade A", ifelse(Assay == "ESA.7.VISIT.11.CLB", "Clade B", ifelse(Assay == "ESA.7.VISIT.11.CLC", "Clade C", ifelse(Assay == "ESA.7.VISIT.11.COC", "Clade C (Con C)", "Mos1")))))

pwc.ESA <-  pwc.ESA %>% mutate(group =  if_else(group1 == "RW" & group2 == "UG", "RWUG", ifelse(group1 == "RW" & group2 == "US", "RWUS", "UGUS")))
pwc.ESA <-  pwc.ESA %>% mutate(Assay2 = fct_reorder(Assay2, desc(Assay2))) 
pwc.ESA

pwcomparecolor <- c("RWUG" ="#440154", "RWUS" = "#1F948C", "UGUS" = "#F5191C")

S4A.2 <- ggplot(data=pwc.ESA, aes(y=Assay2, x=p.adj, color = group)) + 
  scale_color_manual(label = c("RWUG" ="RW VS UG", "RWUS" = "RW VS US", "UGUS" = "UG VS US"), values = pwcomparecolor)+
  labs(color = "Pairwise comparisons") +
   geom_jitter(aes(color = group), alpha = 0.65, size = 4,
                       position = position_jitter(width = 0.005, height = 0.3)) +
  labs(title="ELISA titer - Bacterial Faith's PD", y='ELISA assay', x = 'Emmeans test: p-adjust value') +
  geom_vline(xintercept=0.05, color='black', linetype='dashed', alpha=.5) +
  scale_x_continuous(trans='log10', limits = c(0.0001, 1), labels = function(x) format(x, scientific = FALSE)) +
  theme_minimal()+
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    legend.background = element_rect(fill = "white", color = NA),
    legend.position="none",
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 15),
    plot.title = element_text(size = 18)
  )

# Plot S4B Faith's PD
# Pairwise comparisons
pwc.ADCP <- df9.ADCP %>%
  group_by(Assay) %>% emmeans_test(Value ~ sub_region, covariate = PD,
    p.adjust.method = "holm")

pwc.ADCP 

pwc.ADCP <-  pwc.ADCP %>% mutate(Assay2 =  if_else(Assay == "ADCP.7.VISIT.11.CLA", "Clade A", ifelse(Assay == "ADCP.7.VISIT.11.CLB", "Clade B", ifelse(Assay == "ADCP.7.VISIT.11.CLC", "Clade C", ifelse(Assay == "ADCP.7.VISIT.11.COC", "Clade C (Con C)", "Mos1")))))

pwc.ADCP <-  pwc.ADCP %>% mutate(group =  if_else(group1 == "RW" & group2 == "UG", "RWUG", ifelse(group1 == "RW" & group2 == "US", "RWUS", "UGUS")))
pwc.ADCP <-  pwc.ADCP %>% mutate(Assay2 = fct_reorder(Assay2, desc(Assay2))) 
pwc.ADCP

pwcomparecolor <- c("RWUG" ="#440154", "RWUS" = "#1F948C", "UGUS" = "#F5191C")

S4B.2 <- ggplot(data=pwc.ADCP, aes(y=Assay2, x=p.adj, color = group)) + 
  scale_color_manual(label = c("RWUG" ="RW VS UG", "RWUS" = "RW VS US", "UGUS" = "UG VS US"), values = pwcomparecolor)+
  labs(color = "Pairwise comparisons") +
   geom_jitter(aes(color = group), alpha = 0.65, size = 4,
                       position = position_jitter(width = 0.005, height = 0.3)) +
  labs(title="ADCP score - Bacterial Faith's PD", y='ADCP assay', x = 'Emmeans test: p-adjust value') +
  geom_vline(xintercept=0.05, color='black', linetype='dashed', alpha=.5) +
  scale_x_continuous(trans='log10', limits = c(0.00001, 1.1), labels = function(x) format(x, scientific = FALSE)) +
  theme_minimal()+
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    legend.background = element_rect(fill = "white", color = NA),
    legend.position="none",
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 15),
    plot.title = element_text(size = 18)
  ) 

# Plot S4C Faith's PD
# Pairwise comparisons
pwc.POT <- df9.POT %>%
  group_by(Assay) %>% emmeans_test(Value ~ sub_region, covariate = PD,
    p.adjust.method = "holm")

pwc.POT 

pwc.POT <- pwc.POT %>% mutate(p.adj2 = ifelse(pwc.POT$p.adj <= 0.00001, 0.00001, pwc.POT$p.adj))

pwc.POT<-  pwc.POT%>% mutate(Assay2 =  if_else(Assay == "POT.6.VISIT.10.EM1", "Env Mos1", ifelse(Assay == "POT.6.VISIT.10.EM2", "Env Mos2", ifelse(Assay == "POT.6.VISIT.10.GM1", "Gag Mos1", ifelse(Assay == "POT.6.VISIT.10.GM2", "Gag Mos2", ifelse(Assay == "POT.6.VISIT.10.PM1", "Pol Mos1", ifelse(Assay == "POT.6.VISIT.10.PM2", "Pol Mos2", ifelse(Assay == "POT.6.VISIT.10.E1P", "Env1 PTE", ifelse(Assay == "POT.6.VISIT.10.E2P", "Env2 PTE", ifelse(Assay == "POT.6.VISIT.10.E3P", "Env3 PTE", ifelse(Assay == "POT.6.VISIT.10.GP", "Gag PTE", "Pol PTE")))))))))))

pwc.POT<-  pwc.POT%>% mutate(group =  if_else(group1 == "RW" & group2 == "UG", "RWUG", ifelse(group1 == "RW" & group2 == "US", "RWUS", "UGUS")))

pwc.POT<-  pwc.POT%>% mutate(Order =  if_else(Assay == "POT.6.VISIT.10.EM1", "A", ifelse(Assay == "POT.6.VISIT.10.EM2", "B", ifelse(Assay == "POT.6.VISIT.10.GM1", "C", ifelse(Assay == "POT.6.VISIT.10.GM2", "D", ifelse(Assay == "POT.6.VISIT.10.PM1", "E", ifelse(Assay == "POT.6.VISIT.10.PM2", "F", ifelse(Assay == "POT.6.VISIT.10.E1P", "G", ifelse(Assay == "POT.6.VISIT.10.E2P", "H", ifelse(Assay == "POT.6.VISIT.10.E3P", "I", ifelse(Assay == "POT.6.VISIT.10.GP", "J", "K")))))))))))

pwc.POT<-  pwc.POT%>% mutate(Assay2 = fct_reorder(Assay2, desc(Order))) 

pwcomparecolor <- c("RWUG" ="#440154", "RWUS" = "#1F948C", "UGUS" = "#F5191C")

S4C.2 <- ggplot(data=pwc.POT, aes(y=Assay2, x=p.adj2, color = group)) + 
  scale_color_manual(label = c("RWUG" ="RW VS UG", "RWUS" = "RW VS US", "UGUS" = "UG VS US"), values = pwcomparecolor)+
  labs(color = "Pairwise comparisons") +
   geom_jitter(aes(color = group), alpha = 0.65, size = 4,
                       position = position_jitter(width = 0.005, height = 0.3)) +
  labs(title="ELISPOT SFU - Bacterial Faith's PD", y='ELISPOT assay', x = 'Emmeans test: p-adjust value') +
  geom_vline(xintercept=0.05, color='black', linetype='dashed', alpha=.5) +
  scale_x_continuous(trans='log10', limits = c(0.000001, 1.01), labels = function(x) format(x, scientific = FALSE)) +
  theme_minimal()+
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    legend.background = element_rect(fill = "white", color = NA),
    legend.position = "bottom",
    legend.box.just = "left",
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0),
    legend.box.margin = margin(t = 0, r = 0, b = 0, l = 0),
    legend.box.spacing = unit(0, "pt"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 13),
    legend.title = element_text(size = 15),
    plot.title = element_text(size = 18)
  )

```

# Final Supplemental Figure 4
```{r figure S4}
# First row with A
first_row <- plot_grid(
  S4A.1, S4A.2,
  ncol = 2,
  rel_widths = c(1, 1),
  labels = "A.",
  label_size = 16,
  label_fontface = "bold"
)

# 2nd row with B
# Create second row
second_row <- plot_grid(
  S4B.1, S4B.2,
  ncol = 2,
  rel_widths = c(1, 1),
  labels = "B.",
  label_size = 16,
  label_fontface = "bold"
)

# Create third row 
third_row <- plot_grid(
  S4C.1, S4C.2,  
  ncol = 2,
  rel_widths = c(1, 1),
  labels = "C.",
  label_size = 16,
  label_fontface = "bold"
)

# Combine all rows into final figure
SF4_final_figure <- plot_grid(
  first_row,
  second_row,
  third_row,
  ncol = 1,
  rel_heights = c(1, 1, 2)  # Adjust based on actual plot proportions 
)

# Save the final figure
ggsave("figures/Supplemental_figure_4.tiff", 
       SF4_final_figure, 
       width = 16, height = 16,  # Adjust height as needed
       dpi = 300, 
       compression = "lzw")

```

# Fig 5A, 5B stats
```{r Fig-5A-5B-stats}
# Read the input file
input_file <- "./data/Sumary_of_ASV_count_in_RWUS_V9_SAMPLES_fin.csv"
df <- read_csv(input_file)

# Filter for the phyla of interest
phyla_of_interest <- c("Bacillota", "Bacteroidota")
filtered_df <- df %>% filter(Phylum %in% phyla_of_interest)

# Initialize empty data frame for results
comparison_results <- data.frame(
  Phylum = character(),
  Sub_region = character(),
  Assay = character(),
  NR = character(),
  R = character(),
  PValue = numeric(),
  Significance = character(),
  IsSignificant = logical(),
  Total = numeric(),
  Comparison = character(),
  stringsAsFactors = FALSE
)

# Get unique assays
assays <- unique(filtered_df$Assay)

# Perform Fisher's exact test for each phylum and assay combination
for (phylum in phyla_of_interest) {
  phylum_data <- filtered_df %>% filter(Phylum == phylum)
  
  for (assay in assays) {
    assay_data <- phylum_data %>% filter(Assay == assay)
    
    # Skip if we don't have both RW and US data for this combination
    if (!all(c("RW", "US") %in% assay_data$Sub_region)) {
      next
    }
    
    # Get RW and US data
    rw_data <- assay_data %>% filter(Sub_region == "RW")
    us_data <- assay_data %>% filter(Sub_region == "US")
    
    if (nrow(rw_data) == 0 || nrow(us_data) == 0) {
      next
    }
    
    # For NR comparison
    # Contingency table: [[NR_RW, NonNR_RW], [NR_US, NonNR_US]]
    nr_rw <- rw_data$NR
    non_nr_rw <- rw_data$Total - nr_rw
    nr_us <- us_data$NR
    non_nr_us <- us_data$Total - nr_us
    
    # Perform Fisher's exact test for NR
    nr_table <- matrix(c(nr_rw, non_nr_rw, nr_us, non_nr_us), nrow = 2)
    nr_test <- fisher.test(nr_table)
    nr_pvalue <- nr_test$p.value
    
    # Determine significance
    nr_significance <- ifelse(nr_pvalue < 0.05, "*", "ns")
    nr_is_significant <- nr_pvalue < 0.05
    
    # Add to results
    comparison_results <- rbind(comparison_results, data.frame(
      Phylum = phylum,
      Sub_region = "RW vs US",
      Assay = assay,
      NR = paste0(nr_rw, "/", (nr_rw + non_nr_rw), " vs ", nr_us, "/", (nr_us + non_nr_us)),
      R = "-",  # Not applicable for NR comparison
      PValue = nr_pvalue,
      Significance = nr_significance,
      IsSignificant = nr_is_significant,
      Total = nr_rw + non_nr_rw + nr_us + non_nr_us,
      Comparison = "RW vs US (NR)",
      stringsAsFactors = FALSE
    ))
    
    # For R comparison
    # Contingency table: [[R_RW, NonR_RW], [R_US, NonR_US]]
    r_rw <- rw_data$R
    non_r_rw <- rw_data$Total - r_rw
    r_us <- us_data$R
    non_r_us <- us_data$Total - r_us
    
    # Perform Fisher's exact test for R
    r_table <- matrix(c(r_rw, non_r_rw, r_us, non_r_us), nrow = 2)
    r_test <- fisher.test(r_table)
    r_pvalue <- r_test$p.value
    
    # Determine significance
    r_significance <- ifelse(r_pvalue < 0.05, "*", "ns")
    r_is_significant <- r_pvalue < 0.05
    
    # Add to results
    comparison_results <- rbind(comparison_results, data.frame(
      Phylum = phylum,
      Sub_region = "RW vs US",
      Assay = assay,
      NR = "-",  # Not applicable for R comparison
      R = paste0(r_rw, "/", (r_rw + non_r_rw), " vs ", r_us, "/", (r_us + non_r_us)),
      PValue = r_pvalue,
      Significance = r_significance,
      IsSignificant = r_is_significant,
      Total = r_rw + non_r_rw + r_us + non_r_us,
      Comparison = "RW vs US (R)",
      stringsAsFactors = FALSE
    ))
  }
}

# Create output directory if it doesn't exist
dir.create("./figures", showWarnings = FALSE)

# Save all comparisons
all_comparisons_file <- "./data/Fig_5A_5B_fishers_exact_test_results.csv"
write_csv(comparison_results, all_comparisons_file)

# Filter and save significant comparisons
significant_df <- comparison_results %>% filter(IsSignificant == TRUE)
significant_file <- "./data/Fig_5A_5B_significant_fishers_exact_test_results.csv"
write_csv(significant_df, significant_file)

cat("Analysis complete. Results saved to:\n")
cat("  - All comparisons:", all_comparisons_file, "\n")
cat("  - Significant comparisons:", significant_file, "\n")
```

# Fig 5A 5B plot
```{r load_data}
# Load the data
data <- read.csv("./data/Fig_5A_5B_fishers_exact_test_results.csv")

# Function to extract counts from the strings like "9/1334 vs 2/1011"
extract_count <- function(x) {
  if (x == "-") return(NA)
  parts <- strsplit(x, " vs ")[[1]]
  left_count <- as.numeric(strsplit(parts[1], "/")[[1]][1])
  right_count <- as.numeric(strsplit(parts[2], "/")[[1]][1])
  return(c(left_count, right_count))
}

# Process the data - create separate rows for RW and US
processed_data <- do.call(rbind, lapply(1:nrow(data), function(i) {
  row <- data[i,]
  # Create two rows - one for RW and one for US
  rbind(
    # RW row
    tibble(
      Phylum = row$Phylum,
      Sub_region = "RW",
      Assay = row$Assay,
      NR_counts = if (row$NR == "-") NA_integer_ else extract_count(row$NR)[1],
      R_counts = if (row$R == "-") NA_integer_ else extract_count(row$R)[1],
      PValue = row$PValue,
      Significance = row$Significance,
      IsSignificant = row$IsSignificant
    ),
    # US row
    tibble(
      Phylum = row$Phylum,
      Sub_region = "US",
      Assay = row$Assay,
      NR_counts = if (row$NR == "-") NA_integer_ else extract_count(row$NR)[2],
      R_counts = if (row$R == "-") NA_integer_ else extract_count(row$R)[2],
      PValue = row$PValue,
      Significance = row$Significance,
      IsSignificant = row$IsSignificant
    )
  )
}))

# Define the order of assays as specified
adcp_list <- c("Clade A", "Clade B", "Clade C", "Clade C (Con C)", "Mos 1")
elispot_list <- c("Env Mos1", "Env Mos2", "Gag Mos1", "Gag Mos2", "Pol Mos1", "Pol Mos2", 
                  "Env1 PTE", "Env2 PTE", "Env3 PTE", "Gag PTE", "Pol PTE")

# Prepare data for plotting
plot_data <- processed_data %>%
  filter(!is.na(NR_counts) | !is.na(R_counts)) %>%
  mutate(
    Assay_type = ifelse(Assay %in% adcp_list, "ADCP", "ELISPOT"),
    Assay = factor(Assay, levels = c(adcp_list, elispot_list))
  ) %>%
  select(Phylum, Sub_region, Assay, Assay_type, NR_counts, R_counts, Significance, IsSignificant)

# Debug: Print the structure of the processed data
print(str(plot_data))
print(table(plot_data$Sub_region, plot_data$Phylum, plot_data$Assay_type))

# Split data for different panels
bacteroidota_data <- plot_data %>% filter(Phylum == "Bacteroidota")
bacillota_data <- plot_data %>% filter(Phylum == "Bacillota")
```

```{r create_complete_plot}
# First, load required packages
library(grid)
library(gridExtra)
library(cowplot)

# Create a new function for single sub-panel plots that includes custom facet text
create_single_plot <- function(data, phylum, region, assay_type, show_x_axis = FALSE, show_legend = FALSE) {
  # Filter data for this specific combination
  filtered_data <- data %>%
    filter(Phylum == phylum, Sub_region == region, Assay_type == assay_type)
  
  # Convert to long format for plotting
  long_data <- filtered_data %>%
    pivot_longer(
      cols = c(NR_counts, R_counts),
      names_to = "Response",
      values_to = "Count"
    ) %>%
    mutate(
      Response = ifelse(Response == "NR_counts", "NR", "R"),
      # Negate NR counts for plotting on the left side
      Plot_count = ifelse(Response == "NR", -Count, Count),
      # Create labels with significance if applicable
      Label = ifelse(
        IsSignificant & !is.na(Count), 
        paste0(Count, " ", Significance), 
        as.character(Count)
      ),
      # Only show labels for non-zero counts
      Label = ifelse(is.na(Count) | Count == 0, "", Label)
    )
  
  # Create a list of assays for this assay type
  assay_list <- if(assay_type == "ADCP") adcp_list else elispot_list
  
  # Create the plot
  p <- ggplot(long_data, aes(x = Plot_count, y = Assay, fill = Response)) +
    geom_col(position = position_dodge(0.7), width = 0.6) +
    geom_text(aes(label = Label),
              position = position_dodge(0.7),
              hjust = ifelse(long_data$Response == "NR", 1.2, -0.2),
              size = 3) +
    scale_fill_manual(values = c("NR" = "forestgreen", "R" = "firebrick3"),
                      labels = c("NR" = "Non-responder", "R" = "Responder"),
                      name = "Response") +
    scale_x_continuous(
      limits = c(-25, 25),
      breaks = c(-20, -10, 0, 10, 20),
      labels = c("20", "10", "0", "10", "20")
    ) +
    scale_y_discrete(limits = rev(assay_list)) +
    # Only show x-axis title if specified
    labs(
      x = if(show_x_axis) "ASV Counts" else "", 
      y = NULL,
      # Only use phylum and region as title for the top row
      title = if(assay_type == "ADCP") {
        if(region == "RW") paste0(phylum, "\nRW") else paste0(phylum, "\nUS")
      } else {
        "" # No title for ELISPOT rows
      }
    ) +
    theme_bw() +
    theme(
      # Only show legend if specified
      legend.position = if(show_legend) "bottom" else "none",
      # Remove grid lines
      panel.grid.major.y = element_blank(),
      panel.grid.minor = element_blank(),
      # Format title as a facet label
      plot.title = element_text(
        size = 12, face = "bold", hjust = 0.5,
        margin = margin(b = 10)
      ),
      # Adjust margins to minimize space
      plot.margin = unit(c(2, 2, 2, 2), "pt"),
      # Show y-axis text only on the left side plots
      axis.text.y = if(region == "RW") element_text(size = 9) else element_blank(),
      # Control x-axis text and title
      axis.text.x = if(show_x_axis) element_text(size = 9) else element_blank(),
      axis.title.x = if(show_x_axis) element_text(size = 10) else element_blank(),
      axis.ticks.x = if(show_x_axis) element_line() else element_blank()
    )
  
  # Return the plot
  return(p)
}

# Create individual plots for each panel with specified parameters - NO legends in individual plots
# Panel A (Bacteroidota)
a_top_left <- create_single_plot(bacteroidota_data, "Bacteroidota", "RW", "ADCP")
a_top_right <- create_single_plot(bacteroidota_data, "Bacteroidota", "US", "ADCP")
a_bottom_left <- create_single_plot(bacteroidota_data, "Bacteroidota", "RW", "ELISPOT", 
                                   show_x_axis = TRUE, show_legend = FALSE)
a_bottom_right <- create_single_plot(bacteroidota_data, "Bacteroidota", "US", "ELISPOT", 
                                    show_x_axis = TRUE, show_legend = TRUE)

# Panel B (Bacillota)
b_top_left <- create_single_plot(bacillota_data, "Bacillota", "RW", "ADCP")
b_top_right <- create_single_plot(bacillota_data, "Bacillota", "US", "ADCP")
b_bottom_left <- create_single_plot(bacillota_data, "Bacillota", "RW", "ELISPOT", 
                                   show_x_axis = TRUE, show_legend = FALSE)
b_bottom_right <- create_single_plot(bacillota_data, "Bacillota", "US", "ELISPOT", 
                                    show_x_axis = TRUE, show_legend = TRUE)

# Create grobs for "ADCP" and "ELISPOT" vertical text 
adcp_text <- textGrob("ADCP", rot = 270, gp = gpar(fontsize = 12, fontface = "bold"))
elispot_text <- textGrob("ELISPOT", rot = 270, gp = gpar(fontsize = 12, fontface = "bold"))

# Create panel labels
a_label <- textGrob("A.", gp = gpar(fontsize = 16, fontface = "bold"), x = 0.02, y = 0.98, just = c("left", "top"))
b_label <- textGrob("B.", gp = gpar(fontsize = 16, fontface = "bold"), x = 0.02, y = 0.98, just = c("left", "top"))

# Use cowplot for a cleaner layout
# First create the top row for panel A with consistent sizing
a_top_row <- cowplot::plot_grid(
  a_top_left + 
    theme(plot.margin = margin(5, 5, 5, 5)),
  a_top_right + 
    theme(plot.margin = margin(5, 20, 5, 5)),  # extra right margin for the rotated label
  nrow = 1,
  rel_widths = c(1, 1),
  align = "h",
  axis = "tb"   # align horizontally and match top/bottom dimensions
)

# Add the rotated "ADCP" label to the right of the top right plot in panel A
a_top_row_with_label <- ggdraw(a_top_row) +
  draw_label("ADCP", x = 0.985, y = 0.5, size = 12, fontface = "bold", 
             hjust = 0.5, vjust = 0.5, angle = 270)

# Create the bottom row for panel A with consistent sizing
a_bottom_row <- cowplot::plot_grid(
  a_bottom_left + 
    theme(plot.margin = margin(5, 5, 5, 5)),
  a_bottom_right + 
    theme(plot.margin = margin(5, 20, 5, 5)),  # extra right margin for the rotated label
  nrow = 1,
  rel_widths = c(1, 1),
  align = "h",
  axis = "tb"   # align horizontally and match top/bottom dimensions
)

# Add the rotated "ELISPOT" label to the right of the bottom right plot in panel A
a_bottom_row_with_label <- ggdraw(a_bottom_row) +
  draw_label("ELISPOT", x = 0.985, y = 0.5, size = 12, fontface = "bold", 
             hjust = 0.5, vjust = 0.5, angle = 270)

# Combine the rows for panel A with consistent heights
panel_a <- cowplot::plot_grid(
  a_top_row_with_label,
  a_bottom_row_with_label,
  nrow = 2,
  rel_heights = c(1, 1),
  align = "v",
  axis = "lr"  # align vertically and match left/right dimensions
)

# Add the 'A.' label to the top left
panel_a_with_label <- ggdraw(panel_a) +
  draw_label("A.", x = 0.02, y = 0.98, size = 16, fontface = "bold", 
             hjust = 0, vjust = 1)

# Repeat the process for panel B with consistent sizing
b_top_row <- cowplot::plot_grid(
  b_top_left + 
    theme(plot.margin = margin(5, 5, 5, 5)),
  b_top_right + 
    theme(plot.margin = margin(5, 20, 5, 5)),
  nrow = 1,
  rel_widths = c(1, 1),
  align = "h",
  axis = "tb"   # align horizontally and match top/bottom dimensions
)

b_top_row_with_label <- ggdraw(b_top_row) +
  draw_label("ADCP", x = 0.985, y = 0.5, size = 12, fontface = "bold", 
             hjust = 0.5, vjust = 0.5, angle = 270)

b_bottom_row <- cowplot::plot_grid(
  b_bottom_left + 
    theme(plot.margin = margin(5, 5, 5, 5)),
  b_bottom_right + 
    theme(plot.margin = margin(5, 20, 5, 5)),
  nrow = 1,
  rel_widths = c(1, 1),
  align = "h",
  axis = "tb"   # align horizontally and match top/bottom dimensions
)

b_bottom_row_with_label <- ggdraw(b_bottom_row) +
  draw_label("ELISPOT", x = 0.985, y = 0.5, size = 12, fontface = "bold", 
             hjust = 0.5, vjust = 0.5, angle = 270)

panel_b <- cowplot::plot_grid(
  b_top_row_with_label,
  b_bottom_row_with_label,
  nrow = 2,
  rel_heights = c(1, 1),
  align = "v",
  axis = "lr"  # align vertically and match left/right dimensions
)

panel_b_with_label <- ggdraw(panel_b) +
  draw_label("B.", x = 0.02, y = 0.98, size = 16, fontface = "bold", 
             hjust = 0, vjust = 1)

# Create a standalone legend plot
legend_plot <- ggplot(data.frame(Response = c("NR", "R")), 
                    aes(x = Response, y = 1, fill = Response)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("NR" = "forestgreen", "R" = "firebrick3"),
                   labels = c("NR" = "Non-responder", "R" = "Responder"),
                   name = "Response") +
  theme_void() +
  theme(legend.position = "bottom",
        legend.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 11),
        legend.key.size = unit(0.8, "cm"))

# Extract just the legend from this plot
legend <- cowplot::get_legend(legend_plot)

# Arrange panels A and B side by side with their labels
panels_layout <- cowplot::plot_grid(
  panel_a_with_label, panel_b_with_label,
  ncol = 2,
  rel_widths = c(1, 1),
  # Make sure all panels have the same dimensions
  align = "hv",
  axis = "tblr"
)


```

# Final Figure 5
```{r save_plot}
# For TIFF format
ggsave("figures/Figure_5A_5B.tiff", 
       panels_layout, 
       width = 14, height = 8,  # Adjust height as needed
       dpi = 300, 
       units = "in",
       compression = "lzw")

```

# Supplemental Fig 5A, 5B stats
```{r Supplemental-Fig-5A-5B-stats}
# Function to determine significance asterisks
get_significance_asterisks <- function(p_value) {
  if (p_value < 0.0001) return("*****")
  if (p_value < 0.001) return("****")
  if (p_value < 0.01) return("***")
  if (p_value < 0.05) return("**")
  if (p_value < 0.1) return("*")
  return("ns")
}

# Read the CSV file
data <- fread("./data/Sumary_of_ASV_count_in_RWUS_V9_SAMPLES_fin.csv")

# Prepare results data table
results <- data.table(
  Phylum = character(),
  Sub_region = character(),
  Assay = character(),
  NR = integer(),
  R = integer(),
  PValue = numeric(),
  Significance = character(),
  IsSignificant = logical(),
  Comparison = character()
)

# Perform Fisher's exact test for each row
for (i in 1:nrow(data)) {
  # Extract row data
  row_data <- data[i]
  
  # Prepare contingency table
  responder <- c(row_data$NR, row_data$R)
  no.responders <- c(row_data$Total - row_data$NR, row_data$Total - row_data$R)
  
  # Create contingency table
  cont_table <- as.table(rbind(responder, no.responders))
  
  # Perform Fisher's exact test
  fisher_result <- fisher.test(cont_table)
  
  # Determine significance
  p_value <- fisher_result$p.value
  asterisks <- get_significance_asterisks(p_value)
  is_significant <- p_value < 0.05
  
  # Add to results
  temp_result <- data.table(
    Phylum = row_data$Phylum,
    Sub_region = row_data$Sub_region,
    Assay = row_data$Assay,
    NR = row_data$NR,
    R = row_data$R,
    Total = row_data$Total,
    PValue = p_value,
    Significance = asterisks,
    IsSignificant = is_significant,
    Comparison = "NR vs R"
  )
  
  # Append to results
  results <- rbind(results, temp_result, fill = TRUE)
}

# Write full results to CSV
fwrite(results, "./data/S5A_S5B_fishers_exact_test_results.csv")

# Filter for significant results
significant_results <- results[IsSignificant == TRUE]

# Write significant results to CSV
fwrite(significant_results, "./data/S5A_S5B_significant_fishers_exact_test_results.csv")

```

# Supplemental Fig 5A, 5B plot
```{r load_data}
# Load the data
data <- read.csv("./data/S5A_S5B_fishers_exact_test_results.csv")

# Check data structure
str(data)

# Define the order of assays for each panel
adcp_list <- c("Clade A", "Clade B", "Clade C", "Clade C (Con C)", "Mos 1")
elispot1_list <- c("Env Mos1", "Env Mos2", "Gag Mos1", "Gag Mos2", "Pol Mos1", "Pol Mos2")
elispot2_list <- c("Env1 PTE", "Env2 PTE", "Env3 PTE", "Gag PTE", "Pol PTE")
elispot_list <- c(elispot1_list, elispot2_list)

# Get a list of all phyla that have at least 1 count in R or NR of 1 of the Sub_regions
phyla_with_counts <- data %>%
  filter(NR != "0" | R != "0") %>%
  distinct(Phylum) %>%
  pull(Phylum)

print(phyla_with_counts)

# Define order of phyla - reverse alphabetical order as requested
phyla_order <- sort(phyla_with_counts, decreasing = FALSE)
print(phyla_order)

# Process the data
processed_data <- data %>%
  mutate(
    Sub_region = as.character(Sub_region),
    NR = as.numeric(NR),
    R = as.numeric(R),
    Assay_type = case_when(
      Assay %in% adcp_list ~ "ADCP",
      Assay %in% elispot1_list ~ "ELISPOT1",
      Assay %in% elispot2_list ~ "ELISPOT2",
      TRUE ~ "Other"
    ),
    Assay = factor(Assay, levels = c(adcp_list, elispot1_list, elispot2_list)),
    # Phylum in reversed order (Actinomycetota at top, Verrucomicrobiota at bottom)
    Phylum = factor(Phylum, levels = phyla_order)
  ) %>%
  # Only keep phyla with at least one count
  filter(Phylum %in% phyla_with_counts)

# Replace "Clade C (Con C)" with "Clade C\n(Con C)"
processed_data$Assay <- as.character(processed_data$Assay)
processed_data$Assay = ifelse(processed_data$Assay == "Clade C (Con C)", "Clade C\n(Con C)", processed_data$Assay)
processed_data$Assay <- as.factor(processed_data$Assay)

# Prepare data for panel A (ADCP)
panel_a_data <- processed_data %>%
  filter(Assay_type == "ADCP")

# Prepare data for panel B1 (ELISPOT1)
panel_b1_data <- processed_data %>%
  filter(Assay_type == "ELISPOT1")

# Prepare data for panel B2 (ELISPOT2)
panel_b2_data <- processed_data %>%
  filter(Assay_type == "ELISPOT2")
```

```{r create_plot_function}
# Function to create a plot for a specific dataset - MODIFIED VERSION
create_plot <- function(data, assay_type, show_x_axis = TRUE) {
  # Convert to long format for plotting
  long_data <- data %>%
    pivot_longer(
      cols = c(NR, R),
      names_to = "Response",
      values_to = "Count"
    ) %>%
    mutate(
      # Negate NR counts for plotting on the left side
      Plot_count = ifelse(Response == "NR", -Count, Count),
      # Create labels with significance if applicable
      Label = ifelse(
        IsSignificant & !is.na(Count) & Count > 0, 
        paste0(Count, " ", Significance), 
        as.character(Count)
      ),
      # Only show labels for non-zero counts
      Label = ifelse(is.na(Count) | Count == 0, "", Label),
      # Create a factor with levels in reverse order for Phylum
      Phylum = factor(Phylum, levels = rev(c("Actinomycetota", "Bacillota", "Bacteroidota", 
                                         "Elusimicrobiota", "Methanobacteriota", 
                                         "Pseudomonadota", "Spirochaetota", "Verrucomicrobiota")))
    )
  
  # Get unique assays for this assay type
  unique_assays <- switch(assay_type,
                           "ADCP" = adcp_list,
                           "ELISPOT1" = elispot1_list,
                           "ELISPOT2" = elispot2_list)
  
  # Create the plot with Assay facet on the right side (270 degrees rotation)
  p <- ggplot(long_data, aes(x = Plot_count, y = Phylum, fill = Response)) +
    # Add a black dashed vertical line at 0
    geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
    geom_col(position = position_dodge(0.7), width = 0.6) +
    geom_text(aes(label = Label),
              position = position_dodge(0.7),
              hjust = ifelse(long_data$Response == "NR", 1.2, -0.2),  # Adjust hjust based on side
              size = 2.5) + # MODIFIED: Reduced text size for better fit
    scale_fill_manual(values = c("NR" = "forestgreen", "R" = "firebrick3"),
                      labels = c("NR" = "Non-responder", "R" = "Responder"),
                      name = "Response") +
    scale_x_continuous(
      name = if(show_x_axis) "ASV Counts" else "",
      limits = c(-25, 25),  # MODIFIED: Expanded limits to make more room
      breaks = c(-20, -10, 0, 10, 20),
      labels = c("20", "10", "0", "10", "20")
    ) +
    # Facet by Sub_region with Assay on the right with 270-degree rotation
    facet_grid(Assay ~ Sub_region, scales = "free_y") +
    labs(y = NULL) +
    theme_bw() +
    theme(
      panel.grid.major.y = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = "bottom",
      # Format facet labels
      strip.background = element_rect(fill = "white"),
      strip.text.y.left = element_text(angle = 0, hjust = 1, size = 9),
      # Make horizontal facet labels bold
      strip.text.x = element_text(size = 10, face = "bold", hjust = 0.5),
      # Rotate the Assay facet labels 270 degrees (on the right)
      strip.text.y.right = element_text(angle = 270, hjust = 0.5, size = 9, face = "bold"),
      strip.placement = "outside",
      # Control axis text
      axis.text.y = element_text(size = 8),
      axis.text.x = element_text(size = 8),
      axis.title.x = element_text(size = 10),
      # MODIFIED: Increased right margin to accommodate facet labels
      plot.margin = margin(5, 30, 5, 5)
    )
  
  return(p)
}
```

```{r create_panel_a}
# Create Panel A: ADCP data - No need for additional vertical label as it's in the facet
panel_a <- create_plot(panel_a_data, "ADCP", show_x_axis = TRUE)

# Add the title "A." to panel A
panel_a_final <- ggdraw(panel_a) + 
  draw_label("A.", x = 0.02, y = 0.98, size = 16, fontface = "bold", hjust = 0, vjust = 1)
```

```{r create_panel_b}
# Create Panel B1: ELISPOT1 data - No need for additional vertical label
panel_b1 <- create_plot(panel_b1_data, "ELISPOT1", show_x_axis = FALSE)

# Create Panel B2: ELISPOT2 data - No need for additional vertical label
panel_b2 <- create_plot(panel_b2_data, "ELISPOT2", show_x_axis = TRUE)

# Combine the two ELISPOT panels vertically
panel_b_combined <- plot_grid(
  panel_b1,
  panel_b2,
  ncol = 2,
  align = "v",
  axis = "lr",
  rel_heights = c(1, 1),
  # Adding extra spacing between the panels
  rel_widths = c(1, 1)
)

# Add the title "B." to panel B
panel_b_final <- ggdraw(panel_b_combined) + 
  draw_label("B.", x = 0.02, y = 0.98, size = 16, fontface = "bold", hjust = 0, vjust = 1)
```

```{r combine_panels}
# Combine Panel A and Panel B
final_figure <- plot_grid(
  panel_a_final,
  panel_b_final,
  ncol = 2,
  rel_widths = c(1, 2.1),  # MODIFIED: Increased relative width for panel B
  align = "v",
  axis = "lr"
)

# Preview the figure
print(final_figure)
```

# Final Supplemental Figure 5
```{r save_figure}
# Save as a compressed TIFF file
ggsave("./figures/Supplemental_Figure_5A_5B.tiff", final_figure, width = 14, height = 8.5, dpi = 300, compression = "lzw")

```

# Supplemental Table 5: LEfSe analysis at ASV level (not aggregated) RWUS
```{r, lefse_asv-RWUS}
  # Run LEfSe analysis at ASV level with OTU_IDs instead of genus names
# Add ASV IDs as Kingdom to trick LEfSe into using ASV-level resolution
  # Create a copy of the phyloseq object
  ps1_V9_RWUS_asv <- ps1_V9_RWUS
  taxa_names(ps1_V9_RWUS_asv) <- asv_mapping$OTU_ID[match(taxa_names(ps1_V9_RWUS), asv_mapping$ASV)]

  # Get the taxonomy table
  tax_table_current <- tax_table(ps1_V9_RWUS_asv)

  # Create a modified taxonomy table with ASV as Kingdom
  tax_df <- as.data.frame(tax_table_current)
  tax_df$Kingdom <- rownames(tax_df)  # Replace Kingdom with ASV IDs

  # Convert back to matrix and update the phyloseq object
  tax_matrix_new <- as.matrix(tax_df)
  rownames(tax_matrix_new) <- rownames(tax_df)
  tax_table(ps1_V9_RWUS_asv) <- tax_table(tax_matrix_new)

  # Verify the change
  head(tax_table(ps1_V9_RWUS_asv)[,1])  # Should show ASV IDs instead of "Bacteria"

  # Run LEfSe using "Kingdom" as the rank (which now contains ASV IDs)
  lefse_results <- run_lefse(
    ps1_V9_RWUS_asv,           # Modified phyloseq with ASVs as Kingdom
    group = "sub_region",      # Group for comparison
    taxa_rank = "Kingdom",     # Use "Kingdom" which now contains ASV IDs
    kw_cutoff = 0.05,          # Kruskal-Wallis test p-value cutoff
    wilcoxon_cutoff = 0.05,    # Wilcoxon test p-value cutoff
    lda_cutoff = 2.0           # LDA score threshold
  )

  # Extract markers as a regular data frame
  markers_df <- as.data.frame(lefse_results@marker_table)

  # Order by LDA score
  markers_df <- markers_df[order(-abs(markers_df$ef_lda)), ]
  
  # Create a separate dataframe for taxonomic information
  tax_info <- tax_df
  tax_info$ASV_ID <- rownames(tax_info)

  # Add taxonomic information without disrupting the marker table
  markers_display <- markers_df

  # Add taxonomy information by looking up values
  markers_display$Genus <- sapply(markers_display$feature, function(asv) {
    idx <- which(tax_info$ASV_ID == asv)
    if(length(idx) > 0) tax_info$Genus[idx[1]] else "Unknown"
  })

  # Create display labels
  markers_display$display_name <- paste0(markers_display$feature, " (", markers_display$Genus, ")")

  # Create custom LDA score plot
  p_lda_RWUS_asv <- ggplot(markers_display, aes(x = abs(ef_lda), y = reorder(display_name, abs(ef_lda)), fill = enrich_group)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = c("RW" = "#4DAF4A", "US" = "#E41A1C"),
                     name = "Enriched in") +
    theme_bw() +
    theme(axis.text.y = element_text(size = 9)) +
    xlab("LDA Score") +
    ylab("") +
    labs(title = "LEfSe Results")


  # Create a comprehensive table of significant ASVs from LEfSe
result_table <- data.frame(
    DESEQ2_OTU_ID = markers_display$feature,
    stringsAsFactors = FALSE
  )

  # Add ASV sequences from mapping
  result_table$ASV <- asv_mapping$ASV[match(result_table$DESEQ2_OTU_ID, asv_mapping$OTU_ID)]

  # Add LDA scores
  result_table$LDA_score <- round(abs(markers_display$ef_lda), 3)

  # Add abundance
  ps_rel <- transform_sample_counts(ps1_V9_RWUS, function(x) x*100/sum(x))
  ps_data <- psmelt(ps_rel)
  abundance_by_asv <- ps_data %>%
    group_by(OTU) %>%
    summarize(Relative_abundance = mean(Abundance))
  result_table$Relative_abundance <- abundance_by_asv$Relative_abundance[match(result_table$ASV, abundance_by_asv$OTU)]
  result_table$Relative_abundance <- round(result_table$Relative_abundance, 3)

  # Add taxonomy
  tax_table_df <- as.data.frame(tax_table(ps1_V9_RWUS))
  result_table$Kingdom <- "Bacteria"  # Set all to Bacteria
  tax_cols <- c("Phylum", "Class", "Order", "Family", "Genus", "Species")
  for (col in tax_cols) {
    result_table[[col]] <- tax_table_df[[col]][match(result_table$ASV, rownames(tax_table_df))]
  }

  # Write the result table
  write.csv(result_table, "./table/LEfSe_RWUS_significant_ASVs.csv", row.names = FALSE)
```

# Supplemental Table 5: Run LEfSe analysis at ASV level (not aggregated) USUG
```{r, lefse_asv-USUG}
  # Run LEfSe analysis at ASV level with OTU_IDs instead of genus names
# Add ASV IDs as Kingdom to trick LEfSe into using ASV-level resolution
  # Create a copy of the phyloseq object
  ps1_V9_USUG_asv <- ps1_V9_USUG
  taxa_names(ps1_V9_USUG_asv) <- asv_mapping$OTU_ID[match(taxa_names(ps1_V9_USUG), asv_mapping$ASV)]

  # Get the taxonomy table
  tax_table_current <- tax_table(ps1_V9_USUG_asv)

  # Create a modified taxonomy table with ASV as Kingdom
  tax_df <- as.data.frame(tax_table_current)
  tax_df$Kingdom <- rownames(tax_df)  # Replace Kingdom with ASV IDs

  # Convert back to matrix and update the phyloseq object
  tax_matrix_new <- as.matrix(tax_df)
  rownames(tax_matrix_new) <- rownames(tax_df)
  tax_table(ps1_V9_USUG_asv) <- tax_table(tax_matrix_new)

  # Verify the change
  head(tax_table(ps1_V9_USUG_asv)[,1])  # Should show ASV IDs instead of "Bacteria"

  # Run LEfSe using "Kingdom" as the rank (which now contains ASV IDs)
  lefse_results <- run_lefse(
    ps1_V9_USUG_asv,           # Modified phyloseq with ASVs as Kingdom
    group = "sub_region",      # Group for comparison
    taxa_rank = "Kingdom",     # Use "Kingdom" which now contains ASV IDs
    kw_cutoff = 0.05,          # Kruskal-Wallis test p-value cutoff
    wilcoxon_cutoff = 0.05,    # Wilcoxon test p-value cutoff
    lda_cutoff = 2.0           # LDA score threshold
  )

  # Extract markers as a regular data frame
  markers_df <- as.data.frame(lefse_results@marker_table)

  # Order by LDA score
  markers_df <- markers_df[order(-abs(markers_df$ef_lda)), ]
  
  # Create a separate dataframe for taxonomic information
  tax_info <- tax_df
  tax_info$ASV_ID <- rownames(tax_info)

  # Add taxonomic information without disrupting the marker table
  markers_display <- markers_df

  # Add taxonomy information by looking up values
  markers_display$Genus <- sapply(markers_display$feature, function(asv) {
    idx <- which(tax_info$ASV_ID == asv)
    if(length(idx) > 0) tax_info$Genus[idx[1]] else "Unknown"
  })

  # Create display labels
  markers_display$display_name <- paste0(markers_display$feature, " (", markers_display$Genus, ")")

  # Create custom LDA score plot
  p_lda_USUG_asv <- ggplot(markers_display, aes(x = abs(ef_lda), y = reorder(display_name, abs(ef_lda)), fill = enrich_group)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = c("US" = "#4DAF4A", "UG" = "#E41A1C"),
                     name = "Enriched in") +
    theme_bw() +
    theme(axis.text.y = element_text(size = 9)) +
    xlab("LDA Score") +
    ylab("") +
    labs(title = "LEfSe Results")

  # Create a comprehensive table of significant ASVs from LEfSe
result_table <- data.frame(
    DESEQ2_OTU_ID = markers_display$feature,
    stringsAsFactors = FALSE
  )

  # Add ASV sequences from mapping
  result_table$ASV <- asv_mapping$ASV[match(result_table$DESEQ2_OTU_ID, asv_mapping$OTU_ID)]

  # Add LDA scores
  result_table$LDA_score <- round(abs(markers_display$ef_lda), 3)

  # Add abundance
  ps_rel <- transform_sample_counts(ps1_V9_USUG, function(x) x*100/sum(x))
  ps_data <- psmelt(ps_rel)
  abundance_by_asv <- ps_data %>%
    group_by(OTU) %>%
    summarize(Relative_abundance = mean(Abundance))
  result_table$Relative_abundance <- abundance_by_asv$Relative_abundance[match(result_table$ASV, abundance_by_asv$OTU)]
  result_table$Relative_abundance <- round(result_table$Relative_abundance, 3)

  # Add taxonomy
  tax_table_df <- as.data.frame(tax_table(ps1_V9_USUG))
  result_table$Kingdom <- "Bacteria"  # Set all to Bacteria
  tax_cols <- c("Phylum", "Class", "Order", "Family", "Genus", "Species")
  for (col in tax_cols) {
    result_table[[col]] <- tax_table_df[[col]][match(result_table$ASV, rownames(tax_table_df))]
  }

  # Write the result table
  write.csv(result_table, "./table/LEfSe_USUG_significant_ASVs.csv", row.names = FALSE)
```

# Supplemental Table 5: Run LEfSe analysis at ASV level (not aggregated) RWUG
```{r, lefse_asv-RWUG}
  # Run LEfSe analysis at ASV level with OTU_IDs instead of genUG names
# Add ASV IDs as Kingdom to trick LEfSe into UGing ASV-level resolution
  # Create a copy of the phyloseq object
  ps1_V9_RWUG_asv <- ps1_V9_RWUG
  taxa_names(ps1_V9_RWUG_asv) <- asv_mapping$OTU_ID[match(taxa_names(ps1_V9_RWUG), asv_mapping$ASV)]

  # Get the taxonomy table
  tax_table_current <- tax_table(ps1_V9_RWUG_asv)

  # Create a modified taxonomy table with ASV as Kingdom
  tax_df <- as.data.frame(tax_table_current)
  tax_df$Kingdom <- rownames(tax_df)  # Replace Kingdom with ASV IDs

  # Convert back to matrix and update the phyloseq object
  tax_matrix_new <- as.matrix(tax_df)
  rownames(tax_matrix_new) <- rownames(tax_df)
  tax_table(ps1_V9_RWUG_asv) <- tax_table(tax_matrix_new)

  # Verify the change
  head(tax_table(ps1_V9_RWUG_asv)[,1])  # Should show ASV IDs instead of "Bacteria"

  # Run LEfSe UGing "Kingdom" as the rank (which now contains ASV IDs)
  lefse_results <- run_lefse(
    ps1_V9_RWUG_asv,           # Modified phyloseq with ASVs as Kingdom
    group = "sub_region",      # Group for comparison
    taxa_rank = "Kingdom",     # UGe "Kingdom" which now contains ASV IDs
    kw_cutoff = 0.05,          # KrUGkal-Wallis test p-value cutoff
    wilcoxon_cutoff = 0.05,    # Wilcoxon test p-value cutoff
    lda_cutoff = 2.0           # LDA score threshold
  )

  # Extract markers as a regular data frame
  markers_df <- as.data.frame(lefse_results@marker_table)

  # Order by LDA score
  markers_df <- markers_df[order(-abs(markers_df$ef_lda)), ]
  
  # Create a separate dataframe for taxonomic information
  tax_info <- tax_df
  tax_info$ASV_ID <- rownames(tax_info)

  # Add taxonomic information without disrupting the marker table
  markers_display <- markers_df

  # Add taxonomy information by looking up values
  markers_display$GenUG <- sapply(markers_display$feature, function(asv) {
    idx <- which(tax_info$ASV_ID == asv)
    if(length(idx) > 0) tax_info$GenUG[idx[1]] else "Unknown"
  })

  # Create display labels
  markers_display$display_name <- paste0(markers_display$feature, " (", markers_display$GenUG, ")")

  # Create cUGtom LDA score plot
  p_lda_RWUG_asv <- ggplot(markers_display, aes(x = abs(ef_lda), y = reorder(display_name, abs(ef_lda)), fill = enrich_group)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = c("RW" = "#4DAF4A", "UG" = "#E41A1C"),
                     name = "Enriched in") +
    theme_bw() +
    theme(axis.text.y = element_text(size = 9)) +
    xlab("LDA Score") +
    ylab("") +
    labs(title = "LEfSe Results")


  # Create a comprehensive table of significant ASVs from LEfSe
result_table <- data.frame(
    DESEQ2_OTU_ID = markers_display$feature,
    stringsAsFactors = FALSE
  )

  # Add ASV sequences from mapping
  result_table$ASV <- asv_mapping$ASV[match(result_table$DESEQ2_OTU_ID, asv_mapping$OTU_ID)]

  # Add LDA scores
  result_table$LDA_score <- round(abs(markers_display$ef_lda), 3)

  # Add abundance
  ps_rel <- transform_sample_counts(ps1_V9_RWUG, function(x) x*100/sum(x))
  ps_data <- psmelt(ps_rel)
  abundance_by_asv <- ps_data %>%
    group_by(OTU) %>%
    summarize(Relative_abundance = mean(Abundance))
  result_table$Relative_abundance <- abundance_by_asv$Relative_abundance[match(result_table$ASV, abundance_by_asv$OTU)]
  result_table$Relative_abundance <- round(result_table$Relative_abundance, 3)

  # Add taxonomy
  tax_table_df <- as.data.frame(tax_table(ps1_V9_RWUG))
  result_table$Kingdom <- "Bacteria"  # Set all to Bacteria
  tax_cols <- c("Phylum", "Class", "Order", "Family", "GenUG", "Species")
  for (col in tax_cols) {
    result_table[[col]] <- tax_table_df[[col]][match(result_table$ASV, rownames(tax_table_df))]
  }

  # Write the result table
  write.csv(result_table, "./table/LEfSe_RWUG_significant_ASVs.csv", row.names = FALSE)
```

# Supplemental Table 5: Volcano plot and supplemental tables
```{r, fig.height=6}
  plotVolcano <- function(ps0, ps0.subset, factorOfInterest = NULL, truthFacet = NULL,
                          alpha = NULL, baseMean = NULL, asv_mapping = NULL,
                          output_prefix = "DESeqTable", ncol_boxplot = 3){
    ##count table replacement function
    replace_counts = function(ps0, dds) {
      dds_counts = DESeq2::counts(dds, normalized = TRUE)
      if (!identical(phyloseq::taxa_names(ps0), rownames(dds_counts))) {
        stop("OTU ids don't match")
      }
      phyloseq::otu_table(ps0) = phyloseq::otu_table(dds_counts, taxa_are_rows = TRUE)
      return(ps0)
    }
    # Make deseq ready object
    formula <- as.formula(paste0("~",factorOfInterest))
    ds.all <- phyloseq::phyloseq_to_deseq2(ps0, formula) # Can be any variable
    gm_mean = function(x, na.rm=TRUE){
      exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
    }
    # get the table with all the columns
    geoMeans <- apply(DESeq2::counts(ds.all), 1, gm_mean)
    ds.all <- DESeq2::estimateSizeFactors(ds.all, geoMeans = geoMeans)
    dds.all <- DESeq2::DESeq(ds.all, fitType = "local")
    rlog.all <- replace_counts(ps0, dds.all)
    rlog.all <- phyloseq::psmelt(rlog.all)
    rlog.all <- dplyr::rename(rlog.all, "ASV" = "OTU")
    # convert phyloseq to deseq2 table
    ds.subset <- phyloseq::phyloseq_to_deseq2(ps0.subset,formula)
    #compute geomeans
    geoMeans <- apply(DESeq2::counts(ds.subset),1,gm_mean)
    #estimate size factors
    ds.subset <- DESeq2::estimateSizeFactors(ds.subset,geoMeans = geoMeans)
    # run deseq
    dds.subset <- DESeq2::DESeq(ds.subset)
    print(summary(DESeq2::results(dds.subset)))
    #get deseq result
    res.dds.subset <- DESeq2::results(dds.subset, cooksCutoff = FALSE)
    res.dds.subset <- as.data.frame(res.dds.subset[ which(res.dds.subset$baseMean > baseMean), ])

    # Use asv_mapping when preparing data tables
    # First, ensure we have our mapping table if not provided
    if(is.null(asv_mapping)) {
      # Create mapping on the fly if not provided
      all_asvs <- rownames(res.dds.subset)
      asv_mapping <- data.frame(
        ASV = all_asvs,
        OTU_ID = paste0("ASV_", 1:length(all_asvs))
      )
    }

    #tabulate the result table
    restable.dds.subset <- data.table(as(res.dds.subset,"data.frame"), keep.rownames = TRUE)
    setnames(restable.dds.subset, "rn", "ASV")  # Change this from OTU to ASV for consistency
    setkeyv(restable.dds.subset, "ASV")

    # Add consistent OTU IDs to the results
    restable.dds.subset <- as.data.frame(restable.dds.subset)
    restable.dds.subset <- left_join(restable.dds.subset, asv_mapping, by = "ASV")

    #extract taxa tables
    taxa.subset <- data.table(data.frame(as(phyloseq::tax_table(ps0.subset),"matrix")), keep.rownames = TRUE)
    setnames(taxa.subset, "rn", "ASV")  # Change this from OTU to ASV for consistency
    setkeyv(taxa.subset, "ASV")

    taxa.subset <- as.data.frame(taxa.subset)

    # Join the tables using ASV
    restable_taxa.subset <- left_join(restable.dds.subset, taxa.subset, by = "ASV")

    # clean the table
    cleaned.table.subset <- restable_taxa.subset %>%
      filter(padj != "NA") %>%
      mutate(significant = padj < alpha)

    outdf <- subset(cleaned.table.subset, padj < 0.05)

    # Create directory if it doesn't exist
    dir.create("./table", showWarnings = FALSE)

    # Make sure OTU_ID is included in the table outputs
    # This ensures the tables have the ASV_ prefix identifiers that match the figure
    if(!"OTU_ID" %in% colnames(outdf)) {
      warning("OTU_ID column not found in output data frame")
    } else {
      # Rearrange columns to have OTU_ID at the beginning for clarity
      outdf <- outdf %>% select(OTU_ID, everything())
    }
    if(!"OTU_ID" %in% colnames(cleaned.table.subset)) {
      warning("OTU_ID column not found in cleaned table")
    } else {
      cleaned.table.subset <- cleaned.table.subset %>% select(OTU_ID, everything())
    }

    # Use OTU_ID in the output files for consistent naming
    write.csv(outdf, paste0("./table/", output_prefix, "_DESeqTable.csv"), row.names = FALSE)
    write.csv(cleaned.table.subset, paste0("./table/", output_prefix, "_DESeqTable.cleaned.table.all.csv"), row.names = FALSE)

    l <- unique(as.factor(cleaned.table.subset$Genus))
    color <- colorRampPalette(brewer.pal(9, "Set1"))(length(l))
    names(color) <- l
    print("start to plot volcano plot:")

    # Determine the two countries being compared from the data
    countries <- unique(phyloseq::sample_data(ps0.subset)[[factorOfInterest]])
    if(length(countries) != 2) {
      warning("Expected exactly 2 countries/regions for comparison, found: ", paste(countries, collapse=", "))
    }

    # Get the left and right country based on fold change direction
    countries <- sort(countries)
    left_country <- countries[1]  # Reference level (alphabetically first)
    right_country <- countries[2]

    # volcano plot with legend on right side
    p.volcano <- ggplot(data = cleaned.table.subset,
                        aes(x = log2FoldChange,
                            y = -log10(padj),
                            color = Phylum,
                            label1 = Family,
                            label2 = Genus,
                            label3 = Phylum)) +
      geom_point(data = subset(cleaned.table.subset, cleaned.table.subset$significant == FALSE),
                 color = "grey") +
      geom_point(data = subset(cleaned.table.subset, cleaned.table.subset$significant == TRUE),
                 aes(color = Phylum,
                     size = baseMean)) +
      geom_vline(xintercept = 0, lty = 2) +
      geom_hline(yintercept = -log10(0.05)) +
      geom_text_repel(data = subset(cleaned.table.subset, cleaned.table.subset$significant == TRUE),
                     aes(label = OTU_ID), show.legend = FALSE) +
      annotate("text", x = -max(abs(cleaned.table.subset$log2FoldChange))/2,
               y = max(-log10(cleaned.table.subset$padj), na.rm = TRUE) * 1.1,
               label = left_country, size = 5, fontface = "bold") +
      annotate("text", x = max(abs(cleaned.table.subset$log2FoldChange))/2,
               y = max(-log10(cleaned.table.subset$padj), na.rm = TRUE) * 1.1,
               label = right_country, size = 5, fontface = "bold") +
      labs(title = paste0("Differential Abundance"),
           caption = paste0("alpha = ", alpha, ", baseMean = ", baseMean)) +
      theme_bw() +
      theme(axis.title = element_text(size = 12),
            axis.text = element_text(size = 12),
            axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
            legend.text = element_text(size = 8),
            legend.position = "right",
            plot.caption = element_text(hjust = 0.5, size = 10),
            plot.title = element_text(hjust = 0.5, size = 14))

    print("start to prepare data for ground truth plot:")
    # ground truth
    tax <- as.data.frame(phyloseq::tax_table(ps0))
    tax <- as.tibble(rownames_to_column(tax, var = "ASV"))

    # Get significant results and sort by p-value
    df.subset <- as.data.frame(res.dds.subset[which(res.dds.subset$padj < alpha & res.dds.subset$baseMean > baseMean), ])
    df.subset <- rownames_to_column(df.subset, var = "ASV")
    df.subset <- left_join(df.subset, tax, by = "ASV")
    df.subset <- left_join(df.subset, asv_mapping, by = "ASV")
    df.subset <- df.subset %>% arrange(pvalue)

    # Create plot ID with embedded rank for ordering
    df.subset$plot_id <- paste0(sprintf("%02d", 1:nrow(df.subset)), "_", df.subset$OTU_ID)
    df.subset$label <- sprintf("%s [p=%s]", df.subset$OTU_ID,
                              format.pval(df.subset$pvalue, digits = 3, eps = 0.001))

    # Get abundance data
    theme_set(theme_bw(base_size = 8, base_family = "Arial"))
    df.rlog.subset <- inner_join(df.subset, rlog.all, by = c("ASV"))

    # Add a small offset to zero values to avoid log transform issues
    df.rlog.subset$Abundance_adj <- df.rlog.subset$Abundance
    df.rlog.subset$Abundance_adj[df.rlog.subset$Abundance_adj == 0] <- min(df.rlog.subset$Abundance_adj[df.rlog.subset$Abundance_adj > 0]) / 10

    # Get ordered OTU IDs
    ordered_ids <- unique(df.subset$plot_id)

    # Create a mapping from plot_id to display label
    id_to_label <- setNames(df.subset$label, df.subset$plot_id)

    # Use the plot_id for faceting but with explicit factor levels to control order
    df.rlog.subset$plot_id <- factor(df.rlog.subset$plot_id, levels = ordered_ids)

    # Create a single plot with facets, but manually calculating the layout
    n_plots <- length(unique(df.rlog.subset$plot_id))
    n_rows <- ceiling(n_plots / ncol_boxplot)

    print("Creating boxplot with controlled layout:")
    print(paste("Number of plots:", n_plots))
    print(paste("Layout:", n_rows, "rows by", ncol_boxplot, "columns"))

    # Use facet_wrap but with explicit layout control
    p.box <- ggplot(df.rlog.subset, aes(x = .data[[factorOfInterest]], y = Abundance_adj, color = Phylum.y)) +
      geom_boxplot(outlier.shape = NA) +
      geom_jitter(alpha = 0.7, width = 0.2, size = 1) +
      scale_y_log10() +
      facet_wrap(~ plot_id, ncol = ncol_boxplot,
                labeller = labeller(plot_id = id_to_label)) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 0, hjust = 0.5),
            strip.text = element_text(size = 8),
            legend.position = "bottom",  # Add legend on bottom
            legend.title = element_text(size = 10),
            legend.text = element_text(size = 8),
            legend.key.size = unit(0.8, "lines")) +
      labs(title = "Abundance by Region", x = "", y = "Abundance (log scale)", color = "Phylum") +  # Set legend title
      stat_compare_means(aes(group = .data[[factorOfInterest]]),
                        label = "p.signif",
                        method = "wilcox.test",
                        hide.ns = TRUE)

    return(list(volcano = p.volcano, boxplot = p.box))
  }

  # Call the function for each analysis
  plots_RWUG <- plotVolcano(ps1_V9_RWUG, ps1_V9_RWUG, "sub_region", "Genus.y", 0.05, 0, asv_mapping, "RWUG_V9", ncol_boxplot = 8)
  plots_RWUS <- plotVolcano(ps1_V9_RWUS, ps1_V9_RWUS, "sub_region", "Genus.y", 0.05, 0, asv_mapping, "RWUS_V9", ncol_boxplot = 8)
  plots_USUG <- plotVolcano(ps1_V9_USUG, ps1_V9_USUG, "sub_region", "Genus.y", 0.05, 0, asv_mapping, "USUG_V9", ncol_boxplot = 8)

   # Display volcano plots
  plots_RWUG$volcano
  plots_RWUS$volcano
  plots_USUG$volcano

  # Display boxplots separately
  plots_RWUG$boxplot
  plots_RWUS$boxplot
  plots_USUG$boxplot

  # Create the volcano plot figure for the paper
  # Add labels to each plot
plot_A <- plots_RWUS$volcano + labs(tag = "A.")
plot_B <- plots_USUG$volcano + labs(tag = "B.")
plot_C <- plots_RWUG$volcano + labs(tag = "C.")

# Create empty placeholder plots
empty <- ggplot() + theme_void()

# Combine plots
# Create a 2x4 grid layout with plot C taking up just the middle two cells
combined_volcano_plot <- ((plot_A + plot_B) / 
                         (plot_C + empty)) +
  plot_layout(
    widths = c(1, 1),
    heights = c(1, 1)
  )

# Save the combined plot as TIFF
ggsave("./figures/combined_volcano_plots.tiff", 
       combined_volcano_plot, 
       width = 15,
       height = 12,   # adjusted for the layout
       dpi = 300) 

# NOTE: files for paper = _DESeqTable.cleaned.table.all.csv

  # Read in BLASTn results and tables to add to
blastn <- read_csv("./data/ASV_to_OSU_to_BLAST_genus.csv")
V9_RWUG <- read_csv("./table/RWUG_V9_DESeqTable.cleaned.table.all.csv")

 # Combine the files by joining on both OTU_ID and ASV columns
  combined_data <- V9_RWUG %>%
    left_join(blastn, by = c("OTU_ID", "ASV"))
  
  # Rearrange to put BLAST_Genus as the very last column
  combined_data <- combined_data %>%
    select(
      OTU_ID, ASV, baseMean, log2FoldChange, lfcSE, stat,
      pvalue, padj, Kingdom, Phylum, Class, Order,
      Family, Genus, Species, significant, BLAST_Genus
    )
  # Save the combined data
  write_csv(combined_data, "./table/RWUG_V9_DESeqTable.cleaned.table.all.fin.csv")
  
  V9_RWUS <- read_csv("./table/RWUS_V9_DESeqTable.cleaned.table.all.csv")
   # Combine the files by joining on both OTU_ID and ASV columns
  combined_data <- V9_RWUS %>%
    left_join(blastn, by = c("OTU_ID", "ASV"))
  
  # Rearrange to put BLAST_Genus as the very last column
  combined_data <- combined_data %>%
    select(
      OTU_ID, ASV, baseMean, log2FoldChange, lfcSE, stat,
      pvalue, padj, Kingdom, Phylum, Class, Order,
      Family, Genus, Species, significant, BLAST_Genus
    )
  # Save the combined data
  write_csv(combined_data, "./table/RWUS_V9_DESeqTable.cleaned.table.all.fin.csv")
  
V9_USUG <- read_csv("./table/USUG_V9_DESeqTable.cleaned.table.all.csv")
 # Combine the files by joining on both OTU_ID and ASV columns
  combined_data <- V9_USUG %>%
    left_join(blastn, by = c("OTU_ID", "ASV"))
  
  # Rearrange to put BLAST_Genus as the very last column
  combined_data <- combined_data %>%
    select(
      OTU_ID, ASV, baseMean, log2FoldChange, lfcSE, stat,
      pvalue, padj, Kingdom, Phylum, Class, Order,
      Family, Genus, Species, significant, BLAST_Genus
    )
  # Save the combined data
  write_csv(combined_data, "./table/USUG_V9_DESeqTable.cleaned.table.all.fin.csv")

```

# Fig 6A
```{r Fig 6A}
# Read in data frame
df.fam.temp <- read_tsv(file = "./data/virome_data/vertebrate_virus_families.tsv", col_names = TRUE)
df.fam <- df.fam.temp %>%
    mutate_if(is.character,as.factor) %>%
    mutate(across(contains("CALL"),
                  factor)) %>%
    mutate(region = recode(region, "USA" = "US")) %>%
    droplevels()

# Family presence / absence (PA)
# Create PA table
df.fam.pa <- df.fam %>%
  select(sample_id, region, visit_description, Abundance, Family) %>%
  mutate(PA = ifelse(Abundance > 0, 1, 0)) %>%
  select(-Abundance) %>%
  distinct() %>%
  group_by(region, visit_description, Family, PA) %>%
  tally() %>%
  pivot_wider(names_from = PA, values_from = n) %>%
  mutate(Percent = 100*(`1`/(`0` + `1`))) %>%
  mutate_at(~replace(., is.na(.), 0), .vars = c(4:6)) %>%
  ungroup() %>%
  rename("n" = `0`,
         "Present" = `1`) %>%
  mutate(Absent = n - Present) %>%
  relocate(Percent, .after = Absent)
df.fam.pa

#nLate timepoint only
df.fam.pa.v9 <- df.fam.pa %>%
    filter(visit_description == "V9 STOOL COLLECTION") %>%
    droplevels()

# Order the families
family_order <- c("Picornaviridae", "Circoviridae", "Parvoviridae", "Astroviridae", "Caliciviridae", "Adenoviridae")

# Heatmap of each virus per region FIX colors IF find color version from Yuhao
p.hm <- ggplot(df.fam.pa.v9, aes(x = region, y = Family, fill = Percent)) +
  geom_tile(color = "white", linewidth = 0.15) +
  scale_y_discrete(limits = family_order) +  # Set the order of families
  scale_fill_gradient2(
    low = "#FFFFFF",       # white for low values
    mid = "#66CDAA",       # Medium aquamarine for middle values  
    high = "#00008B",      # Blue4 for high values
    midpoint = 15,         # Set midpoint at 15% (adjust as needed)
    name = "% Positive"
  ) +
  labs(x = "", y = "") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    axis.text.y = element_text(size = 14, face = "italic"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),  # Add white background
    plot.background = element_rect(fill = "white", color = NA)    # Add white background to entire plot
  )

p.hm
```

# Fig 6B
```{r Fig 6B}
df.fam.v9 <- df.fam %>%
    filter(visit_description == "V9 STOOL COLLECTION") %>%
    droplevels()

# Order Families for figure
df.fam.v9$Family <- factor(df.fam.v9$Family, levels = c("Adenoviridae", 
                                                "Caliciviridae",
                                                "Astroviridae",
                                                "Parvoviridae",
                                                "Circoviridae",
                                                "Picornaviridae")) 

# Test if the medians are different between regions for each viral family
region.dunns <- df.fam.v9 %>%
    group_by(Family) %>%
    dunn_test(Abundance ~ region, p.adjust.method = "holm") %>%
    add_significance()
region.dunns

   # Family         .y.       group1 group2    n1    n2 statistic          p     p.adj p.adj.signif
#  1 Adenoviridae   Abundance Rwanda Uganda   156    48     1.68  0.0926     0.278     ns          
#  2 Adenoviridae   Abundance Rwanda US       156   102     0.816 0.414      0.642     ns          
#  3 Adenoviridae   Abundance Uganda US        48   102    -0.992 0.321      0.642     ns          
#  4 Caliciviridae  Abundance Rwanda Uganda   104    32    -0.217 0.828      0.828     ns          
#  5 Caliciviridae  Abundance Rwanda US       104    68    -1.59  0.113      0.338     ns          
#  6 Caliciviridae  Abundance Uganda US        32    68    -0.950 0.342      0.685     ns          
#  7 Astroviridae   Abundance Rwanda Uganda   260    80     3.69  0.000223   0.000446  ***         
#  8 Astroviridae   Abundance Rwanda US       260   170    -0.666 0.505      0.505     ns          
#  9 Astroviridae   Abundance Uganda US        80   170    -3.97  0.0000732  0.000219  ***         
# 10 Parvoviridae   Abundance Rwanda Uganda   520   160     4.28  0.0000183  0.0000366 ****        
# 11 Parvoviridae   Abundance Rwanda US       520   340    -0.623 0.533      0.533     ns          
# 12 Parvoviridae   Abundance Uganda US       160   340    -4.49  0.00000700 0.0000210 ****        
# 13 Circoviridae   Abundance Rwanda Uganda   572   176     0.643 0.520      0.520     ns          
# 14 Circoviridae   Abundance Rwanda US       572   374    -4.19  0.0000274  0.0000822 ****        
# 15 Circoviridae   Abundance Uganda US       176   374    -3.66  0.000255   0.000510  ***         
# 16 Picornaviridae Abundance Rwanda Uganda   520   160    -0.388 0.698      0.698     ns          
# 17 Picornaviridae Abundance Rwanda US       520   340    -4.05  0.0000516  0.000155  ***         
# 18 Picornaviridae Abundance Uganda US       160   340    -2.58  0.00991    0.0198    *        


# Little code to look at one Family at a time (just change the Family name)
# This can help when adding p-values (p.adj) to plots in keynote/illustrator
region.dunns %>%
    filter(Family == "Adenoviridae") # Change Family name to check each virus

# Define colors for regions
region_colors <- c("Rwanda" = "#008800", "Uganda" = "#00008B", "US" = "#E41A1C")

# Create the plot with colors
p.fam.ab.v9.2 <- ggplot(filter(df.fam.v9, visit_description == "V9 STOOL COLLECTION"), 
                       aes(x = region, y = log10(Abundance+1), color = region)) +
  geom_jitter(width = 0.1, alpha = 0.5, size = 1) +
  facet_wrap(~Family, ncol = 6) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        strip.text = element_text(size = 11),
        plot.title = element_text(size = 16)) +
  labs(y = "Abundance (log10)", x = "") +
  scale_color_manual(values = region_colors) +
  theme(legend.position = "none")

# For Astroviridae - offsetting brackets vertically
p.fam.ab.v9.2 <- p.fam.ab.v9.2 +
  geom_signif(data = filter(df.fam.v9, visit_description == "V9 STOOL COLLECTION", 
                           Family == "Astroviridae"),
              comparisons = list(c("Rwanda", "Uganda")),
              annotations = c("***"),
              y_position = c(3.9),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000") +
  geom_signif(data = filter(df.fam.v9, visit_description == "V9 STOOL COLLECTION", 
                           Family == "Astroviridae"),
              comparisons = list(c("Uganda", "US")),
              annotations = c("***"),
              y_position = c(3.7),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000")

# For Parvoviridae - offsetting brackets vertically
p.fam.ab.v9.2 <- p.fam.ab.v9.2 +
  geom_signif(data = filter(df.fam.v9, visit_description == "V9 STOOL COLLECTION", 
                           Family == "Parvoviridae"),
              comparisons = list(c("Rwanda", "Uganda")),
              annotations = c("****"),
              y_position = c(3.9),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000") +
  geom_signif(data = filter(df.fam.v9, visit_description == "V9 STOOL COLLECTION", 
                           Family == "Parvoviridae"),
              comparisons = list(c("Uganda", "US")),
              annotations = c("****"),
              y_position = c(3.7),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000")

# For Circoviridae - offsetting brackets vertically
p.fam.ab.v9.2 <- p.fam.ab.v9.2 +
  geom_signif(data = filter(df.fam.v9, visit_description == "V9 STOOL COLLECTION", 
                           Family == "Circoviridae"),
              comparisons = list(c("Rwanda", "US")),
              annotations = c("****"),
              y_position = c(3.9),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000") +
  geom_signif(data = filter(df.fam.v9, visit_description == "V9 STOOL COLLECTION", 
                           Family == "Circoviridae"),
              comparisons = list(c("Uganda", "US")),
              annotations = c("***"),
              y_position = c(3.7),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000")

# For Picornaviridae - offsetting brackets vertically
p.fam.ab.v9.2 <- p.fam.ab.v9.2 +
  geom_signif(data = filter(df.fam.v9, visit_description == "V9 STOOL COLLECTION", 
                           Family == "Picornaviridae"),
              comparisons = list(c("Rwanda", "US")),
              annotations = c("***"),
              y_position = c(3.9),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000") +
  geom_signif(data = filter(df.fam.v9, visit_description == "V9 STOOL COLLECTION", 
                           Family == "Picornaviridae"),
              comparisons = list(c("Uganda", "US")),
              annotations = c("*"),
              y_position = c(3.7),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000")

# Display the plot
p.fam.ab.v9.2

```

# Final Figure 6
```{r Figure 6}
F6_final_figure <- plot_grid(p.hm, p.fam.ab.v9.2,
          labels = c("A.", "B."),
          ncol = 2,
          rel_widths = c(1, 2),
          hjust = 0,
          label_x = 0.01)       # Increase this value to move labels right

# Save the final figure
ggsave("figures/Figure_6.tiff", 
       F6_final_figure, 
       width = 15, height = 10,  # Adjust height as needed
       dpi = 300, 
       compression = "lzw")

```

# Fig Supplemental 6A, Supplemental 6B
```{r Fig S6A, S6B}
# Early US v UG heatmap
df.fam.v2_USUG <- df.fam.pa %>%
  filter(visit_description == "V2 STOOL COLLECTION") %>%
  filter(region != "Rwanda") %>%
  filter(Family == "Picornaviridae" | Family == "Circoviridae" | Family == "Parvoviridae" | Family == "Adenoviridae") %>%
  droplevels()

# Order Families for figure
df.fam.v2_USUG$Family <- factor(df.fam.v2_USUG$Family, levels = c("Picornaviridae", 
                                                "Circoviridae",
                                                "Parvoviridae",
                                                "Adenoviridae")) 

p.hm_USUG <- ggplot(df.fam.v2_USUG, aes(x = region, y = Family, fill = Percent)) +
    geom_tile() +
    #scale_fill_continuous(na.value = 'white') +
    scale_fill_gradientn(colours = c("white", "#66CDAA", "#00008B"), values = c(0,0.1,1)) +
    scale_y_discrete(expand = c(-Inf,Inf)) +
    scale_x_discrete(expand = c(-Inf,Inf)) +
    labs(x = "", y = "", fill = "% Positive") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x = "", y = "") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    axis.text.y = element_text(size = 14, face = "italic"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),  # Add white background
    plot.background = element_rect(fill = "white", color = NA)    # Add white background to entire plot
  )

p.hm_USUG

# Abundance plot S6B
# Uganda vs. US
df.fam.v2_USUG <- df.fam %>%
    filter(visit_description == "V2 STOOL COLLECTION") %>%
    filter(region != "Rwanda") %>%
    filter(Family == "Picornaviridae" | Family == "Circoviridae" | Family == "Parvoviridae" | Family == "Adenoviridae") %>%
    droplevels()

# Test if the medians are different between regions for each viral family
dunn_results_USUG <- df.fam.v2_USUG %>%
    group_by(Family) %>%
    dunn_test(Abundance ~ region, p.adjust.method = "holm") %>%
    add_significance()
dunn_results_USUG

# A tibble: 4  10
#   Family         .y.       group1 group2    n1    n2 statistic       p   p.adj p.adj.signif
#   <fct>          <chr>     <chr>  <chr>  <int> <int>     <dbl>   <dbl>   <dbl> <chr>       
# 1 Adenoviridae   Abundance Uganda US        39    99    -1.50  0.134   0.134   ns          
# 2 Circoviridae   Abundance Uganda US       143   363    -3.20  0.00139 0.00139 **          
# 3 Parvoviridae   Abundance Uganda US       130   330    -0.974 0.330   0.330   ns          
# 4 Picornaviridae Abundance Uganda US       130   330    -1.59  0.111   0.111   ns 

# Order Families for figure
df.fam.v2_USUG$Family <- factor(df.fam.v2_USUG$Family, levels = c("Adenoviridae", 
                                                "Parvoviridae",
                                                "Circoviridae",
                                                "Picornaviridae")) 

# Define colors for regions
region_colors <- c("Uganda" = "#00008B", "US" = "#E41A1C")

# Create the plot with colors
p.fam.v2_USUG <- ggplot(df.fam.v2_USUG, 
                       aes(x = region, y = log10(Abundance+1), color = region)) +
  geom_jitter(width = 0.1, alpha = 0.5, size = 1) +
  facet_wrap(~Family, ncol = 6) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        strip.text = element_text(size = 11),
        plot.title = element_text(size = 16)) +
  labs(y = "Abundance (log10)", x = "") +
  scale_color_manual(values = region_colors) +
  theme(legend.position = "none") +
  scale_y_continuous(limits = c(NA, 4))

# For Adenoviridae 
p.fam.v2_USUG <- p.fam.v2_USUG +
  geom_signif(data = filter(df.fam.v2_USUG, Family == "Adenoviridae"), 
              comparisons = list(c("US", "Uganda")),
              annotations = c("ns"),
              y_position = c(3.5),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000")

# For Parvoviridae 
p.fam.v2_USUG <- p.fam.v2_USUG +
  geom_signif(data = filter(df.fam.v2_USUG, Family == "Parvoviridae"), 
              comparisons = list(c("US", "Uganda")),
              annotations = c("ns"),
              y_position = c(3.5),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000")

# For Circoviridae 
p.fam.v2_USUG <- p.fam.v2_USUG +
  geom_signif(data = filter(df.fam.v2_USUG, Family == "Circoviridae"), 
              comparisons = list(c("US", "Uganda")),
              annotations = c("**"),
              y_position = c(3.5),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000")

# For Picornaviridae 
p.fam.v2_USUG <- p.fam.v2_USUG +
  geom_signif(data = filter(df.fam.v2_USUG, Family == "Picornaviridae"), 
              comparisons = list(c("US", "Uganda")),
              annotations = c("ns"),
              y_position = c(3.5),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000")

p.fam.v2_USUG

```

# Fig Supplemental 6C, Supplemental 6D
```{r Fig S6C, S6D}
# Fig S6C
# Aggregate data by Family with region filtering
df.fam.UG <- df.fam %>%
  filter(region == "Uganda") %>%
  # Group by relevant fields
  group_by(patient_id, sample_id, visit_description, Family) %>%
  # Sum abundances within each group
  summarize(Abundance = sum(Abundance, na.rm = TRUE), .groups = "drop")

# Get patients with both visit types
patients_with_both_visits_UG <- df.fam.UG %>%
  select(patient_id, visit_description) %>%
  distinct() %>%
  group_by(patient_id) %>%
  filter(
    sum(visit_description == "V2 STOOL COLLECTION") > 0 &
    sum(visit_description == "V9 STOOL COLLECTION") > 0
  ) %>%
  pull(patient_id) %>%
  unique()

# Filter for patients with both visits and prepare for plotting
plot_data_UG <- df.fam.UG %>%
  # Keep only patients with both visit types
  filter(patient_id %in% patients_with_both_visits_UG) %>%
  # Keep only the families we want to plot
  filter(Family %in% family_order) %>%
  # Convert Family to factor with desired order
  mutate(Family = factor(Family, levels = family_order))

# Define colors for visits
matchcolor <- c("V2 STOOL COLLECTION" = "#00A087B2", "V9 STOOL COLLECTION" = "#F39B7FB2")

# Create the plot
p.paired.viral.abundance_UG <- ggplot(plot_data_UG, 
                                     aes(x = visit_description, 
                                         y = Abundance, 
                                         color = visit_description)) +
  # Add lines connecting same patient between visits within each family
  geom_line(aes(group = patient_id), color = "grey1", linewidth = 0.4, alpha = 0.5) +
  geom_point(size = 2.5) +
  facet_wrap(~ Family, scales = "free_y", nrow = 1) +
  scale_color_manual(values = matchcolor) +
  scale_x_discrete(labels = c("V2 STOOL COLLECTION" = "Early", "V9 STOOL COLLECTION" = "Late")) +
  labs(
    y = "Viral Abundance",
    x = " "
  ) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    strip.text = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12)
  )

# Perform Wilcoxon test for each family
wilcox_results_UG <- plot_data_UG %>%
  group_by(Family) %>%
  filter(n_distinct(visit_description) == 2) %>%
  summarize(
    p_value = wilcox.test(
      Abundance[visit_description == "V2 STOOL COLLECTION"],
      Abundance[visit_description == "V9 STOOL COLLECTION"],
      paired = TRUE
    )$p.value
  ) %>%
  mutate(
    p_adj = p.adjust(p_value, method = "BH"),
    significance = ifelse(p_adj < 0.05, "*", "n.s.")
  )

# Create a data frame for annotations and add them
annotation_data_UG <- wilcox_results_UG %>%
  mutate(
    x = 1.5,  # Position between Early and Late
    y = sapply(Family, function(fam) {
      max(plot_data_UG$Abundance[plot_data_UG$Family == fam], na.rm = TRUE) * 1.1
    })
  )

# Add annotations using the data frame
p.paired.viral.abundance_UG <- p.paired.viral.abundance_UG +
  # Add the significance text
  geom_text(data = annotation_data_UG, 
            aes(x = x, y = y, label = significance),
            inherit.aes = FALSE, size = 5) +
  # Add the horizontal line (top of the bracket)
  geom_segment(data = annotation_data_UG,
               aes(x = 1, y = y * 0.95, xend = 2, yend = y * 0.95),
               inherit.aes = FALSE) +
  # Add left vertical line (left side of the bracket)
  geom_segment(data = annotation_data_UG,
               aes(x = 1, y = y * 0.93, xend = 1, yend = y * 0.95),
               inherit.aes = FALSE) +
  # Add right vertical line (right side of the bracket)
  geom_segment(data = annotation_data_UG,
               aes(x = 2, y = y * 0.93, xend = 2, yend = y * 0.95),
               inherit.aes = FALSE)

p.paired.viral.abundance_UG

# Fig S6D
# Aggregate data by Family with region filtering
df.fam.US <- df.fam %>%
  filter(region == "US") %>%
  # Group by relevant fields
  group_by(patient_id, sample_id, visit_description, Family) %>%
  # Sum abundances within each group
  summarize(Abundance = sum(Abundance, na.rm = TRUE), .groups = "drop")

# Get patients with both visit types
patients_with_both_visits_US <- df.fam.US %>%
  select(patient_id, visit_description) %>%
  distinct() %>%
  group_by(patient_id) %>%
  filter(
    sum(visit_description == "V2 STOOL COLLECTION") > 0 &
    sum(visit_description == "V9 STOOL COLLECTION") > 0
  ) %>%
  pull(patient_id) %>%
  unique()

# Filter for patients with both visits and prepare for plotting
plot_data_US <- df.fam.US %>%
  # Keep only patients with both visit types
  filter(patient_id %in% patients_with_both_visits_US) %>%
  # Keep only the families we want to plot
  filter(Family %in% family_order) %>%
  # Convert Family to factor with desired order
  mutate(Family = factor(Family, levels = family_order))

# Define colors for visits
matchcolor <- c("V2 STOOL COLLECTION" = "#00A087B2", "V9 STOOL COLLECTION" = "#F39B7FB2")

# Create the plot
p.paired.viral.abundance_US <- ggplot(plot_data_US, 
                                     aes(x = visit_description, 
                                         y = Abundance, 
                                         color = visit_description)) +
  # Add lines connecting same patient between visits within each family
  geom_line(aes(group = patient_id), color = "grey1", linewidth = 0.4, alpha = 0.5) +
  geom_point(size = 2.5) +
  facet_wrap(~ Family, scales = "free_y", nrow = 1) +
  scale_color_manual(values = matchcolor) +
  scale_x_discrete(labels = c("V2 STOOL COLLECTION" = "Early", "V9 STOOL COLLECTION" = "Late")) +
  labs(
    y = "Viral Abundance",
    x = " "
  ) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    strip.text = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12)
  )

# Perform Wilcoxon test for each family
wilcox_results_US <- plot_data_US %>%
  group_by(Family) %>%
  filter(n_distinct(visit_description) == 2) %>%
  summarize(
    p_value = wilcox.test(
      Abundance[visit_description == "V2 STOOL COLLECTION"],
      Abundance[visit_description == "V9 STOOL COLLECTION"],
      paired = TRUE
    )$p.value
  ) %>%
  mutate(
    p_adj = p.adjust(p_value, method = "BH"),
    significance = ifelse(p_adj < 0.05, "*", "n.s.")
  )

# Fix the Wilcoxon test results by replacing NaN with NA and setting significance for NAs
wilcox_results_US <- wilcox_results_US %>%
  mutate(
    p_value = if_else(is.nan(p_value), NA_real_, p_value),
    p_adj = if_else(is.nan(p_adj), NA_real_, p_adj),
    # Replace NA significance with "n.s." or another appropriate label
    significance = case_when(
      is.na(significance) ~ "n.s.",
      TRUE ~ significance
    )
  )

# Create a data frame for annotations and add them
annotation_data_US <- wilcox_results_US %>%
  mutate(
    x = 1.5,  # Position between Early and Late
    y = sapply(Family, function(fam) {
      # Calculate max value, with a fallback if no data exists
      max_val <- max(plot_data_US$Abundance[plot_data_US$Family == fam], na.rm = TRUE)
      # If max_val is -Inf (no valid data) or 0, use a small positive value instead
      if (is.infinite(max_val) || max_val == 0) {
        return(1) # Or another appropriate default value
      } else {
        return(max_val * 1.1)
      }
    })
  )

# Add annotations using the data frame
p.paired.viral.abundance_US <- p.paired.viral.abundance_US +
  # Add the significance text
  geom_text(data = annotation_data_US, 
            aes(x = x, y = y, label = significance),
            inherit.aes = FALSE, size = 5) +
  # Add the horizontal line (top of the bracket)
  geom_segment(data = annotation_data_US,
               aes(x = 1, y = y * 0.95, xend = 2, yend = y * 0.95),
               inherit.aes = FALSE) +
  # Add left vertical line (left side of the bracket)
  geom_segment(data = annotation_data_US,
               aes(x = 1, y = y * 0.93, xend = 1, yend = y * 0.95),
               inherit.aes = FALSE) +
  # Add right vertical line (right side of the bracket)
  geom_segment(data = annotation_data_US,
               aes(x = 2, y = y * 0.93, xend = 2, yend = y * 0.95),
               inherit.aes = FALSE)

p.paired.viral.abundance_US

```

# Fig Supplemental 6E, Supplemental 6F
```{r Fig S6E, S6F}
# Read in response call adjusted data frame
# This is used in response call (R vs. NR) analysis
df.calls.temp <- read_tsv(file = "./data/virome_data/vertebrate_virus_calls.tsv", col_names = TRUE)
df.calls <- df.calls.temp %>%
    mutate_if(is.character,as.factor) %>%
    mutate(across(contains("CALL"),
                  factor))

# Filter taxa as above
df.calls.picorna <- df.calls %>%
  filter(Family == "Picornaviridae") %>%
  filter(Genus != "unclassified Picornaviridae genus") %>%
  filter(region != "USA") %>% # Remove US as it has no picornaviruses
  filter(visit_description == "V9 STOOL COLLECTION") %>%
  droplevels()

#### ADCP ####
df.calls.picorna.ADCP <- df.calls.picorna %>%
    filter(Type == "ADCP") %>%
    droplevels()

# Cosavirus
# Filter just the cosaviruses
df.calls.cosa.ADCP <- df.calls.picorna.ADCP %>%
    filter(Genus == "Cosavirus") %>%
    droplevels()

# Test if median abundance of are different per response call
df.calls.cosa.ADCP %>%
  group_by(region, Antigen) %>%
  wilcox_test(Abundance ~ Call) %>%
  adjust_pvalue(method = "holm") %>%
  add_significance("p.adj")

# # A tibble: 10  11
#    region Antigen         .y.       group1 group2    n1    n2 statistic       p  p.adj p.adj.signif
#    <fct>  <fct>           <chr>     <chr>  <chr>  <int> <int>     <dbl>   <dbl>  <dbl> <chr>       
#  1 Rwanda Clade A         Abundance NR     R         62     3     114   0.373   1      ns          
#  2 Rwanda Clade B         Abundance NR     R         52    14     324   0.386   1      ns          
#  3 Rwanda Clade C         Abundance NR     R         43    23     422.  0.172   1      ns          
#  4 Rwanda Clade C (Con C) Abundance NR     R         29    37     362.  0.00161 0.0161 *           
#  5 Rwanda Mos1            Abundance NR     R         19    47     370.  0.13    1      ns          
#  6 Uganda Clade A         Abundance NR     R         18     1      10.5 0.774   1      ns          
#  7 Uganda Clade B         Abundance NR     R         16     3      28.5 0.481   1      ns          
#  8 Uganda Clade C         Abundance NR     R         18     1      10.5 0.774   1      ns          
#  9 Uganda Clade C (Con C) Abundance NR     R         10     9      30   0.0624  0.562  ns          
# 10 Uganda Mos1            Abundance NR     R          4    15      24   0.387   1      ns 

# Plot abundances per response
df.calls.cosa.ADCP <- df.calls.cosa.ADCP %>%
    filter(region == "Rwanda") %>%
    filter(Antigen == "Clade C (Con C)")

p.adcp.cosa <- ggplot(df.calls.cosa.ADCP, aes(x = Call, y = log10(Abundance + 1), color = Call)) +
  geom_jitter(width = 0.1, alpha = 0.5, size = 2) +
  scale_color_manual(values = c("NR" = "#008800", "R" = "#E41A1C"), 
                   name = "ADCP Clade C (Con C)\nresponse",
                   labels = c("NR" = "Non-responder", "R" = "Responder")) +
  labs(y = "Abundance (log10)", x = "Response Call") +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 12),  # Increase legend title size
        legend.text = element_text(size = 11),   # Increase legend text size
        strip.text = element_text(size = 12),
        legend.position = "bottom") +
  facet_wrap(~ Genus, scales = "free_y") +
  scale_y_continuous(limits = c(NA, 4))

# For Cosavirus 
p.adcp.cosa <- p.adcp.cosa +
  geom_signif(data = filter(df.calls.cosa.ADCP, Genus == "Cosavirus"), 
              comparisons = list(c("NR", "R")),
              annotations = c("**"),
              y_position = c(3.5),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000")

p.adcp.cosa

# Enterovirus
# Filter just the enteroviruses
df.calls.entero.ADCP <- df.calls.picorna.ADCP %>%
    filter(Genus == "Enterovirus") %>%
    droplevels()

# Test if median abundance of are different per response call
df.calls.entero.ADCP %>%
  group_by(region, Antigen) %>%
  wilcox_test(Abundance ~ Call) %>%
  adjust_pvalue(method = "holm") %>%
  add_significance("p.adj")

# # A tibble: 10  11
#    region Antigen         .y.       group1 group2    n1    n2 statistic        p   p.adj p.adj.signif
#    <fct>  <fct>           <chr>     <chr>  <chr>  <int> <int>     <dbl>    <dbl>   <dbl> <chr>       
#  1 Rwanda Clade A         Abundance NR     R         53     6      62   0.000109 0.00109 **          
#  2 Rwanda Clade B         Abundance NR     R         47    13     238   0.0529   0.423   ns          
#  3 Rwanda Clade C         Abundance NR     R         39    21     320   0.0264   0.238   ns          
#  4 Rwanda Clade C (Con C) Abundance NR     R         31    29     398   0.225    1       ns          
#  5 Rwanda Mos1            Abundance NR     R         20    40     400   1        1       ns          
#  6 Uganda Clade A         Abundance NR     R         19     1      11.5 0.71     1       ns          
#  7 Uganda Clade B         Abundance NR     R         17     3      31.5 0.405    1       ns          
#  8 Uganda Clade C         Abundance NR     R         19     1      11.5 0.71     1       ns          
#  9 Uganda Clade C (Con C) Abundance NR     R         12     8      46   0.869    1       ns          
# 10 Uganda Mos1            Abundance NR     R          4    16      24   0.311    1       ns  

df.calls.entero.ADCP <- df.calls.entero.ADCP %>%
    filter(region == "Rwanda") %>%
    filter(Antigen == "Clade A")

p.adcp.entero <- ggplot(df.calls.entero.ADCP, aes(x = Call, y = log10(Abundance + 1), color = Call)) +
  geom_jitter(width = 0.1, alpha = 0.5, size = 2) +
  scale_color_manual(values = c("NR" = "#008800", "R" = "#E41A1C"), 
                   name = "ADCP Clade A\nresponse",
                   labels = c("NR" = "Non-responder", "R" = "Responder")) +
  labs(y = "Abundance (log10)", x = "Response Call") +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 12),  # Increase legend title size
        legend.text = element_text(size = 11),   # Increase legend text size
        strip.text = element_text(size = 12),
        legend.position = "bottom") +
  facet_wrap(~ Genus, scales = "free_y") +
  scale_y_continuous(limits = c(NA, 4))  # Set upper limit to 4, keep lower limit as is

# For Enterovirus 
p.adcp.entero <- p.adcp.entero +
  geom_signif(data = filter(df.calls.entero.ADCP, Genus == "Enterovirus"), 
              comparisons = list(c("NR", "R")),
              annotations = c("**"),
              y_position = c(3.5),
              tip_length = 0.01,
              textsize = 5,
              color = "#000000")
p.adcp.entero
```

# Final Supplemental Figure 6
```{r figure S6}
# First row with A and B
first_row <- plot_grid(
  p.hm_USUG, p.fam.v2_USUG,
  ncol = 2,
  rel_widths = c(0.8, 1),
  labels = c("A.","B."),
  label_size = 16,
  label_fontface = "bold"
)

# 2nd row with C
# Create second row with plots without legends
second_row <- plot_grid(
  p.paired.viral.abundance_UG, 
  ncol = 1,
  rel_widths = c(1),
  labels = "C.",
  label_size = 16,
  label_fontface = "bold",
  align = "h",
  axis = "tb"
)

# Create third row 
third_row <- plot_grid(
  p.paired.viral.abundance_US,  
  ncol = 1,
  rel_widths = c(1),
  labels = "D.",
  label_size = 16,
  label_fontface = "bold",
  align = "h",
  axis = "tb"
)

p.adcp.cosa_clean <- p.adcp.cosa + 
  theme(
    legend.position = "bottom",
    legend.background = element_rect(fill = "white", color = NA),
    legend.box.background = element_rect(fill = "white", color = NA),
    legend.box.margin = margin(0, 0, 0, 0)
  )

p.adcp.entero_clean <- p.adcp.entero + 
  theme(
    legend.position = "bottom",
    legend.background = element_rect(fill = "white", color = NA),
    legend.box.background = element_rect(fill = "white", color = NA),
    legend.box.margin = margin(0, 0, 0, 0)
  )

# Create fourth row with the cleaned plots
fourth_row <- plot_grid(
  p.adcp.cosa_clean, p.adcp.entero_clean,  
  ncol = 2,
  rel_widths = c(1, 1),
  labels = c("E.", "F."),
  label_size = 16,
  label_fontface = "bold",
  align = "h",
  axis = "tb"
)
# Combine all rows including the legend row
SF6_final_figure <- plot_grid(
  first_row,
  second_row,
  third_row,
  fourth_row,
  ncol = 1,
  rel_heights = c(1, 1, 1, 1)
)

# Save the final figure
ggsave("figures/Supplemental_figure_6.tiff", 
       SF6_final_figure, 
       width = 14, height = 15,  # Adjust height as needed
       dpi = 300, 
       compression = "lzw")

```


# Supplemental Fig 6 - table
```{r Supplemental-Fig-6-table}
# Create Table
OTU_ADCP <- read_csv("./data/RWUS_ADCP_OTU_DESeqTable_HM_fin.csv")
glimpse(OTU_ADCP)

# Convert into table
# Convert OTU_ID to ASV_ID: ADCP
OTU_ADCP_tmp <- OTU_ADCP %>%
  select(OTU_ID, OTU) %>%
  distinct() # Remove duplicates

df <- OTU_ADCP %>%
    select(-OTU, -significant, -`E value`) %>%
    pivot_longer(cols = starts_with("ADCP"),
                 names_to = "Assay",
                 values_to = "Response") 

df_with_seq <- df %>%
  left_join(OTU_ADCP_tmp, by = "OTU_ID", relationship = "many-to-many") %>%
  left_join(asv_mapping, by = c("OTU" = "ASV")) %>%
  mutate(OTU_ID = OTU_ID.y) %>%  # Replace with ASV_ID
  select(-OTU, -OTU_ID.y, -OTU_ID.x) %>%
  select(OTU_ID, everything())

# Elispot assays Supplemental 5B -> table
OTU_POT<- read_csv("./data/RWUS_POT_OTU_DESseqTable_HM_fin.csv")
glimpse(OTU_POT)

df.POT <- OTU_POT %>%
    select(-OTU, -significant, `E value`) %>%
    pivot_longer(cols = starts_with("POT"),
                 names_to = "Assay",
                 values_to = "Response") 

# Create a named vector for mapping old values to new values
POT.replacement_values <- c(
  "POT_EM1" = "Env Mos 1",
  "POT_EM2" = "Env Mos 2",
  "POT_GM1" = "Gag Mos 1", 
  "POT_GM2" = "Gag Mos 2",
  "POT_PM1" = "Pol Mos 1",
  "POT_PM2" = "Pol Mos 2",
  "POT_E1P" = "Env1 PTE",
  "POT_E2P" = "Env2 PTE",
  "POT_E3P" = "Env3 PTE",
  "POT_GP" = "Gag PTE",
  "POT_PP" = "Pol PTE"
)

# Replace values in the Assay column
df.POT$Assay <- POT.replacement_values[df.POT$Assay]

df.POT$Assay <- factor(df.POT$Assay,      # Reordering group factor levels
                         levels = c("Env Mos 1", "Env Mos 2", "Gag Mos 1", "Gag Mos 2", "Pol Mos 1", "Pol Mos 2", "Env1 PTE", "Env2 PTE", "Env3 PTE", "Gag PTE", "Pol PTE"))

# Convert OTU_ID to ASV_ID: POT
df.POT_tmp <- OTU_POT %>%
  select(OTU_ID, OTU) %>%
  distinct() # Remove duplicates

df.POT_with_seq <- df.POT %>%
  left_join(df.POT_tmp, by = "OTU_ID", relationship = "many-to-many") %>%
  left_join(asv_mapping, by = c("OTU" = "ASV")) %>%
  mutate(OTU_ID = OTU_ID.y) %>%  # Replace with ASV_ID
  select(-OTU, -OTU_ID.y, -OTU_ID.x) %>%
  select(OTU_ID, everything())

# Combine with df_with_seq to make table 
s6_table <- bind_rows(df_with_seq, df.POT_with_seq)

# Write table for publication
write.csv(s6_table, "./figures/Supplemental_table_6.csv", row.names = TRUE)

```

# Supplemental Figure 7 LEfSe analysis for microbiome biomarker discovery
```{r, lefse-function}
  # Load the functions
  source("./data/lefse_min_functions.R")

# Rwanda vs US
  # Run LEfSe analysis
  lefse_results_RWUS <- run_lefse_analysis(
    ps = ps1_V9_RWUS,
    group_var = "sub_region",
    taxa_rank = "Genus",
    kw_cutoff = 0.05,
    wilcoxon_cutoff = 0.05,
    lda_cutoff = 2.0
  )

  # Extract significant taxa
  sig_taxa_RWUS <- extract_significant_taxa(
    lefse_results = lefse_results_RWUS,
    lda_cutoff = 2.0,
    output_file = "./table/RWUS_significant_lefse_taxa.csv"
  )

  # Create the plot and store in variable
  lefse_plot_RWUS <- create_lefse_plot(
    lefse_results = lefse_results_RWUS,
    ps = ps1_V9_RWUS,
    group_var = "sub_region",
    output_file = "./figures/RWUS_lefse_plot",  # .tiff will be added automatically
    variable_name = "RWUS",
    save_as_tiff = TRUE,  # This enables TIFF saving
    dpi = 300,            # Resolution (standard for publication)
    compression = "lzw"   # LZW compression (good balance of size/quality)
  )

  # Optionally, extract abundance data
  abundance_data_RWUS <- extract_abundance_data(
    lefse_results = lefse_results_RWUS,
    ps = ps1_V9_RWUS,
    group_var = "sub_region",
    output_file = "./table/RWUS_abundance_data.csv"
  )

  # Rwanda vs Uganda
  # Run LEfSe analysis
  lefse_results_RWUG <- run_lefse_analysis(
    ps = ps1_V9_RWUG,
    group_var = "sub_region",
    taxa_rank = "Genus",
    kw_cutoff = 0.05,
    wilcoxon_cutoff = 0.05,
    lda_cutoff = 2.0
  )

  # Extract significant taxa
  sig_taxa_RWUG <- extract_significant_taxa(
    lefse_results = lefse_results_RWUG,
    lda_cutoff = 2.0,
    output_file = "./table/RWUG_significant_lefse_taxa.csv"
  )

  # Create the plot and store in variable
  lefse_plot_RWUG <- create_lefse_plot(
    lefse_results = lefse_results_RWUG,
    ps = ps1_V9_RWUG,
    group_var = "sub_region",
    output_file = "./figures/RWUG_lefse_plot",  # .tiff will be added automatically
    variable_name = "RWUG",
    save_as_tiff = TRUE,  # This enables TIFF saving
    dpi = 300,            # Resolution (standard for publication)
    compression = "lzw"   # LZW compression (good balance of size/quality)
  )

  # Optionally, extract abundance data
  abundance_data_RWUG <- extract_abundance_data(
    lefse_results = lefse_results_RWUG,
    ps = ps1_V9_RWUG,
    group_var = "sub_region",
    output_file = "./table/RWUG_abundance_data.csv"
  )

  # US vs Ugunda
  # Run LEfSe analysis
  lefse_results_USUG <- run_lefse_analysis(
    ps = ps1_V9_USUG,
    group_var = "sub_region",
    taxa_rank = "Genus",
    kw_cutoff = 0.05,
    wilcoxon_cutoff = 0.05,
    lda_cutoff = 2.0
  )

  # Extract significant taxa
  sig_taxa_USUG <- extract_significant_taxa(
    lefse_results = lefse_results_USUG,
    lda_cutoff = 2.0,
    output_file = "./table/USUG_significant_lefse_taxa.csv"
  )

  # Create the plot and store in variable
  lefse_plot_USUG <- create_lefse_plot(
    lefse_results = lefse_results_USUG,
    ps = ps1_V9_USUG,
    group_var = "sub_region",
    output_file = "./figures/USUG_lefse_plot",  # .tiff will be added automatically
    variable_name = "USUG",
    save_as_tiff = TRUE,  # This enables TIFF saving
    dpi = 300,            # Resolution (standard for publication)
    compression = "lzw"   # LZW compression (good balance of size/quality)
  )

  # Optionally, extract abundance data
  abundance_data_USUG <- extract_abundance_data(
    lefse_results = lefse_results_USUG,
    ps = ps1_V9_USUG,
    group_var = "sub_region",
    output_file = "./table/USUG_abundance_data.csv"
  )
 
```

# Final Supplemental Figure 7
```{r Supplemental-Figure-7}
  # Make a combined figure for publication
  # Add panel labels to each plot
  lefse_plot_A <- lefse_plot_RWUS +
    labs(title = "A.") +
    theme(plot.title = element_text(face = "bold", hjust = 0))

  lefse_plot_B <- lefse_plot_USUG +
    labs(title = "B.") +
    theme(plot.title = element_text(face = "bold", hjust = 0))

  lefse_plot_C <- lefse_plot_RWUG +
    labs(title = "C.") +
    theme(plot.title = element_text(face = "bold", hjust = 0))

  # Combine plots into a single figure (vertical arrangement)
  #lefse_combined_figure <- lefse_plot_A / lefse_plot_B / lefse_plot_C

  # If you want a horizontal arrangement instead, use:
   lefse_combined_figure <- lefse_plot_A + lefse_plot_B + lefse_plot_C

  # Add a common legend (optional)
  lefse_combined_figure <- lefse_combined_figure +
    plot_layout(guides = "collect") &
    theme(legend.position = "bottom")

  # Save as compressed TIFF
  ggsave("./figures/Supplemental_Figure_7.tiff",
         lefse_combined_figure,
         width = 15,
         height = 15,  # Adjust for vertical layout
         dpi = 300,
         device = "tiff",
         compression = "lzw") 
  
```
